{% extends "_base.html" %}
{% block title %}é…ç½®ä¿¡æ¯æº - IntelliScraper{% endblock %}

{% block content %}
<style>
/* åŸºç¡€æ ·å¼ */
.picker-btn-group { gap: 4px; }
.picker-btn {
    padding: 4px 8px;
    font-size: 12px;
    border-radius: 4px;
}
.selector-input-group {
    display: flex;
    gap: 8px;
    align-items: center;
}
.selector-input-group input { flex: 1; }

/* é€‰æ‹©å™¨æç¤º */
.selector-hint {
    font-size: 11px;
    color: #6c757d;
    margin-top: 2px;
}

/* é¢„è§ˆé«˜äº®æ ·å¼ */
.__picker_hover__ {
    outline: 3px solid #0d6efd !important;
    background: rgba(13,110,253,0.2) !important;
}
.__picker_selected__ {
    outline: 4px solid #dc3545 !important;
    background: rgba(220,53,69,0.2) !important;
}
.__picker_container__ {
    outline: 3px solid #198754 !important;
    background: rgba(25,135,84,0.15) !important;
}
.__picker_excluded__ {
    outline: 2px dashed #ffc107 !important;
    opacity: 0.5 !important;
}

/* æ¨¡æ€æ¡†æ ·å¼ */
.picker-modal .modal-body {
    height: 70vh;
    padding: 0;
}
.picker-controls {
    position: sticky;
    top: 0;
    background: white;
    border-bottom: 1px solid #dee2e6;
    padding: 15px;
    z-index: 10;
}
.preview-container {
    height: calc(100% - 120px);
    overflow: hidden;
}

/* å†…å®¹é¢„è§ˆåŒºåŸŸ */
.content-preview {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 10px;
    margin-top: 10px;
    max-height: 200px;
    overflow-y: auto;
}

.preview-item {
    border-bottom: 1px solid #e9ecef;
    padding: 8px 0;
}

.preview-item:last-child {
    border-bottom: none;
}

/* å®¹å™¨åˆ†æå™¨æ ·å¼ */
.container-analyzer {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
}

.element-item {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 10px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s;
}

.element-item:hover {
    border-color: #0d6efd;
    background: #f8f9fa;
}

.element-item.selected-title {
    border-color: #dc3545;
    background: #fff5f5;
}

.element-item.selected-link {
    border-color: #198754;
    background: #f0fff4;
}

.element-item.selected-date {
    border-color: #ffc107;
    background: #fffbf0;
}

.element-item.selected-multiple {
    border: 2px solid #6f42c1;
    background: linear-gradient(45deg, #fff5f5 50%, #f0fff4 50%);
}

.element-preview {
    font-family: monospace;
    font-size: 12px;
    color: #666;
    margin-top: 5px;
    padding: 5px;
    background: #f8f9fa;
    border-radius: 3px;
}

/* é«˜çº§é€‰é¡¹å¡ç‰‡ */
.advanced-card {
    border-left: 3px solid #0d6efd;
}

/* åçˆ¬è™«æç¤º */
.antibot-warning {
    background: #fff3cd;
    border: 1px solid #ffc107;
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 10px;
}

/* åŠ è½½ç­–ç•¥æŒ‡ç¤ºå™¨ */
.load-strategy-indicator {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    z-index: 1000;
}

/* å¤šé‡é€‰æ‹©æ ‡ç­¾ */
.multi-select-badges {
    margin-top: 5px;
}

.multi-select-badges .badge {
    margin-right: 5px;
    margin-bottom: 2px;
}
</style>

<div class="row g-3">
  <div class="col-lg-5">
    <!-- ä¸»é…ç½®è¡¨å• -->
    <div class="card">
      <div class="card-body">
        <h5 class="card-title mb-3">é…ç½®è¡¨å•</h5>

        <form id="recipeForm">
          {% if source %}
            <input type="hidden" name="source_id" value="{{ source.id }}">
          {% endif %}

          <div class="mb-3">
            <label class="form-label">åŸŸå</label>
            <input class="form-control" name="domain" value="{{ domain }}" readonly>
          </div>

          <div class="mb-3">
            <label class="form-label">èµ·å§‹URLï¼ˆåˆ—è¡¨é¡µï¼‰</label>
            <input type="url" class="form-control" id="startUrl" name="start_url"
                   value="{{ (recipe.start_url if recipe else url) or ('https://' ~ domain ~ '/') }}">
          </div>

          <!-- åˆ—è¡¨å®¹å™¨é€‰æ‹©å™¨ -->
          <div class="mb-3">
            <label class="form-label">åˆ—è¡¨å®¹å™¨ï¼ˆlist_selectorï¼‰</label>
            <div class="selector-input-group">
              <input class="form-control" name="list_selector" id="listSelector"
                     value="{{ recipe.list_selector if recipe }}">
              <div class="btn-group picker-btn-group">
                <button type="button" class="btn btn-primary picker-btn"
                        onclick="openPickerModal('list', 'ç›´æ¥')" title="ç›´æ¥ç‚¹å‡»é€‰æ‹©">
                  â˜ï¸
                </button>
                <button type="button" class="btn btn-outline-info picker-btn"
                        onclick="openPickerModal('list', 'å®¹å™¨åˆ†æ')" title="å®¹å™¨åˆ†ææ¨¡å¼">
                  ğŸ“¦
                </button>
                <button type="button" class="btn btn-outline-secondary picker-btn"
                        onclick="checkSelector('list')" title="æ£€æŸ¥">
                  ğŸ”
                </button>
              </div>
            </div>
            <div class="selector-hint">æ¨èä½¿ç”¨ğŸ“¦å®¹å™¨åˆ†æå¯ä¸€æ¬¡æ€§é…ç½®æ‰€æœ‰å­—æ®µã€‚</div>
          </div>

          <!-- æ ‡é¢˜é€‰æ‹©å™¨ - å¢å¼ºç‰ˆ -->
          <div class="mb-3">
            <label class="form-label">æ ‡é¢˜é€‰æ‹©å™¨ï¼ˆtitle_selectorï¼‰</label>
            <div class="selector-input-group">
              <input class="form-control" name="title_selector" id="titleSelector"
                     value="{{ recipe.title_selector if recipe }}">
              <div class="btn-group picker-btn-group">
                <button type="button" class="btn btn-primary picker-btn"
                        onclick="openPickerModal('title', 'ç›´æ¥')" title="ç‚¹å‡»é€‰æ‹©">
                  â˜ï¸
                </button>
                <button type="button" class="btn btn-outline-secondary picker-btn"
                        onclick="checkSelector('title')">ğŸ”</button>
              </div>
            </div>

            <!-- æ’é™¤å­å…ƒç´ é€‰é¡¹ -->
            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" id="titleExcludeSmall"
                     name="title_exclude_small" {% if recipe and recipe.title_exclude_small %}checked{% endif %}>
              <label class="form-check-label small" for="titleExcludeSmall">
                æ’é™¤ &lt;small&gt;, &lt;time&gt; ç­‰å­å…ƒç´ 
              </label>
            </div>
          </div>

          <!-- é“¾æ¥é€‰æ‹©å™¨ -->
          <div class="mb-3">
            <label class="form-label">é“¾æ¥é€‰æ‹©å™¨ï¼ˆlink_selectorï¼‰</label>
            <div class="selector-input-group">
              <input class="form-control" name="link_selector" id="linkSelector"
                     value="{{ recipe.link_selector if recipe }}">
              <div class="btn-group picker-btn-group">
                <button type="button" class="btn btn-primary picker-btn"
                        onclick="openPickerModal('link', 'ç›´æ¥')" title="ç‚¹å‡»é€‰æ‹©">
                  ğŸ”—
                </button>
                <button type="button" class="btn btn-outline-secondary picker-btn"
                        onclick="checkSelector('link')">ğŸ”</button>
              </div>
            </div>
          </div>

          <!-- æ—¥æœŸé€‰æ‹©å™¨ -->
          <div class="mb-3">
            <label class="form-label">æ—¥æœŸé€‰æ‹©å™¨ï¼ˆdate_selectorï¼Œç•™ç©ºè¡¨ç¤ºæ²¡æœ‰ï¼‰</label>
            <div class="selector-input-group">
              <input class="form-control" name="date_selector" id="dateSelector"
                     value="{{ recipe.date_selector if recipe }}">
              <div class="btn-group picker-btn-group">
                <button type="button" class="btn btn-primary picker-btn"
                        onclick="openPickerModal('date', 'ç›´æ¥')">â˜ï¸</button>
                <button type="button" class="btn btn-outline-secondary picker-btn"
                        onclick="checkSelector('date')">ğŸ”</button>
              </div>
            </div>
          </div>

          <!-- åˆ†é¡µç­–ç•¥é…ç½® - ç®€åŒ–ç‰ˆ -->
          <div class="card advanced-card mb-3">
            <div class="card-header bg-light">
              <h6 class="mb-0">åˆ†é¡µç­–ç•¥é…ç½®</h6>
            </div>
            <div class="card-body">
            <!-- åˆ†é¡µæ¨¡å¼é€‰æ‹© -->
            <div class="mb-3">
                <label class="form-label">åˆ†é¡µæ¨¡å¼</label>
                <select class="form-select" name="pagination_mode" id="paginationMode">
                  <option value="next" {% if not recipe or recipe.pagination_mode == 'next' %}selected{% endif %}>ä¸‹ä¸€é¡µé“¾æ¥ï¼ˆæ‰‹åŠ¨é€‰æ‹©ï¼‰</option>
                  <option value="loadmore" {% if recipe and recipe.pagination_mode == 'loadmore' %}selected{% endif %}>åŠ è½½æ›´å¤šæŒ‰é’®</option>
                  <option value="number" {% if recipe and recipe.pagination_mode == 'number' %}selected{% endif %}>æ•°å­—åˆ†é¡µæ¨¡å¼ï¼ˆæ¨èç”¨äºDrupalï¼‰</option>
                  <option value="none" {% if recipe and recipe.pagination_mode == 'none' %}selected{% endif %}>æ— åˆ†é¡µ</option>
                </select>
              </div>

              <!-- ä¸‹ä¸€é¡µé€‰æ‹©å™¨ -->
              <div id="nextPageConfig" class="pagination-config {% if recipe and recipe.pagination_mode != 'next' %}d-none{% endif %}">
                <label class="form-label">ä¸‹ä¸€é¡µé€‰æ‹©å™¨</label>
                <div class="selector-input-group">
                  <input class="form-control" id="nextPageSelector" name="next_page_selector"
                         value="{{ recipe.next_page_selector if recipe }}">
                  <button type="button" class="btn btn-primary picker-btn"
                          onclick="openPickerModal('next_page', 'æ‰‹åŠ¨é€‰æ‹©')">â˜ï¸</button>
                  <button type="button" class="btn btn-outline-info picker-btn"
                          onclick="testNextPageNavigation()" title="æµ‹è¯•ä¸‹ä¸€é¡µå¯¼èˆª">
                    ğŸ§ª
                  </button>
                  <button type="button" class="btn btn-outline-secondary picker-btn"
                          onclick="checkSelector('next_page')">ğŸ”</button>
                </div>
                <div class="form-text">æ‰‹åŠ¨ç‚¹å‡»"ä¸‹ä¸€é¡µ"æŒ‰é’®ï¼Œç³»ç»Ÿä¼šè¯†åˆ«è·³è½¬é€»è¾‘</div>

                <!-- ä¸‹ä¸€é¡µæµ‹è¯•ç»“æœ -->
                <div id="nextPageTestResult" class="mt-2" style="display: none;">
                  <div class="alert alert-info small">
                    <div id="nextPageUrl"></div>
                    <div id="nextPagePattern"></div>
                  </div>
                </div>
              </div>

              <!-- æ•°å­—åˆ†é¡µé…ç½®åŒºåŸŸ - ä¿®å¤ç‰ˆ -->
              <div id="numberPaginationConfig" class="pagination-config {% if not recipe or recipe.pagination_mode != 'number' %}d-none{% endif %}">
                  <label class="form-label">URLæ¨¡å¼</label>
                  <div class="input-group">
                      <input type="text" class="form-control" id="pagePattern" name="page_pattern"
                             value="{{ recipe.page_pattern if recipe and recipe.page_pattern else '' }}"
                             placeholder="https://example.com/events?type[]=event&page={n}">
                      <button type="button" class="btn btn-outline-info" onclick="testNumberPagination()" title="æµ‹è¯•æ•°å­—åˆ†é¡µ">
                          ğŸ§ª
                      </button>
                  </div>
                  <div class="form-text">
                      ä½¿ç”¨ <code>{n}</code> è¡¨ç¤ºé¡µç å ä½ç¬¦ã€‚<br>
                      <strong>æ³¨æ„ï¼š</strong>Drupalç³»ç»Ÿé¡µç ä»0å¼€å§‹ï¼ˆç¬¬1é¡µ=page=0ï¼Œç¬¬2é¡µ=page=1ï¼‰
                  </div>

                  <div class="mt-2">
                      <div class="form-check">
                          <input class="form-check-input" type="checkbox" id="drupalZeroBased" name="drupal_zero_based"
                                 {% if not recipe or recipe.drupal_zero_based %}checked{% endif %}>
                          <label class="form-check-label" for="drupalZeroBased">
                              Drupalé›¶åŸºé¡µç ï¼ˆæ¨èï¼‰
                          </label>
                      </div>
                      <div class="form-text small">
                          å‹¾é€‰æ­¤é¡¹ï¼šç¬¬1é¡µ=page=0ï¼Œç¬¬2é¡µ=page=1<br>
                          ä¸å‹¾é€‰ï¼šç¬¬1é¡µ=page=1ï¼Œç¬¬2é¡µ=page=2
                      </div>
                  </div>
              </div>

              <!-- åŠ è½½æ›´å¤šé…ç½® - ä¿®å¤ç‰ˆ -->
              <div id="loadMoreConfig" class="pagination-config {% if not recipe or recipe.pagination_mode != 'loadmore' %}d-none{% endif %}">
                  <label class="form-label">åŠ è½½æ›´å¤šæŒ‰é’®é€‰æ‹©å™¨</label>
                  <div class="selector-input-group">
                      <input class="form-control" id="loadMoreSelector" name="load_more_selector"
                             value="{{ recipe.load_more_selector if recipe }}">
                      <button type="button" class="btn btn-primary picker-btn"
                              onclick="openPickerModal('load_more', 'æ‰‹åŠ¨é€‰æ‹©')">â˜ï¸</button>
                      <button type="button" class="btn btn-outline-info picker-btn"
                              onclick="testLoadMoreButton()" title="æµ‹è¯•åŠ è½½æ›´å¤š">
                          ğŸ§ª
                      </button>
                      <button type="button" class="btn btn-outline-secondary picker-btn"
                              onclick="checkSelector('load_more')">ğŸ”</button>
                  </div>
                  <div class="form-text">æ‰‹åŠ¨ç‚¹å‡»"åŠ è½½æ›´å¤š"æˆ–"Load More"æŒ‰é’®</div>

                  <!-- åŠ è½½æ›´å¤šç‰¹æ®Šé…ç½® -->
                  <div class="mt-2">
                      <div class="form-check">
                          <input class="form-check-input" type="checkbox" id="loadMoreRequiresDynamic"
                                 name="load_more_requires_dynamic"
                                 {% if not recipe or recipe.load_more_requires_dynamic %}checked{% endif %}>
                          <label class="form-check-label" for="loadMoreRequiresDynamic">
                              è‡ªåŠ¨å¯ç”¨åŠ¨æ€æ¸²æŸ“ï¼ˆæ¨èï¼‰
                          </label>
                      </div>
                      <div class="form-text small">åŠ è½½æ›´å¤šé€šå¸¸éœ€è¦JavaScriptæ”¯æŒ</div>
                  </div>
              </div>

              <!-- æœ€å¤§é¡µæ•° -->
              <div class="mt-3">
                <label class="form-label">æœ€å¤§é¡µæ•°/ç‚¹å‡»æ¬¡æ•°</label>
                <input type="number" class="form-control" name="max_pages" min="1"
                       value="{{ recipe.max_pages if recipe else 3 }}">
                <div class="form-text small">å¯¹äºåŠ è½½æ›´å¤šæ¨¡å¼ï¼Œè¡¨ç¤ºæœ€å¤§ç‚¹å‡»æ¬¡æ•°</div>
              </div>
            </div>
          </div>

          <!-- åçˆ¬è™«å¯¹ç­– - å¢å¼ºç‰ˆ -->
          <div class="card advanced-card mb-3">
            <div class="card-header bg-light">
              <h6 class="mb-0">åçˆ¬è™«å¯¹ç­–</h6>
            </div>
            <div class="card-body">
              <!-- åŠ è½½ç­–ç•¥ -->
              <div class="row g-2">
                <div class="col-md-6">
                  <label class="form-label">åŠ è½½ç­–ç•¥</label>
                  <select class="form-select" name="load_strategy" onchange="updateLoadStrategyIndicator()">
                    <option value="static">é™æ€HTMLï¼ˆå¿«é€Ÿï¼‰</option>
                    <option value="dynamic">æµè§ˆå™¨æ¸²æŸ“ï¼ˆç»•è¿‡åçˆ¬ï¼‰</option>
                    <option value="stealth">éšèº«æ¨¡å¼ï¼ˆé«˜çº§åæ£€æµ‹ï¼‰</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">ç­‰å¾…æ¡ä»¶</label>
                  <select class="form-select" name="wait_until">
                    <option value="domcontentloaded">DOMåŠ è½½å®Œæˆ</option>
                    <option value="load">é¡µé¢å®Œå…¨åŠ è½½</option>
                    <option value="networkidle">ç½‘ç»œç©ºé—²</option>
                  </select>
                </div>
              </div>

              <!-- é¢å¤–ç­‰å¾… -->
              <div class="mt-2">
                <label class="form-label">é¢å¤–ç­‰å¾…ï¼ˆæ¯«ç§’ï¼‰</label>
                <input type="number" class="form-control" name="wait_ms"
                       value="{{ recipe.wait_ms if recipe else 1000 }}">
              </div>

              <!-- ä»£ç†è®¾ç½® -->
              <div class="form-check mt-2">
                <input class="form-check-input" type="checkbox" id="useProxy" name="use_proxy">
                <label class="form-check-label" for="useProxy">
                  ä½¿ç”¨ä»£ç†æœåŠ¡å™¨ï¼ˆè‡ªåŠ¨è½®æ¢ï¼‰
                </label>
              </div>

              <!-- User-Agentè½®æ¢ -->
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="rotateUA" name="rotate_ua" checked>
                <label class="form-check-label" for="rotateUA">
                  éšæœºUser-Agent
                </label>
              </div>

              <!-- Cookieå¤„ç† -->
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="acceptCookies" name="accept_cookies">
                <label class="form-check-label" for="acceptCookies">
                  è‡ªåŠ¨æ¥å—Cookieæç¤º
                </label>
              </div>
            </div>
          </div>

          <!-- æ‰€å±è®®é¢˜ -->
          <div class="mb-3">
            <label class="form-label">æ‰€å±è®®é¢˜ï¼ˆå¯å¤šé€‰ï¼‰</label>
            <select name="topic_ids" class="form-select" multiple size="5">
                {% set assigned_topic_ids = source.topics|map(attribute='id')|list if source else [] %}
                {% for topic in all_topics %}
                    <option value="{{ topic.id }}" {% if topic.id in assigned_topic_ids %}selected{% endif %}>
                        {{ topic.name }}
                    </option>
                {% endfor %}
            </select>
          </div>

          <!-- æ“ä½œæŒ‰é’® -->
          <div class="d-flex align-items-center gap-2 mt-3">
            <div class="input-group" style="max-width: 200px;">
              <span class="input-group-text">æµ‹è¯•æ•°</span>
              <input id="testLimit" type="number" class="form-control" value="20" min="1">
            </div>

            <button type="button" class="btn btn-success" onclick="testConfiguration()">
              <span>æµ‹è¯•</span>
              <span id="testSpinner" class="spinner-border spinner-border-sm ms-2 d-none"></span>
            </button>

            <button type="button" class="btn btn-primary ms-auto" onclick="saveConfiguration()">
              <span>ä¿å­˜</span>
              <span id="saveSpinner" class="spinner-border spinner-border-sm ms-2 d-none"></span>
            </button>
          </div>
        </form>

        <div id="saveFeedback" class="mt-3"></div>
      </div>
    </div>
  </div>

  <div class="col-lg-7">
    <!-- é¢„è§ˆçª—å£ - å¢å¼ºç‰ˆ -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">é¡µé¢é¢„è§ˆ</h6>
          <div>
            <button class="btn btn-sm btn-outline-warning me-2" onclick="detectAntibot()">
              æ£€æµ‹åçˆ¬
            </button>
            <button class="btn btn-sm btn-outline-secondary me-2" onclick="switchLoadStrategy()">
              åˆ‡æ¢åŠ è½½æ¨¡å¼
            </button>
            <button class="btn btn-sm btn-outline-secondary me-2" id="maximizePreview">
              æ”¾å¤§é¢„è§ˆ
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="reloadPreview">
              åˆ·æ–°é¢„è§ˆ
            </button>
          </div>
        </div>

        <!-- åçˆ¬è™«è­¦å‘Š -->
        <div id="antibotWarning" class="antibot-warning d-none">
          <i class="bi bi-exclamation-triangle"></i>
          <strong>æ£€æµ‹åˆ°åçˆ¬è™«æœºåˆ¶</strong>
          <p class="mb-0 small">å»ºè®®åˆ‡æ¢åˆ°"æµè§ˆå™¨æ¸²æŸ“"æˆ–"éšèº«æ¨¡å¼"åŠ è½½ç­–ç•¥ã€‚</p>
        </div>

        <div class="position-relative">
          <div id="loadStrategyIndicator" class="load-strategy-indicator">é™æ€HTML</div>
          <div class="ratio ratio-16x9">
            <iframe id="previewFrame" src="/proxy?url={{ (recipe.start_url if recipe else url) | urlencode }}"
                    style="width:100%;height:100%;border:0;"></iframe>
          </div>
        </div>
        <div class="form-text mt-2">
          ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åœ¨å¼¹çª—ä¸­è¿›è¡Œç²¾å‡†å…ƒç´ å®šä½ï¼Œä¸ä¼šå½±å“å½“å‰é¢„è§ˆã€‚
        </div>
      </div>
    </div>

    <!-- æµ‹è¯•ç»“æœ - å¢å¼ºç‰ˆ -->
    <div class="card">
      <div class="card-body">
        <h6 class="card-title">æµ‹è¯•ç»“æœ</h6>
        <div id="testResult" class="small text-muted">ç‚¹å‡»"æµ‹è¯•"æŒ‰é’®æŸ¥çœ‹ç»“æœã€‚</div>
      </div>
    </div>
  </div>
</div>

<!-- æ™ºèƒ½é€‰æ‹©å™¨å¼¹çª— - æ”¹è¿›ç‰ˆ -->
<div class="modal fade picker-modal" id="pickerModal" tabindex="-1" data-bs-backdrop="static">
  <div class="modal-dialog modal-xl modal-fullscreen-lg-down">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="pickerModalTitle">å…ƒç´ é€‰æ‹©å™¨</h5>
        <button type="button" class="btn-close" onclick="closePicker()"></button>
      </div>
      <div class="modal-body">
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="picker-controls">
          <div class="d-flex justify-content-between align-items-center">
            <div id="pickerInstructions" class="text-muted">
              è¯·ç­‰å¾…é¡µé¢åŠ è½½...
            </div>
            <div class="btn-group">
              <button type="button" class="btn btn-sm btn-success" id="confirmPicker" disabled>
                âœ… ç¡®è®¤ä½¿ç”¨
              </button>
              <button type="button" class="btn btn-sm btn-secondary" onclick="closePicker()">
                âŒ å–æ¶ˆ
              </button>
            </div>
          </div>
          <div id="currentSelectorDisplay" class="mt-2">
            <small class="text-muted">å½“å‰é€‰æ‹©å™¨ï¼š</small>
            <code id="selectorValue" class="ms-2">æœªé€‰æ‹©</code>
          </div>

          <!-- å†…å®¹é¢„è§ˆåŒºåŸŸ -->
          <div id="contentPreview" class="content-preview d-none">
            <h6>æå–å†…å®¹é¢„è§ˆ</h6>
            <div id="previewItems"></div>
          </div>
        </div>

        <!-- é¢„è§ˆå®¹å™¨ -->
        <div class="preview-container">
          <iframe id="pickerFrame" style="width:100%;height:100%;border:0;"></iframe>
        </div>

        <!-- çŠ¶æ€æç¤º -->
        <div id="statusBanner" class="alert alert-info position-fixed top-50 start-50 translate-middle d-none"
             style="z-index: 10000; max-width: 400px;">
          <div id="statusMessage"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- å®¹å™¨åˆ†æå¼¹çª— - æ”¹è¿›ç‰ˆ -->
<div class="modal fade" id="containerAnalysisModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">å®¹å™¨å…ƒç´ åˆ†æ</h5>
        <button type="button" class="btn-close" onclick="closeContainerAnalysis()"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted">é€‰æ‹©çš„å®¹å™¨åŒ…å«ä»¥ä¸‹å­å…ƒç´ ï¼Œè¯·æŒ‡å®šå“ªäº›æ˜¯æ ‡é¢˜ã€é“¾æ¥å’Œæ—¥æœŸã€‚<strong>æ”¯æŒä¸€ä¸ªå…ƒç´ åŒæ—¶ä½œä¸ºå¤šç§ç±»å‹ï¼š</strong></p>
        <div id="containerElements"></div>
        <div class="mt-3">
          <label class="form-label">é€‰æ‹©çš„é…ç½®ï¼š</label>
          <div id="selectedConfigs" class="small text-muted">å°šæœªé€‰æ‹©...</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeContainerAnalysis()">å–æ¶ˆ</button>
        <button type="button" class="btn btn-primary" onclick="applyContainerAnalysis()" id="applyContainerBtn" disabled>
          åº”ç”¨é…ç½®
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// ==================== å…¨å±€çŠ¶æ€ç®¡ç† ====================
const appState = {
    currentField: null,
    currentMode: null,
    pickerActive: false,
    selectedElements: [],
    step: 0,
    containerAnalysis: {
        container: null,
        elements: [],
        selected: {
            title: new Set(),
            link: new Set(),
            date: new Set()
        }
    }
};

// ==================== åˆå§‹åŒ– ====================
document.addEventListener('DOMContentLoaded', function() {
    // ===== åŸæœ‰çš„åˆå§‹åŒ–ä»£ç  =====
    initializeEventListeners();
    checkForAntibot();
    updateLoadStrategyIndicator();
    // ===== ä¿®å¤ï¼šæ­£ç¡®åˆå§‹åŒ–åˆ†é¡µæ¨¡å¼ =====
    initializePaginationModeFixed();
    // ===== æ–°å¢ï¼šDrupalåˆ†é¡µæ”¯æŒåˆå§‹åŒ– =====
    ensureNumberPaginationOption();

    // ===== æ–°å¢ï¼šå¦‚æœURLä¸­åŒ…å«Drupalç›¸å…³å‚æ•°ï¼Œè‡ªåŠ¨å»ºè®®æ•°å­—åˆ†é¡µæ¨¡å¼ =====
    const startUrl = document.getElementById('startUrl').value.trim();
    if (startUrl && isDrupalLikeUrl(startUrl)) {
        showNotification('æ£€æµ‹åˆ°å¯èƒ½çš„Drupalç½‘ç«™ï¼Œå»ºè®®ä½¿ç”¨æ•°å­—åˆ†é¡µæ¨¡å¼', 'info');
    }
});

function initializePaginationModeFixed() {
    // å…ˆç¡®ä¿æ•°å­—åˆ†é¡µé…ç½®åŒºåŸŸå­˜åœ¨
    ensureNumberPaginationConfig();

    // è·å–å½“å‰é€‰ä¸­çš„åˆ†é¡µæ¨¡å¼
    const mode = document.getElementById('paginationMode').value;
    console.log('åˆå§‹åŒ–åˆ†é¡µæ¨¡å¼:', mode);

    // æ ¹æ®å½“å‰æ¨¡å¼æ˜¾ç¤ºå¯¹åº”çš„é…ç½®åŒºåŸŸ
    switchPaginationMode();

    // å¦‚æœæ˜¯æ•°å­—åˆ†é¡µæ¨¡å¼ï¼Œç¡®ä¿é…ç½®æ­£ç¡®æ˜¾ç¤º
    if (mode === 'number') {
        const numberConfig = document.getElementById('numberPaginationConfig');
        if (numberConfig) {
            numberConfig.classList.remove('d-none');
        }
    }
}

function ensureNumberPaginationConfig() {
    let numberConfig = document.getElementById('numberPaginationConfig');
    if (!numberConfig) {
        createNumberPaginationConfig();
    }
}


function initializeEventListeners() {
    // é‡è½½é¢„è§ˆ
    document.getElementById('reloadPreview').addEventListener('click', reloadPreview);

    // åˆ†é¡µæ¨¡å¼åˆ‡æ¢
    document.getElementById('paginationMode').addEventListener('change', switchPaginationMode);

    // æ”¾å¤§é¢„è§ˆ
    const previewModal = new bootstrap.Modal(document.getElementById('previewModal') || createPreviewModal());
    document.getElementById('maximizePreview').addEventListener('click', () => {
        const iframe = document.getElementById('previewFrame');
        const modalBody = document.querySelector('#previewModal .modal-body');
        modalBody.appendChild(iframe);
        previewModal.show();
    });
}

// ==================== é€‰æ‹©å™¨å¼¹çª—åŠŸèƒ½ - æ”¹è¿›ç‰ˆ ====================
function openPickerModal(field, mode) {
    appState.currentField = field;
    appState.currentMode = mode;
    appState.pickerActive = false;
    appState.selectedElements = [];
    appState.step = 0;

    const modeMap = {
        'ç›´æ¥': 'ç›´æ¥ç‚¹å‡»é€‰æ‹©',
        'å®¹å™¨åˆ†æ': 'å®¹å™¨å…ƒç´ åˆ†æ',
        'æ‰‹åŠ¨é€‰æ‹©': 'æ‰‹åŠ¨é€‰æ‹©ä¸‹ä¸€é¡µ'
    };

    const fieldMap = {
        'list': 'åˆ—è¡¨å®¹å™¨',
        'title': 'æ ‡é¢˜é€‰æ‹©å™¨',
        'link': 'é“¾æ¥é€‰æ‹©å™¨',
        'date': 'æ—¥æœŸé€‰æ‹©å™¨',
        'next_page': 'ä¸‹ä¸€é¡µé€‰æ‹©å™¨'
    };

    document.getElementById('pickerModalTitle').textContent =
        `${modeMap[mode] || mode} - ${fieldMap[field]}`;

    const startUrl = document.getElementById('startUrl').value.trim();
    const pickerFrame = document.getElementById('pickerFrame');

    // æ ¹æ®åŠ è½½ç­–ç•¥é€‰æ‹©ä¸åŒçš„ä»£ç†æ–¹å¼
    const loadStrategy = document.querySelector('[name="load_strategy"]').value;
    const proxyUrl = loadStrategy === 'dynamic' ?
        `/proxy_dynamic?url=${encodeURIComponent(startUrl)}` :
        `/proxy?url=${encodeURIComponent(startUrl)}`;

    pickerFrame.src = proxyUrl;

    showStatus('é¡µé¢åŠ è½½ä¸­...', 'info');
    document.getElementById('confirmPicker').disabled = true;
    document.getElementById('selectorValue').textContent = 'æœªé€‰æ‹©';

    // éšè—å†…å®¹é¢„è§ˆ
    document.getElementById('contentPreview').classList.add('d-none');

    pickerFrame.onload = function() {
        setTimeout(() => initPickerMode(), 500);
    };

    new bootstrap.Modal(document.getElementById('pickerModal')).show();
}

function initPickerMode() {
    const doc = getIframeDoc('pickerFrame');
    if (!doc) {
        showStatus('é¡µé¢åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥URLæˆ–åˆ‡æ¢åŠ è½½ç­–ç•¥', 'danger');
        return;
    }

    ensureHighlightCSS(doc);

    // æ ¹æ®æ¨¡å¼åˆå§‹åŒ–ä¸åŒçš„äº‹ä»¶å¤„ç†
    if (appState.currentMode === 'å®¹å™¨åˆ†æ') {
        initContainerAnalysisMode(doc);
    } else if (appState.currentField === 'next_page') {
        initNextPageMode(doc);
    } else {
        initDirectMode(doc);
    }

    appState.pickerActive = true;
}

// ==================== ä¸‹ä¸€é¡µæ‰‹åŠ¨é€‰æ‹©æ¨¡å¼ - æ–°å¢ ====================
function initNextPageMode(doc) {
    showStatus('ç‚¹å‡»é¡µé¢ä¸­çš„"ä¸‹ä¸€é¡µ"ã€">"ã€"Â»"ç­‰å¯¼èˆªå…ƒç´ ï¼Œç³»ç»Ÿä¼šåˆ†æè·³è½¬é€»è¾‘', 'info');

    doc.addEventListener('mousemove', handleNextPageHover);
    doc.addEventListener('click', handleNextPageClick, true);
}

function handleNextPageHover(e) {
    if (!appState.pickerActive) return;

    clearHighlights(getIframeDoc('pickerFrame'));
    const target = e.target;

    // æ£€æŸ¥æ˜¯å¦å¯èƒ½æ˜¯ä¸‹ä¸€é¡µå…ƒç´ 
    const isPossibleNextPage = checkIfPossibleNextPage(target);

    if (isPossibleNextPage) {
        highlightElement(target, '__picker_selected__');

        // ä¼˜åŒ–æ–‡æœ¬æ˜¾ç¤º - é™åˆ¶é•¿åº¦å¹¶æ¸…ç†
        const text = target.textContent.trim();
        const displayText = text.length > 50 ? text.substring(0, 50) + '...' : text;
        const href = target.getAttribute('href') || target.closest('a')?.getAttribute('href');

        updateStatus(`å€™é€‰ä¸‹ä¸€é¡µå…ƒç´ : "${displayText}" ${href ? `â†’ ${href}` : ''}`, 'info');
    } else {
        highlightElement(target);
        // å¯¹äºéä¸‹ä¸€é¡µå…ƒç´ ï¼Œæ˜¾ç¤ºç®€çŸ­æç¤º
        const text = target.textContent.trim();
        const shortText = text.length > 20 ? text.substring(0, 20) + '...' : text;
        updateStatus(`å½“å‰å…ƒç´ : "${shortText}" (ä¸æ˜¯ä¸‹ä¸€é¡µé“¾æ¥)`, 'muted');
    }
}


function handleNextPageClick(e) {
    if (!appState.pickerActive) return;
    e.preventDefault();
    e.stopPropagation();

    const element = e.target;

    // ===== æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦æ˜¯Drupalåˆ†é¡µå…ƒç´  =====
    if (element.hasAttribute('data-options')) {
        analyzeDrupalPagination(element);
        return;
    }

    // ===== åŸæœ‰çš„ä¸‹ä¸€é¡µå¤„ç†é€»è¾‘ =====
    let href = null;
    let navigationType = 'unknown';

    // 1. æ ‡å‡†é“¾æ¥
    if (element.tagName === 'a' && element.href) {
        href = element.href;
        navigationType = 'standard_link';
    }
    // 2. çˆ¶çº§é“¾æ¥
    else if (element.closest('a')) {
        const linkElement = element.closest('a');
        href = linkElement.href;
        navigationType = 'parent_link';
    }
    // 3. data-hrefå±æ€§
    else if (element.hasAttribute('data-href')) {
        href = element.getAttribute('data-href');
        navigationType = 'data_href';
    }
    // 4. ===== æ–°å¢ï¼šDrupalåˆ†é¡µç³»ç»Ÿæ£€æµ‹ =====
    else if (element.hasAttribute('data-options')) {
        try {
            const options = JSON.parse(element.getAttribute('data-options'));
            if (options.query && options.query.page) {
                const currentUrl = new URL(window.location.href);
                currentUrl.searchParams.set('page', options.query.page);
                href = currentUrl.toString();
                navigationType = 'drupal_pagination';
            }
        } catch (e) {
            console.warn('æ— æ³•è§£æDrupalåˆ†é¡µæ•°æ®:', e);
        }
    }
    // 5. é€šè¿‡onclickå±æ€§åˆ†æ
    else if (element.hasAttribute('onclick')) {
        const onclickValue = element.getAttribute('onclick');
        const urlMatch = onclickValue.match(/(?:location\.href|window\.location)\s*=\s*['"]([^'"]+)['"]/);
        if (urlMatch) {
            href = urlMatch[1];
            navigationType = 'onclick_redirect';
        }
    }
    // 6. åŸºäºå½“å‰URLæ¨æµ‹ï¼ˆé€‚ç”¨äºæ•°å­—åˆ†é¡µï¼‰
    else if (element.textContent.trim().match(/^\d+$/)) {
        const pageNumber = element.textContent.trim();
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('page', pageNumber);
        href = currentUrl.toString();
        navigationType = 'number_pagination';
    }

    if (!href) {
        // å¦‚æœæ— æ³•è·å–URLï¼Œä½†å…ƒç´ çœ‹èµ·æ¥æ˜¯å¯ç‚¹å‡»çš„ï¼Œæ ‡è®°ä¸ºJavaScriptå¯¼èˆª
        if (checkIfPossibleNextPage(element)) {
            navigationType = 'javascript_navigation';
            href = window.location.href; // ä½¿ç”¨å½“å‰URLä½œä¸ºå ä½ç¬¦
            showStatus('âš ï¸ æ£€æµ‹åˆ°JavaScriptå¯¼èˆªï¼Œå¯èƒ½éœ€è¦åŠ¨æ€æ¸²æŸ“æ¨¡å¼', 'warning');
        } else {
            showStatus('âš ï¸ é€‰æ‹©çš„å…ƒç´ æ— æ³•ç¡®å®šå¯¼èˆªåœ°å€', 'warning');
            return;
        }
    }

    // åˆ†æå¯¼èˆªé€»è¾‘
    analyzeNextPageLogic(element, href, navigationType);
}

function checkIfPossibleNextPage(element) {
    const text = element.textContent.toLowerCase().trim();
    const classes = Array.from(element.classList).join(' ').toLowerCase();
    const tagName = element.tagName.toLowerCase();

    // ä¸‹ä¸€é¡µæ–‡æœ¬æ¨¡å¼ï¼ˆæ‰©å±•ç‰ˆæœ¬ï¼‰
    const nextPageTexts = [
        'next', 'more', 'ä¸‹ä¸€é¡µ', 'æ›´å¤š', '>', 'Â»', 'â€º', 'â†’',
        'continue', 'see more', 'load more', 'â€ºâ€º', 'Â»Â»',
        'siguiente', 'suivant', 'weiter', 'next page', 'page next'
    ];

    // ä¸‹ä¸€é¡µç±»åæ¨¡å¼
    const nextPageClasses = [
        'next', 'more', 'continue', 'forward', 'pagination-next',
        'pager-next', 'btn-next', 'load-more'
    ];

    // æ£€æŸ¥æ–‡æœ¬å†…å®¹ - ç²¾ç¡®åŒ¹é…è€Œä¸æ˜¯åŒ…å«åŒ¹é…
    const hasNextPageText = nextPageTexts.some(keyword => {
        // å¯¹äºå•å­—ç¬¦ï¼Œè¦æ±‚ç²¾ç¡®åŒ¹é…
        if (keyword.length <= 2) {
            return text === keyword;
        }
        // å¯¹äºå¤šå­—ç¬¦ï¼Œå…è®¸åŒ…å«åŒ¹é…
        return text.includes(keyword);
    });

    // æ£€æŸ¥ç±»å
    const hasNextPageClass = nextPageClasses.some(keyword =>
        classes.includes(keyword)
    );

    // æ‰©å±•çš„å…ƒç´ ç±»å‹æ£€æŸ¥ï¼ˆä¸åªæ˜¯é“¾æ¥ï¼‰
    const isClickableElement =
        tagName === 'a' ||
        tagName === 'button' ||
        tagName === 'span' ||
        tagName === 'div' ||
        element.closest('a') !== null ||
        element.hasAttribute('onclick') ||
        element.hasAttribute('data-href') ||
        element.hasAttribute('data-url') ||
        element.hasAttribute('data-page') ||
        classes.includes('clickable') ||
        classes.includes('link') ||
        classes.includes('btn');

    // ç‰¹æ®Šå¤„ç†ï¼šDrupalåˆ†é¡µç³»ç»Ÿ
    const isDrupalPagination =
        element.hasAttribute('data-route-name') ||
        element.hasAttribute('data-options') ||
        classes.includes('drupal-masked-element');

    // æ’é™¤æ˜æ˜¾ä¸æ˜¯ä¸‹ä¸€é¡µçš„å…ƒç´ 
    const isExcluded = [
        'previous', 'prev', 'back', 'ä¸Šä¸€é¡µ', 'è¿”å›', 'first', 'last',
        'home', 'search', 'login', 'register', 'contact'
    ].some(excluded => text.includes(excluded));

    return (hasNextPageText || hasNextPageClass || isDrupalPagination) &&
           isClickableElement &&
           !isExcluded &&
           text.length < 100; // æ’é™¤è¿‡é•¿çš„æ–‡æœ¬
}


function analyzeNextPageLogic(element, href, navigationType) {
    // è·å–çœŸå®çš„ç›®æ ‡URLï¼Œè€Œä¸æ˜¯ä»£ç†URL
    const startUrl = document.getElementById('startUrl').value.trim();
    let baseUrl = startUrl;

    // å¦‚æœhrefæ˜¯ç›¸å¯¹è·¯å¾„ï¼ŒåŸºäºstartUrlæ„å»ºå®Œæ•´URL
    let fullNextUrl = href;
    if (href && !href.startsWith('http')) {
        try {
            fullNextUrl = new URL(href, baseUrl).toString();
        } catch (e) {
            console.warn('URLæ„å»ºå¤±è´¥:', e);
            fullNextUrl = href;
        }
    }

    console.log('URL Pattern Analysis:');
    console.log('Base URL (start_url):', baseUrl);
    console.log('Next URL:', fullNextUrl);

    const selector = generateStableSelector(element.closest('a') || element);

    // æ ¹æ®å¯¼èˆªç±»å‹åˆ†æURLæ¨¡å¼
    let pattern = null;
    let detectedInfo = '';

    switch (navigationType) {
        case 'drupal_pagination':
            pattern = analyzeUrlPattern(baseUrl, fullNextUrl);
            detectedInfo = 'Drupalåˆ†é¡µç³»ç»Ÿ';
            break;

        case 'javascript_navigation':
            detectedInfo = 'JavaScriptå¯¼èˆªï¼ˆéœ€è¦åŠ¨æ€æ¸²æŸ“ï¼‰';
            suggestDynamicMode();
            break;

        case 'number_pagination':
            pattern = analyzeUrlPattern(baseUrl, fullNextUrl);
            detectedInfo = 'æ•°å­—åˆ†é¡µæ¨¡å¼';
            break;

        default:
            pattern = analyzeUrlPattern(baseUrl, fullNextUrl);
            detectedInfo = 'æ ‡å‡†é“¾æ¥å¯¼èˆª';
    }

    // æ˜¾ç¤ºåˆ†æç»“æœ
    showNextPageAnalysis(selector, fullNextUrl, {
        type: navigationType,
        pattern: pattern?.pattern || fullNextUrl,
        detected: detectedInfo,
        navigation_type: navigationType,
        base_url: baseUrl
    });

    highlightElement(element, '__picker_selected__');
    updateSelectorDisplay(selector);
    showStatus('âœ… å·²åˆ†æä¸‹ä¸€é¡µé€»è¾‘', 'success');
    document.getElementById('confirmPicker').disabled = false;
}



function suggestDynamicMode() {
    const loadStrategySelect = document.querySelector('[name="load_strategy"]');
    if (loadStrategySelect && loadStrategySelect.value === 'static') {
        loadStrategySelect.value = 'dynamic';
        updateLoadStrategyIndicator();
        showNotification('å·²è‡ªåŠ¨åˆ‡æ¢åˆ°åŠ¨æ€æ¸²æŸ“æ¨¡å¼ä»¥æ”¯æŒJavaScriptå¯¼èˆª', 'info');
    }
}


function analyzeUrlPattern(currentUrl, nextUrl) {
    try {
        console.log('Analyzing URL pattern:');
        console.log('Current:', currentUrl);
        console.log('Next:', nextUrl);

        const current = new URL(currentUrl);
        const next = new URL(nextUrl);

        // æ£€æŸ¥æŸ¥è¯¢å‚æ•°ä¸­çš„é¡µç 
        const currentParams = new URLSearchParams(current.search);
        const nextParams = new URLSearchParams(next.search);

        // æ£€æŸ¥å¸¸è§çš„é¡µç å‚æ•°
        const pageParams = ['page', 'p', 'pagenum', 'pageNumber', 'offset', 'start'];

        for (const param of pageParams) {
            const currentValue = currentParams.get(param);
            const nextValue = nextParams.get(param);

            if (currentValue && nextValue && /^\d+$/.test(nextValue) && /^\d+$/.test(currentValue)) {
                const currentNum = parseInt(currentValue);
                const nextNum = parseInt(nextValue);

                if (nextNum === currentNum + 1) {
                    // æ„å»ºURLæ¨¡å¼
                    const pattern = `${next.origin}${next.pathname}?${param}={n}`;

                    // ä¿ç•™å…¶ä»–æŸ¥è¯¢å‚æ•°
                    const otherParams = new URLSearchParams(next.search);
                    otherParams.delete(param);

                    const finalPattern = otherParams.toString() ?
                        `${next.origin}${next.pathname}?${param}={n}&${otherParams.toString()}` :
                        pattern;

                    return {
                        type: 'query_param',
                        param: param,
                        pattern: finalPattern,
                        detected: `é¡µç å‚æ•°: ${param}`
                    };
                }
            }
        }

        // æ£€æŸ¥è·¯å¾„ä¸­çš„é¡µç 
        const currentParts = current.pathname.split('/');
        const nextParts = next.pathname.split('/');

        if (currentParts.length === nextParts.length) {
            for (let i = 0; i < currentParts.length; i++) {
                const currentPart = currentParts[i];
                const nextPart = nextParts[i];

                if (/^\d+$/.test(currentPart) && /^\d+$/.test(nextPart)) {
                    const currentNum = parseInt(currentPart);
                    const nextNum = parseInt(nextPart);

                    if (nextNum === currentNum + 1) {
                        const pathPattern = nextParts.map((part, idx) =>
                            idx === i ? '{n}' : part
                        ).join('/');

                        let fullPattern = `${next.origin}${pathPattern}`;
                        if (next.search) {
                            fullPattern += next.search;
                        }

                        return {
                            type: 'path',
                            pattern: fullPattern,
                            detected: `è·¯å¾„é¡µç ä½ç½®: ${i + 1}`
                        };
                    }
                }
            }
        }

        return {
            type: 'selector_based',
            pattern: null,
            detected: 'åŸºäºé€‰æ‹©å™¨çš„ä¸‹ä¸€é¡µå¯¼èˆª'
        };

    } catch (e) {
        console.error('URL pattern analysis error:', e);
        return {
            type: 'unknown',
            pattern: null,
            detected: 'æ— æ³•åˆ†æURLæ¨¡å¼'
        };
    }
}

function showNextPageAnalysis(selector, nextUrl, pattern) {
    const resultDiv = document.getElementById('nextPageTestResult');
    const urlDiv = document.getElementById('nextPageUrl');
    const patternDiv = document.getElementById('nextPagePattern');

    // ç¡®ä¿æ˜¾ç¤ºçš„æ˜¯æ­£ç¡®çš„ç›®æ ‡ç½‘ç«™URL
    let displayUrl = nextUrl;
    if (pattern.base_url && !nextUrl.startsWith('http')) {
        displayUrl = new URL(nextUrl, pattern.base_url).toString();
    }

    urlDiv.innerHTML = `<strong>ä¸‹ä¸€é¡µURL:</strong> <a href="${displayUrl}" target="_blank">${displayUrl}</a>`;
    patternDiv.innerHTML = `<strong>è¯†åˆ«æ¨¡å¼:</strong> ${pattern.detected}`;

    if (pattern.pattern) {
        patternDiv.innerHTML += `<br><code>${pattern.pattern}</code>`;

        // å¦‚æœæ£€æµ‹åˆ°æ•°å­—åˆ†é¡µæ¨¡å¼ï¼Œè‡ªåŠ¨è®¾ç½®ä¸ºnumberæ¨¡å¼
        if (pattern.type === 'query_param' || pattern.type === 'path') {
            document.getElementById('paginationMode').value = 'number';
            switchPaginationMode();

            // æ˜¾ç¤ºå»ºè®®
            patternDiv.innerHTML += `<br><small class="text-success">ğŸ’¡ å»ºè®®ä½¿ç”¨æ•°å­—åˆ†é¡µæ¨¡å¼ï¼Œå·²è‡ªåŠ¨åˆ‡æ¢</small>`;
        }
    }

    // éªŒè¯URLæ¨¡å¼æ˜¯å¦æŒ‡å‘ç›®æ ‡ç½‘ç«™
    if (pattern.pattern && (pattern.pattern.includes('127.0.0.1') || pattern.pattern.includes('localhost'))) {
        patternDiv.innerHTML += `<br><small class="text-warning">âš ï¸ æ£€æµ‹åˆ°æœ¬åœ°åœ°å€ï¼Œè¯·æ£€æŸ¥ç›®æ ‡ç½‘ç«™é…ç½®</small>`;
    }

    resultDiv.style.display = 'block';
}

// ==================== ä¸‹ä¸€é¡µæµ‹è¯•åŠŸèƒ½ ====================
async function testNextPageNavigation() {
    const selector = document.getElementById('nextPageSelector').value.trim();
    if (!selector) {
        alert('è¯·å…ˆè®¾ç½®ä¸‹ä¸€é¡µé€‰æ‹©å™¨');
        return;
    }

    const startUrl = document.getElementById('startUrl').value.trim();
    if (!startUrl) {
        alert('è¯·è®¾ç½®èµ·å§‹URL');
        return;
    }

    try {
        // æ”¹ä¸ºå‘é€FormDataè€Œä¸æ˜¯JSON
        const formData = new FormData();
        formData.append('url', startUrl);
        formData.append('selector', selector);

        const response = await fetch('/api/sources/test_next_page', {
            method: 'POST',
            body: formData  // ç§»é™¤Content-Typeå¤´ï¼Œè®©æµè§ˆå™¨è‡ªåŠ¨è®¾ç½®
        });

        const result = await response.json();

        if (result.success) {
            showNotification(`âœ… ä¸‹ä¸€é¡µæµ‹è¯•æˆåŠŸ: æ‰¾åˆ° ${result.next_url ? '1' : '0'} ä¸ªé“¾æ¥`, 'success');

            // æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
            if (result.next_url) {
                console.log('ä¸‹ä¸€é¡µURL:', result.next_url);
                console.log('å¯¼èˆªç±»å‹:', result.navigation_type);
            }
        } else {
            showNotification(`âŒ ä¸‹ä¸€é¡µæµ‹è¯•å¤±è´¥: ${result.error}`, 'danger');
        }
    } catch (error) {
        showNotification(`âŒ æµ‹è¯•å‡ºé”™: ${error.message}`, 'danger');
    }
}

// ==================== åŠ è½½æ›´å¤šæµ‹è¯•åŠŸèƒ½ ====================
async function testLoadMoreButton() {
    const selector = document.getElementById('loadMoreSelector').value.trim();
    if (!selector) {
        alert('è¯·å…ˆè®¾ç½®åŠ è½½æ›´å¤šæŒ‰é’®é€‰æ‹©å™¨');
        return;
    }

    const startUrl = document.getElementById('startUrl').value.trim();
    if (!startUrl) {
        alert('è¯·è®¾ç½®èµ·å§‹URL');
        return;
    }

    try {
        const response = await fetch('/api/sources/test_load_more', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                url: startUrl,
                selector: selector,
                max_clicks: 2
            })
        });

        const result = await response.json();

        if (result.success) {
            showNotification(`âœ… åŠ è½½æ›´å¤šæµ‹è¯•å®Œæˆ: ${result.results.selector_found ? 'æ‰¾åˆ°æŒ‰é’®' : 'æœªæ‰¾åˆ°æŒ‰é’®'}`,
                result.results.selector_found ? 'success' : 'warning');

            if (result.results.requires_javascript) {
                showNotification('â„¹ï¸ è¯¥åŠŸèƒ½éœ€è¦JavaScriptæ”¯æŒï¼Œå»ºè®®ä½¿ç”¨åŠ¨æ€æ¸²æŸ“', 'info');
            }
        } else {
            showNotification(`âŒ åŠ è½½æ›´å¤šæµ‹è¯•å¤±è´¥: ${result.error}`, 'danger');
        }
    } catch (error) {
        showNotification(`âŒ æµ‹è¯•å‡ºé”™: ${error.message}`, 'danger');
    }
}

// åˆå§‹åŒ–åŠ è½½æ›´å¤šæ¨¡å¼çš„å…ƒç´ é€‰æ‹©
function initLoadMoreMode(doc) {
    showStatus('ç‚¹å‡»é¡µé¢ä¸­çš„"åŠ è½½æ›´å¤š"ã€"Load More"ã€"æŸ¥çœ‹æ›´å¤š"ç­‰æŒ‰é’®', 'info');

    doc.addEventListener('mousemove', handleLoadMoreHover);
    doc.addEventListener('click', handleLoadMoreClick, true);
}

function handleLoadMoreHover(e) {
    if (!appState.pickerActive || appState.currentField !== 'load_more') return;

    clearHighlights(getIframeDoc('pickerFrame'));
    const target = e.target;

    // æ£€æŸ¥æ˜¯å¦å¯èƒ½æ˜¯åŠ è½½æ›´å¤šæŒ‰é’®
    const isPossibleLoadMore = checkIfPossibleLoadMore(target);

    if (isPossibleLoadMore) {
        highlightElement(target, '__picker_selected__');
        const text = target.textContent.trim();
        const displayText = text.length > 30 ? text.substring(0, 30) + '...' : text;
        updateStatus(`å€™é€‰åŠ è½½æ›´å¤šæŒ‰é’®: "${displayText}"`, 'info');
    } else {
        highlightElement(target);
    }
}

function handleLoadMoreClick(e) {
    if (!appState.pickerActive || appState.currentField !== 'load_more') return;
    e.preventDefault();
    e.stopPropagation();

    const element = e.target;
    const selector = generateStableSelector(element);

    highlightElement(element, '__picker_selected__');
    updateSelectorDisplay(selector);
    showStatus('âœ… å·²é€‰æ‹©åŠ è½½æ›´å¤šæŒ‰é’®', 'success');
    document.getElementById('confirmPicker').disabled = false;
}

function checkIfPossibleLoadMore(element) {
    const text = element.textContent.toLowerCase().trim();
    const classes = Array.from(element.classList).join(' ').toLowerCase();
    const tagName = element.tagName.toLowerCase();

    // åŠ è½½æ›´å¤šæ–‡æœ¬æ¨¡å¼
    const loadMoreTexts = [
        'load more', 'show more', 'see more', 'view more',
        'åŠ è½½æ›´å¤š', 'æŸ¥çœ‹æ›´å¤š', 'æ˜¾ç¤ºæ›´å¤š', 'æ›´å¤š',
        'more', 'load', 'expand', 'show all',
        'ver mÃ¡s', 'voir plus', 'mehr laden'
    ];

    // åŠ è½½æ›´å¤šç±»åæ¨¡å¼
    const loadMoreClasses = [
        'load-more', 'show-more', 'load_more', 'more-btn',
        'expand', 'loadmore', 'btn-more', 'view-more'
    ];

    // æ£€æŸ¥æ–‡æœ¬å†…å®¹
    const hasLoadMoreText = loadMoreTexts.some(keyword =>
        text.includes(keyword) && text.length < 50
    );

    // æ£€æŸ¥ç±»å
    const hasLoadMoreClass = loadMoreClasses.some(keyword =>
        classes.includes(keyword)
    );

    // æ£€æŸ¥æ˜¯å¦æ˜¯å¯ç‚¹å‡»å…ƒç´ 
    const isClickableElement =
        tagName === 'button' ||
        tagName === 'a' ||
        tagName === 'div' ||
        tagName === 'span' ||
        element.hasAttribute('onclick') ||
        classes.includes('btn') ||
        classes.includes('button') ||
        classes.includes('clickable');

    return (hasLoadMoreText || hasLoadMoreClass) && isClickableElement;
}
// ==================== å®¹å™¨åˆ†ææ¨¡å¼ - æ”¹è¿›ç‰ˆæ”¯æŒå¤šé‡é€‰æ‹© ====================
function initContainerAnalysisMode(doc) {
    showStatus('ç‚¹å‡»åŒ…å«å®Œæ•´æ–‡ç« ä¿¡æ¯çš„å®¹å™¨å…ƒç´ ï¼Œæˆ‘å°†åˆ†æå…¶æ‰€æœ‰å­å…ƒç´ ', 'info');

    doc.addEventListener('mousemove', handleContainerHover);
    doc.addEventListener('click', handleContainerClick, true);
}

function handleContainerHover(e) {
    if (!appState.pickerActive) return;

    clearHighlights(getIframeDoc('pickerFrame'));
    const target = e.target;

    // é«˜äº®æ˜¾ç¤ºå®¹å™¨
    highlightElement(target);

    // é¢„è§ˆå®¹å™¨åŒ…å«çš„å…ƒç´ æ•°é‡
    const childElements = Array.from(target.children);
    const textElements = childElements.filter(el => el.textContent.trim().length > 0);

    updateStatus(`å®¹å™¨åŒ…å« ${childElements.length} ä¸ªå­å…ƒç´ ï¼Œ${textElements.length} ä¸ªæœ‰å†…å®¹`, 'info');
}

function handleContainerClick(e) {
    if (!appState.pickerActive) return;
    e.preventDefault();
    e.stopPropagation();

    const container = e.target;

    // åˆ†æå®¹å™¨å†…çš„æ‰€æœ‰å…ƒç´ 
    analyzeContainerElements(container);
}

function analyzeContainerElements(container) {
    // æ”¹è¿›çš„å…ƒç´ åˆ†æé€»è¾‘
    const elements = analyzeContainerStructure(container);

    if (elements.length === 0) {
        showStatus('å®¹å™¨å†…æœªæ‰¾åˆ°å¯ç”¨çš„å­å…ƒç´ ', 'warning');
        return;
    }

    // ä¿å­˜åˆ†æç»“æœ
    appState.containerAnalysis.container = container;
    appState.containerAnalysis.elements = elements;

    // é‡ç½®é€‰æ‹©çŠ¶æ€
    appState.containerAnalysis.selected = {
        title: new Set(),
        link: new Set(),
        date: new Set()
    };

    // é«˜äº®å®¹å™¨
    highlightElement(container, '__picker_container__');

    // æ˜¾ç¤ºåˆ†æç»“æœ
    displayContainerAnalysis(elements);

    showStatus(`å·²åˆ†æå®¹å™¨ï¼Œæ‰¾åˆ° ${elements.length} ä¸ªå…ƒç´ `, 'success');
    document.getElementById('confirmPicker').disabled = false;
}

function analyzeContainerStructure(container) {
    const elements = [];

    // é€’å½’åˆ†ææ‰€æœ‰å­å…ƒç´ 
    function analyzeElement(el, depth = 0) {
        if (depth > 3) return; // é™åˆ¶æ·±åº¦é¿å…è¿‡åº¦åˆ†æ

        // æ£€æŸ¥å½“å‰å…ƒç´ æ˜¯å¦æœ‰æ„ä¹‰çš„æ–‡æœ¬å†…å®¹
        const text = el.textContent.trim();
        const tagName = el.tagName.toLowerCase();

        // æ£€æŸ¥æ˜¯å¦æ˜¯å¶å­èŠ‚ç‚¹æˆ–åŒ…å«æœ‰ç”¨ä¿¡æ¯çš„èŠ‚ç‚¹
        const hasChildren = el.children.length > 0;
        const hasDirectText = Array.from(el.childNodes)
            .some(node => node.nodeType === 3 && node.textContent.trim().length > 0);

        // å¦‚æœæ˜¯æœ‰æ„ä¹‰çš„æ–‡æœ¬å…ƒç´ ï¼Œæ·»åŠ åˆ°åˆ†æç»“æœ
        if (text.length > 0 && (!hasChildren || hasDirectText || ['a', 'time', 'span'].includes(tagName))) {
            // æ™ºèƒ½çŒœæµ‹å…ƒç´ ç±»å‹
            const elementType = guessElementType(el, text);

            elements.push({
                element: el,
                text: text,
                tagName: tagName,
                suggestedType: elementType,
                selector: generateStableSelector(el),
                isLink: tagName === 'a' || el.closest('a') !== null
            });
        }

        // ç»§ç»­åˆ†æå­å…ƒç´ 
        Array.from(el.children).forEach(child => {
            analyzeElement(child, depth + 1);
        });
    }

    analyzeElement(container);

    // å»é‡å’Œæ’åº
    const uniqueElements = [];
    const seenSelectors = new Set();

    elements.forEach(item => {
        if (!seenSelectors.has(item.selector) && item.text.length > 2) {
            seenSelectors.add(item.selector);
            uniqueElements.push(item);
        }
    });

    // æŒ‰å…ƒç´ ç±»å‹å’Œæ–‡æœ¬é•¿åº¦æ’åº
    return uniqueElements.sort((a, b) => {
        const typeOrder = { 'title': 1, 'link': 2, 'date': 3, 'content': 4 };
        const aOrder = typeOrder[a.suggestedType] || 5;
        const bOrder = typeOrder[b.suggestedType] || 5;

        if (aOrder !== bOrder) return aOrder - bOrder;
        return b.text.length - a.text.length; // æ–‡æœ¬é•¿çš„ä¼˜å…ˆ
    }).slice(0, 15); // é™åˆ¶æ˜¾ç¤ºæ•°é‡
}

function guessElementType(element, text) {
    const tagName = element.tagName.toLowerCase();
    const textLower = text.toLowerCase();
    const classes = Array.from(element.classList).join(' ').toLowerCase();

    // ä¼˜å…ˆæ£€æŸ¥æ˜ç¡®çš„æ ‡ç­¾ç±»å‹
    if (tagName === 'time') {
        return 'date';
    }

    if (tagName === 'a') {
        // é“¾æ¥å…ƒç´ ï¼Œæ ¹æ®æ–‡æœ¬é•¿åº¦åˆ¤æ–­æ˜¯å¦ä¸ºæ ‡é¢˜é“¾æ¥
        if (text.length > 20 && text.length < 300) {
            return 'title';  // é•¿æ–‡æœ¬é“¾æ¥é€šå¸¸æ˜¯æ ‡é¢˜
        }
        return 'link';
    }

    // æ£€æŸ¥æ ‡é¢˜æ ‡ç­¾
    if (['h1', 'h2', 'h3', 'h4', 'h5', 'h6'].includes(tagName)) {
        return 'title';
    }

    // æ£€æŸ¥ç±»åä¸­çš„å…³é”®è¯
    if (/title|headline|subject|heading/.test(classes)) {
        return 'title';
    }

    if (/date|time|publish|created|when/.test(classes)) {
        return 'date';
    }

    // æ£€æŸ¥æ—¥æœŸæ¨¡å¼ï¼ˆæ–‡æœ¬å†…å®¹ï¼‰
    const datePatterns = [
        /\d{4}[-/]\d{1,2}[-/]\d{1,2}/,
        /\d{1,2}[-/]\d{1,2}[-/]\d{4}/,
        /(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)\s+\d{1,2},?\s+\d{4}/i,
        /\d{1,2}\s+(minutes?|hours?|days?|weeks?|months?)\s+ago/i
    ];

    if (datePatterns.some(pattern => pattern.test(text))) {
        return 'date';
    }

    // åŸºäºæ–‡æœ¬é•¿åº¦çš„å¯å‘å¼åˆ¤æ–­
    if (text.length > 30 && text.length < 300) {
        return 'title';  // ä¸­ç­‰é•¿åº¦æ–‡æœ¬å¯èƒ½æ˜¯æ ‡é¢˜
    } else if (text.length <= 30 && text.length > 5) {
        // çŸ­æ–‡æœ¬ï¼Œæ£€æŸ¥æ˜¯å¦åŒ…å«æ—¥æœŸä¿¡æ¯
        if (/^\d{1,2}\s+(aug|sep|oct|nov|dec|jan|feb|mar|apr|may|jun|jul)/i.test(text) ||
            /external\s+event/i.test(text)) {
            return 'date';
        }
        return 'content';
    }

    return 'content';
}

function displayContainerAnalysis(elements) {
    let html = '';
    elements.forEach((item, index) => {
        const { element, text, tagName, suggestedType, selector, isLink } = item;

        html += `
            <div class="element-item" data-index="${index}" data-type="${suggestedType}">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <strong>&lt;${tagName}&gt;</strong>
                        ${isLink ? '<i class="bi bi-link text-primary ms-1"></i>' : ''}
                        ${suggestedType ? `<span class="badge bg-info ms-1">${suggestedType}</span>` : ''}
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-primary btn-sm"
                                onclick="toggleElementType(${index}, 'title')">æ ‡é¢˜</button>
                        <button type="button" class="btn btn-outline-success btn-sm"
                                onclick="toggleElementType(${index}, 'link')">é“¾æ¥</button>
                        <button type="button" class="btn btn-outline-warning btn-sm"
                                onclick="toggleElementType(${index}, 'date')">æ—¥æœŸ</button>
                    </div>
                </div>
                <div class="element-preview">${text.length > 80 ? text.substring(0, 80) + '...' : text}</div>
                <code class="small text-muted">${selector}</code>
                <div class="multi-select-badges" id="badges-${index}"></div>
            </div>
        `;
    });

    document.getElementById('containerElements').innerHTML = html;

    // æ˜¾ç¤ºå®¹å™¨åˆ†æå¼¹çª—
    new bootstrap.Modal(document.getElementById('containerAnalysisModal')).show();
}

// ä¿®æ”¹ä¸ºæ”¯æŒå¤šé‡é€‰æ‹©çš„å‡½æ•°
function toggleElementType(index, type) {
    const selected = appState.containerAnalysis.selected;

    if (selected[type].has(index)) {
        // å¦‚æœå·²é€‰æ‹©ï¼Œå–æ¶ˆé€‰æ‹©
        selected[type].delete(index);
    } else {
        // å¦‚æœæœªé€‰æ‹©ï¼Œæ·»åŠ é€‰æ‹©
        selected[type].add(index);
    }

    // æ›´æ–°UI
    updateContainerAnalysisUI();
}

function updateContainerAnalysisUI() {
    const selected = appState.containerAnalysis.selected;

    // æ›´æ–°å…ƒç´ é¡¹çš„é€‰ä¸­çŠ¶æ€å’Œå¾½ç« 
    document.querySelectorAll('.element-item').forEach((item, index) => {
        // é‡ç½®ç±»å
        item.className = 'element-item';

        // ç¡®å®šé€‰æ‹©çŠ¶æ€
        const isTitle = selected.title.has(index);
        const isLink = selected.link.has(index);
        const isDate = selected.date.has(index);
        const selectionCount = [isTitle, isLink, isDate].filter(Boolean).length;

        // åº”ç”¨æ ·å¼
        if (selectionCount > 1) {
            item.classList.add('selected-multiple');
        } else if (isTitle) {
            item.classList.add('selected-title');
        } else if (isLink) {
            item.classList.add('selected-link');
        } else if (isDate) {
            item.classList.add('selected-date');
        }

        // æ›´æ–°å¾½ç« 
        const badgesDiv = document.getElementById(`badges-${index}`);
        let badges = '';
        if (isTitle) badges += '<span class="badge bg-primary">æ ‡é¢˜</span>';
        if (isLink) badges += '<span class="badge bg-success">é“¾æ¥</span>';
        if (isDate) badges += '<span class="badge bg-warning">æ—¥æœŸ</span>';
        badgesDiv.innerHTML = badges;
    });

    // æ›´æ–°é€‰æ‹©é…ç½®æ˜¾ç¤º
    const configs = [];
    const elements = appState.containerAnalysis.elements;

    if (selected.title.size > 0) {
        const titleIndices = Array.from(selected.title);
        configs.push(`æ ‡é¢˜: ${titleIndices.length}ä¸ªé€‰æ‹©`);
    }
    if (selected.link.size > 0) {
        const linkIndices = Array.from(selected.link);
        configs.push(`é“¾æ¥: ${linkIndices.length}ä¸ªé€‰æ‹©`);
    }
    if (selected.date.size > 0) {
        const dateIndices = Array.from(selected.date);
        configs.push(`æ—¥æœŸ: ${dateIndices.length}ä¸ªé€‰æ‹©`);
    }

    document.getElementById('selectedConfigs').innerHTML =
        configs.length > 0 ? configs.join('ã€') : 'å°šæœªé€‰æ‹©...';

    // å¯ç”¨/ç¦ç”¨åº”ç”¨æŒ‰é’®
    document.getElementById('applyContainerBtn').disabled = configs.length === 0;
}

function applyContainerAnalysis() {
    const selected = appState.containerAnalysis.selected;
    const elements = appState.containerAnalysis.elements;
    const container = appState.containerAnalysis.container;

    // ç”Ÿæˆå®¹å™¨é€‰æ‹©å™¨
    const containerSelector = generateStableSelector(container);
    document.getElementById('listSelector').value = containerSelector;

    // åº”ç”¨å„ä¸ªå­—æ®µçš„é€‰æ‹©å™¨ï¼ˆæ”¯æŒå¤šä¸ªé€‰æ‹©ï¼‰
    if (selected.title.size > 0) {
        const titleSelectors = Array.from(selected.title).map(index => {
            const titleItem = elements[index];
            return titleItem.selector;
        });
        document.getElementById('titleSelector').value = titleSelectors.join(', ');
    }

    if (selected.link.size > 0) {
        const linkSelectors = Array.from(selected.link).map(index => {
            const linkItem = elements[index];
            let linkSelector = linkItem.selector;

            // å¦‚æœå…ƒç´ æœ¬èº«ä¸æ˜¯é“¾æ¥ï¼ŒæŸ¥æ‰¾æœ€è¿‘çš„çˆ¶çº§é“¾æ¥
            if (linkItem.tagName !== 'a') {
                const linkElement = linkItem.element.closest('a');
                if (linkElement) {
                    linkSelector = generateStableSelector(linkElement);
                }
            }
            return linkSelector;
        });
        document.getElementById('linkSelector').value = linkSelectors.join(', ');
    }

    if (selected.date.size > 0) {
        const dateSelectors = Array.from(selected.date).map(index => {
            const dateItem = elements[index];
            return dateItem.selector;
        });
        document.getElementById('dateSelector').value = dateSelectors.join(', ');
    }

    // å…³é—­å¼¹çª—
    closeContainerAnalysis();
    closePicker();

    showNotification('å·²åº”ç”¨å®¹å™¨åˆ†æé…ç½®ï¼ˆæ”¯æŒå¤šé‡é€‰æ‹©ï¼‰', 'success');
}

function closeContainerAnalysis() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('containerAnalysisModal'));
    if (modal) modal.hide();

    // é‡ç½®çŠ¶æ€
    appState.containerAnalysis = {
        container: null,
        elements: [],
        selected: {
            title: new Set(),
            link: new Set(),
            date: new Set()
        }
    };
}

// ==================== ç›´æ¥é€‰æ‹©æ¨¡å¼ ====================
function initDirectMode(doc) {
    const instructions = {
        'list': 'è¯·ç‚¹å‡»åŒ…å«æ‰€æœ‰æ–‡ç« é¡¹çš„å®¹å™¨å…ƒç´ ',
        'title': 'è¯·ç‚¹å‡»ä¸€ä¸ªæ–‡ç« æ ‡é¢˜',
        'date': 'è¯·ç‚¹å‡»ä¸€ä¸ªæ—¥æœŸå…ƒç´ ',
        'next_page': 'è¯·ç‚¹å‡»"ä¸‹ä¸€é¡µ"æŒ‰é’®æˆ–é“¾æ¥'
    };
    showStatus(instructions[appState.currentField] || 'è¯·ç‚¹å‡»è¦é€‰æ‹©çš„å…ƒç´ ', 'info');
    doc.addEventListener('mousemove', handleDirectHover);
    doc.addEventListener('click', handleDirectClick, true);
}

function handleDirectHover(e) {
    if (!appState.pickerActive) return;
    clearHighlights(getIframeDoc('pickerFrame'));
    highlightElement(e.target);
}

function handleDirectClick(e) {
    if (!appState.pickerActive) return;
    e.preventDefault();
    e.stopPropagation();

    const element = e.target;
    const selector = generateStableSelector(element);

    // å¯¹äºä¸‹ä¸€é¡µé“¾æ¥ï¼Œæ˜¾ç¤ºé“¾æ¥åœ°å€
    if (appState.currentField === 'next_page') {
        const href = element.getAttribute('href');
        if (href) {
            showStatus(`âœ… å·²é€‰æ‹©ä¸‹ä¸€é¡µé“¾æ¥: ${href}`, 'success');
        } else {
            showStatus(`âš ï¸ é€‰æ‹©çš„å…ƒç´ æ²¡æœ‰é“¾æ¥åœ°å€`, 'warning');
        }
    }

    highlightElement(element, '__picker_selected__');
    updateSelectorDisplay(selector);
    showStatus('âœ… å·²é€‰æ‹©å…ƒç´ ï¼', 'success');
    document.getElementById('confirmPicker').disabled = false;
}

// ==================== æ£€æŸ¥é€‰æ‹©å™¨åŠŸèƒ½ - å¢å¼ºç‰ˆ ====================
function checkSelector(field) {
    const inputMap = {
        'list': 'listSelector',
        'title': 'titleSelector',
        'link': 'linkSelector',
        'date': 'dateSelector',
        'next_page': 'nextPageSelector'
    };

    const inputId = inputMap[field];
    const selector = document.getElementById(inputId).value.trim();

    if (!selector) {
        alert('è¯·å…ˆè¾“å…¥é€‰æ‹©å™¨');
        return;
    }

    const doc = getIframeDoc('previewFrame');
    if (!doc) {
        alert('é¢„è§ˆé¡µé¢æœªåŠ è½½');
        return;
    }

    try {
        let elements = [];

        // å¯¹äºéåˆ—è¡¨é€‰æ‹©å™¨ï¼Œåœ¨åˆ—è¡¨å®¹å™¨èŒƒå›´å†…æŸ¥æ‰¾
        if (field !== 'list' && field !== 'next_page') {
            const listSelector = document.getElementById('listSelector').value.trim();
            if (listSelector) {
                const scope = doc.querySelector(listSelector);
                if (scope) {
                    elements = Array.from(scope.querySelectorAll(selector));
                } else {
                    elements = Array.from(doc.querySelectorAll(selector));
                }
            } else {
                elements = Array.from(doc.querySelectorAll(selector));
            }
        } else {
            elements = Array.from(doc.querySelectorAll(selector));
        }

        if (elements.length === 0) {
            alert('æœªæ‰¾åˆ°åŒ¹é…çš„å…ƒç´ ');
            return;
        }

        clearHighlights(doc);
        ensureHighlightCSS(doc);

        // é«˜äº®æ˜¾ç¤ºæ‰€æœ‰åŒ¹é…å…ƒç´ å¹¶æå–å†…å®¹
        const previewItems = [];
        elements.forEach((el, index) => {
            if (index === 0) {
                highlightElement(el, '__picker_selected__');
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                highlightElement(el, '__picker_container__');
            }

            // æå–å†…å®¹é¢„è§ˆ
            if (field === 'title') {
                const text = el.textContent.trim();
                previewItems.push({
                    type: 'text',
                    content: text,
                    selector: selector
                });
            } else if (field === 'link') {
                const link = el.tagName.toLowerCase() === 'a' ? el : el.querySelector('a');
                if (link) {
                    previewItems.push({
                        type: 'link',
                        content: link.textContent.trim(),
                        href: link.getAttribute('href'),
                        selector: selector
                    });
                }
            } else if (field === 'date') {
                previewItems.push({
                    type: 'date',
                    content: el.textContent.trim(),
                    selector: selector
                });
            }
        });

        showNotification(`æ‰¾åˆ° ${elements.length} ä¸ªåŒ¹é…å…ƒç´ `, 'success');

        // æ˜¾ç¤ºå†…å®¹é¢„è§ˆ
        if (previewItems.length > 0) {
            // é™åˆ¶é¢„è§ˆæ•°é‡
            showContentPreview(previewItems.slice(0, 5));
        }

    } catch (e) {
        alert('é€‰æ‹©å™¨è¯­æ³•é”™è¯¯: ' + e.message);
    }
}

// ==================== Drupalåˆ†é¡µå¤„ç†æ–¹æ¡ˆé›†æˆ ====================

function switchPaginationMode() {
    const mode = document.getElementById('paginationMode').value;
    console.log('åˆ‡æ¢åˆ†é¡µæ¨¡å¼åˆ°:', mode);

    // éšè—æ‰€æœ‰é…ç½®åŒºåŸŸ
    document.querySelectorAll('.pagination-config').forEach(el => {
        el.classList.add('d-none');
    });

    // æ˜¾ç¤ºå¯¹åº”çš„é…ç½®åŒºåŸŸ
    if (mode === 'next') {
        const nextConfig = document.getElementById('nextPageConfig');
        if (nextConfig) {
            nextConfig.classList.remove('d-none');
        }
    } else if (mode === 'loadmore') {
        const loadMoreConfig = document.getElementById('loadMoreConfig');
        if (loadMoreConfig) {
            loadMoreConfig.classList.remove('d-none');
        }
        // è‡ªåŠ¨å»ºè®®ä½¿ç”¨åŠ¨æ€æ¸²æŸ“
        if (document.getElementById('loadMoreRequiresDynamic') && document.getElementById('loadMoreRequiresDynamic').checked) {
            const loadStrategy = document.querySelector('[name="load_strategy"]');
            if (loadStrategy && loadStrategy.value === 'static') {
                loadStrategy.value = 'dynamic';
                updateLoadStrategyIndicator();
                showNotification('å·²è‡ªåŠ¨åˆ‡æ¢åˆ°åŠ¨æ€æ¸²æŸ“æ¨¡å¼ä»¥æ”¯æŒåŠ è½½æ›´å¤šåŠŸèƒ½', 'info');
            }
        }
    } else if (mode === 'number') {
        // ç¡®ä¿æ•°å­—åˆ†é¡µé…ç½®åŒºåŸŸå­˜åœ¨
        ensureNumberPaginationConfig();
        const numberConfig = document.getElementById('numberPaginationConfig');
        if (numberConfig) {
            numberConfig.classList.remove('d-none');
        }
    }
}

function loadPaginationModeFromRecipe() {
    // è¿™ä¸ªå‡½æ•°åœ¨æ¨¡æ¿ä¸­é€šè¿‡æœåŠ¡å™¨ç«¯æ¸²æŸ“æ¥è®¾ç½®åˆå§‹å€¼
    // ä½†æˆ‘ä»¬å¯ä»¥æ·»åŠ å®¢æˆ·ç«¯éªŒè¯
    const mode = document.getElementById('paginationMode').value;
    if (mode === 'number') {
        const pagePattern = document.getElementById('pagePattern');
        const drupalZeroBased = document.getElementById('drupalZeroBased');

        if (pagePattern && pagePattern.value) {
            console.log('åŠ è½½å·²æœ‰çš„æ•°å­—åˆ†é¡µé…ç½®:', {
                pattern: pagePattern.value,
                drupalZeroBased: drupalZeroBased ? drupalZeroBased.checked : false
            });
        }
    }
}

function createNumberPaginationConfig() {
    const paginationCard = document.querySelector('.card.advanced-card .card-body');
    const maxPagesDiv = paginationCard.querySelector('.mt-3');

    const numberConfigHtml = `
        <div id="numberPaginationConfig" class="pagination-config d-none">
            <label class="form-label">URLæ¨¡å¼</label>
            <div class="input-group">
                <input type="text" class="form-control" id="pagePattern" name="page_pattern"
                       placeholder="https://example.com/events?type[]=event&page={n}">
                <button type="button" class="btn btn-outline-info" onclick="testNumberPagination()" title="æµ‹è¯•æ•°å­—åˆ†é¡µ">
                    ğŸ§ª
                </button>
            </div>
            <div class="form-text">
                ä½¿ç”¨ <code>{n}</code> è¡¨ç¤ºé¡µç å ä½ç¬¦ã€‚<br>
                <strong>æ³¨æ„ï¼š</strong>Drupalç³»ç»Ÿé¡µç ä»0å¼€å§‹ï¼ˆç¬¬1é¡µ=page=0ï¼Œç¬¬2é¡µ=page=1ï¼‰
            </div>

            <div class="mt-2">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="drupalZeroBased" name="drupal_zero_based" checked>
                    <label class="form-check-label" for="drupalZeroBased">
                        Drupalé›¶åŸºé¡µç ï¼ˆæ¨èï¼‰
                    </label>
                </div>
                <div class="form-text small">
                    å‹¾é€‰æ­¤é¡¹ï¼šç¬¬1é¡µ=page=0ï¼Œç¬¬2é¡µ=page=1<br>
                    ä¸å‹¾é€‰ï¼šç¬¬1é¡µ=page=1ï¼Œç¬¬2é¡µ=page=2
                </div>
            </div>
        </div>
    `;

    maxPagesDiv.insertAdjacentHTML('beforebegin', numberConfigHtml);
}

// ==================== è¾…åŠ©å‡½æ•°ï¼šç¡®ä¿æ•°å­—åˆ†é¡µé€‰é¡¹å­˜åœ¨ ====================
function ensureNumberPaginationOption() {
    const select = document.getElementById('paginationMode');
    if (select && !select.querySelector('option[value="number"]')) {
        const option = document.createElement('option');
        option.value = 'number';
        option.textContent = 'æ•°å­—åˆ†é¡µæ¨¡å¼ï¼ˆæ¨èç”¨äºDrupalï¼‰';
        select.appendChild(option);
    }
}

// ==================== è¾…åŠ©å‡½æ•°ï¼šæ£€æµ‹æ˜¯å¦å¯èƒ½æ˜¯Drupalç½‘ç«™ ====================
function isDrupalLikeUrl(url) {
    try {
        const urlObj = new URL(url);
        const search = urlObj.search.toLowerCase();
        const pathname = urlObj.pathname.toLowerCase();

        // æ£€æµ‹å¸¸è§çš„Drupalç‰¹å¾
        const drupalIndicators = [
            search.includes('type[]='),
            search.includes('page='),
            pathname.includes('/node/'),
            pathname.includes('/taxonomy/'),
            pathname.includes('/views/'),
            search.includes('field_'),
            search.includes('drupal')
        ];

        return drupalIndicators.some(indicator => indicator);
    } catch (e) {
        return false;
    }
}

// ==================== æ ¸å¿ƒDrupalåˆ†æå‡½æ•°ï¼ˆä»ç¬¬ä¸€ä¸ªæ–‡ä»¶ç§»æ¤ï¼‰ ====================
function analyzeDrupalPagination(element) {
    const startUrl = document.getElementById('startUrl').value.trim();

    try {
        // è§£ædata-optionså±æ€§
        const dataOptions = element.getAttribute('data-options');
        if (!dataOptions) {
            showStatus('âŒ æ— æ³•è§£æDrupalåˆ†é¡µæ•°æ®', 'danger');
            return;
        }

        const options = JSON.parse(dataOptions.replace(/&quot;/g, '"'));
        console.log('Drupalåˆ†é¡µæ•°æ®:', options);

        // æå–æŸ¥è¯¢å‚æ•°
        const query = options.query || {};

        // æ„å»ºURLæ¨¡å¼
        const baseUrl = new URL(startUrl);
        const urlPattern = buildDrupalUrlPattern(baseUrl, query);

        if (urlPattern) {
            // è‡ªåŠ¨åˆ‡æ¢åˆ°æ•°å­—åˆ†é¡µæ¨¡å¼
            document.getElementById('paginationMode').value = 'number';
            switchPaginationMode();

            // è®¾ç½®é¡µé¢æ¨¡å¼é…ç½®
            const pagePatternInput = document.getElementById('pagePattern');
            if (pagePatternInput) {
                pagePatternInput.value = urlPattern;
            }

            // å¯ç”¨Drupalé›¶åŸºé¡µç 
            const drupalZeroBased = document.getElementById('drupalZeroBased');
            if (drupalZeroBased) {
                drupalZeroBased.checked = true;
            }

            showDrupalAnalysis(element, urlPattern, query);

            // å»ºè®®åŠ¨æ€æ¸²æŸ“ï¼ˆDrupalé€šå¸¸éœ€è¦JavaScriptï¼‰
            suggestDynamicMode();

            highlightElement(element, '__picker_selected__');
            updateSelectorDisplay('æ•°å­—åˆ†é¡µæ¨¡å¼ - ä¸éœ€è¦é€‰æ‹©å™¨');
            showStatus('âœ… å·²é…ç½®Drupalæ•°å­—åˆ†é¡µ', 'success');
            document.getElementById('confirmPicker').disabled = false;

        } else {
            showStatus('âŒ æ— æ³•æ„å»ºURLæ¨¡å¼', 'danger');
        }

    } catch (e) {
        console.error('Drupalåˆ†é¡µè§£æé”™è¯¯:', e);
        showStatus('âŒ Drupalåˆ†é¡µè§£æå¤±è´¥: ' + e.message, 'danger');
    }
}


function showDrupalAnalysis(element, pattern, query) {
    const resultDiv = document.getElementById('nextPageTestResult');
    const urlDiv = document.getElementById('nextPageUrl');
    const patternDiv = document.getElementById('nextPagePattern');

    // ç¡®ä¿æ¨¡å¼ä¸­çš„å ä½ç¬¦æ²¡æœ‰è¢«URLç¼–ç 
    const cleanPattern = pattern.replace(/%7Bn%7D/g, '{n}');

    // ç”Ÿæˆç¤ºä¾‹URLï¼ˆç¬¬2é¡µå’Œç¬¬3é¡µï¼‰
    const exampleUrl2 = cleanPattern.replace(/{n}/g, '1'); // Drupal: ç¬¬2é¡µ = page=1
    const exampleUrl3 = cleanPattern.replace(/{n}/g, '2'); // Drupal: ç¬¬3é¡µ = page=2

    urlDiv.innerHTML = `
        <strong>âœ… æ£€æµ‹åˆ°Drupalåˆ†é¡µç³»ç»Ÿ</strong><br>
        <small class="text-muted">ç¤ºä¾‹URL:</small><br>
        <small>ç¬¬2é¡µ: <a href="${exampleUrl2}" target="_blank">${exampleUrl2}</a></small><br>
        <small>ç¬¬3é¡µ: <a href="${exampleUrl3}" target="_blank">${exampleUrl3}</a></small>
    `;

    patternDiv.innerHTML = `
        <strong>URLæ¨¡å¼:</strong><br>
        <code>${cleanPattern}</code><br>
        <strong>æŸ¥è¯¢å‚æ•°:</strong><br>
        <code>${JSON.stringify(query, null, 2)}</code><br>
        <div class="alert alert-success mt-2 small">
            <strong>ğŸ’¡ é…ç½®å»ºè®®:</strong><br>
            â€¢ å·²è‡ªåŠ¨åˆ‡æ¢åˆ°æ•°å­—åˆ†é¡µæ¨¡å¼<br>
            â€¢ å·²å¯ç”¨Drupalé›¶åŸºé¡µç <br>
            â€¢ å»ºè®®ä½¿ç”¨åŠ¨æ€æ¸²æŸ“æ¨¡å¼<br>
            â€¢ çˆ¬è™«å°†ç”Ÿæˆ: page=0, page=1, page=2...
        </div>
    `;

    resultDiv.style.display = 'block';

    // æ›´æ–°è¡¨å•ä¸­çš„URLæ¨¡å¼
    const pagePatternInput = document.getElementById('pagePattern');
    if (pagePatternInput) {
        pagePatternInput.value = cleanPattern;
    }
}

// ==================== ä¿®å¤çš„ buildDrupalUrlPattern å‡½æ•° ====================
function buildDrupalUrlPattern(baseUrl, query) {
    try {
        const params = new URLSearchParams();

        // å¤„ç†æ‰€æœ‰æŸ¥è¯¢å‚æ•°
        for (const [key, value] of Object.entries(query)) {
            if (key === 'page') {
                // é¡µç å‚æ•°ç”¨å ä½ç¬¦æ›¿æ¢ - æ³¨æ„ï¼šä¸è¦è¿›è¡ŒURLç¼–ç 
                params.set(key, '{n}');
            } else if (Array.isArray(value)) {
                // å¤„ç†æ•°ç»„å‚æ•°ï¼ˆå¦‚ type[]ï¼‰
                value.forEach(v => params.append(key + '[]', v));
            } else {
                params.set(key, value);
            }
        }

        // å¦‚æœæ²¡æœ‰pageå‚æ•°ï¼Œæ·»åŠ ä¸€ä¸ª
        if (!params.has('page')) {
            params.set('page', '{n}');
        }

        // æ„å»ºå®Œæ•´URLæ¨¡å¼
        let pattern = `${baseUrl.origin}${baseUrl.pathname}`;

        // æ·»åŠ æŸ¥è¯¢å‚æ•° - æ‰‹åŠ¨æ„å»ºä»¥é¿å…{n}è¢«ç¼–ç 
        const queryString = params.toString();
        if (queryString) {
            pattern += '?' + queryString;
            // ä¿®å¤ï¼šå°†ç¼–ç çš„å ä½ç¬¦è¿˜åŸä¸ºåŸå§‹å½¢å¼
            pattern = pattern.replace(/%7Bn%7D/g, '{n}');
            pattern = pattern.replace(/%7B/g, '{');
            pattern = pattern.replace(/%7D/g, '}');
        }

        console.log('ç”Ÿæˆçš„URLæ¨¡å¼:', pattern);
        return pattern;

    } catch (e) {
        console.error('URLæ¨¡å¼æ„å»ºå¤±è´¥:', e);
        return null;
    }
}

// ==================== å¢å¼ºçš„æµ‹è¯•å‡½æ•°ï¼Œæä¾›çœŸå®åé¦ˆ ====================
async function testNumberPagination() {
    const pattern = document.getElementById('pagePattern').value.trim();
    const maxPages = parseInt(document.querySelector('[name="max_pages"]').value) || 3;
    const drupalZeroBased = document.getElementById('drupalZeroBased').checked;

    if (!pattern) {
        alert('è¯·å…ˆè®¾ç½®URLæ¨¡å¼');
        return;
    }

    if (!pattern.includes('{n}')) {
        alert('URLæ¨¡å¼å¿…é¡»åŒ…å« {n} å ä½ç¬¦');
        return;
    }

    try {
        showNotification('æ­£åœ¨æµ‹è¯•æ•°å­—åˆ†é¡µ...', 'info');

        // ç”Ÿæˆæµ‹è¯•URL
        const testUrls = [];
        const startPage = drupalZeroBased ? 0 : 1;

        for (let i = 0; i < Math.min(maxPages, 3); i++) {
            const pageNum = startPage + i;
            const testUrl = pattern.replace(/{n}/g, pageNum.toString());
            testUrls.push({
                page: drupalZeroBased ? `ç¬¬${i + 1}é¡µ` : `ç¬¬${pageNum}é¡µ`,
                url: testUrl,
                pageParam: pageNum
            });
        }

        // å®é™…æµ‹è¯•URLå¯è®¿é—®æ€§
        let resultHtml = '<div class="alert alert-info"><h6>æ•°å­—åˆ†é¡µæµ‹è¯•ç»“æœ:</h6>';
        let successCount = 0;

        for (const test of testUrls) {
            try {
                // ä½¿ç”¨ä»£ç†æœåŠ¡å™¨æµ‹è¯•URL - æ”¹ä¸ºGETæ–¹æ³•
                const proxyUrl = `/proxy?url=${encodeURIComponent(test.url)}`;
                const response = await fetch(proxyUrl, {
                    method: 'GET',  // ä¿®æ”¹ï¼šä»HEADæ”¹ä¸ºGET
                    timeout: 5000
                });

                const status = response.ok ? 'âœ…' : 'âŒ';
                const statusText = response.ok ? 'OK' : `Error ${response.status}`;

                if (response.ok) successCount++;

                resultHtml += `
                    <div class="d-flex justify-content-between align-items-center border-bottom py-1">
                        <div>
                            <strong>${test.page}:</strong>
                            <a href="${test.url}" target="_blank" class="small">page=${test.pageParam}</a>
                        </div>
                        <span class="badge bg-${response.ok ? 'success' : 'danger'}">${status} ${statusText}</span>
                    </div>
                `;
            } catch (error) {
                resultHtml += `
                    <div class="d-flex justify-content-between align-items-center border-bottom py-1">
                        <div>
                            <strong>${test.page}:</strong>
                            <a href="${test.url}" target="_blank" class="small">page=${test.pageParam}</a>
                        </div>
                        <span class="badge bg-warning">âŒ è¿æ¥å¤±è´¥</span>
                    </div>
                `;
            }
        }

        resultHtml += `
            <div class="mt-2">
                <strong>æµ‹è¯•æ€»ç»“ï¼š</strong> ${successCount}/${testUrls.length} ä¸ªURLå¯è®¿é—®
            </div>
        `;

        if (successCount === 0) {
            resultHtml += `
                <div class="alert alert-warning mt-2 small">
                    <strong>å»ºè®®æ£€æŸ¥ï¼š</strong><br>
                    â€¢ URLæ¨¡å¼æ˜¯å¦æ­£ç¡®<br>
                    â€¢ æ˜¯å¦éœ€è¦åŠ¨æ€æ¸²æŸ“æ¨¡å¼<br>
                    â€¢ ç½‘ç«™æ˜¯å¦æœ‰è®¿é—®é™åˆ¶
                </div>
            `;
        } else if (successCount === testUrls.length) {
            resultHtml += `
                <div class="alert alert-success mt-2 small">
                    <strong>æµ‹è¯•é€šè¿‡ï¼</strong> æ‰€æœ‰URLéƒ½å¯ä»¥æ­£å¸¸è®¿é—®
                </div>
            `;
        }

        resultHtml += '</div>';

        document.getElementById('nextPageTestResult').innerHTML = resultHtml;
        document.getElementById('nextPageTestResult').style.display = 'block';

        const message = successCount > 0 ?
            `âœ… æ•°å­—åˆ†é¡µæµ‹è¯•å®Œæˆ (${successCount}/${testUrls.length} æˆåŠŸ)` :
            'âŒ æ•°å­—åˆ†é¡µæµ‹è¯•å¤±è´¥';

        showNotification(message, successCount > 0 ? 'success' : 'warning');

    } catch (error) {
        showNotification(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'danger');
    }
}


// ==================== åçˆ¬è™«æ£€æµ‹åŠŸèƒ½ ====================
function checkForAntibot() {
    const iframe = document.getElementById('previewFrame');
    iframe.addEventListener('load', function() {
        try {
            const doc = iframe.contentDocument;
            if (!doc) return;

            const text = doc.body.textContent.toLowerCase();

            // æ£€æµ‹å¸¸è§çš„åçˆ¬è™«æ ‡å¿—
            const antibotSignals = [
                'cloudflare',
                'captcha',
                'robot',
                'bot detection',
                'access denied',
                'forbidden',
                'rate limit',
                'please verify',
                'checking your browser',
                'éªŒè¯ç ',
                'æœºå™¨äººæ£€æµ‹',
                'è®¿é—®è¢«æ‹’ç»'
            ];

            const hasAntibot = antibotSignals.some(signal => text.includes(signal));

            if (hasAntibot) {
                document.getElementById('antibotWarning').classList.remove('d-none');
                // è‡ªåŠ¨å»ºè®®åˆ‡æ¢ç­–ç•¥
                suggestAntibotStrategy();
            } else {
                document.getElementById('antibotWarning').classList.add('d-none');
            }
        } catch(e) {
            // è·¨åŸŸé™åˆ¶ï¼Œå¯èƒ½éœ€è¦ç‰¹æ®Šå¤„ç†
        }
    });
}

function detectAntibot() {
    const doc = getIframeDoc('previewFrame');
    if (!doc) {
        alert('é¡µé¢æœªåŠ è½½');
        return;
    }

    const analysis = analyzeAntibotMeasures(doc);
    displayAntibotAnalysis(analysis);
}

function analyzeAntibotMeasures(doc) {
    const analysis = {
        hasCloudflare: false,
        hasCaptcha: false,
        hasRateLimit: false,
        hasJSChallenge: false,
        suggestions: []
    };

    // æ£€æµ‹Cloudflare
    if (doc.querySelector('.cf-browser-verification') ||
        doc.title.includes('Just a moment') ||
        doc.body.textContent.includes('Cloudflare')) {
        analysis.hasCloudflare = true;
        analysis.suggestions.push('ä½¿ç”¨éšèº«æ¨¡å¼åŠ è½½ç­–ç•¥');
    }

    // æ£€æµ‹éªŒè¯ç 
    if (doc.querySelector('[class*="captcha"], [id*="captcha"], iframe[src*="recaptcha"]')) {
        analysis.hasCaptcha = true;
        analysis.suggestions.push('éœ€è¦äººå·¥å¤„ç†éªŒè¯ç ');
    }

    // æ£€æµ‹é€Ÿç‡é™åˆ¶
    const bodyText = doc.body.textContent.toLowerCase();
    if (bodyText.includes('rate limit') || bodyText.includes('too many requests')) {
        analysis.hasRateLimit = true;
        analysis.suggestions.push('å¢åŠ è¯·æ±‚å»¶è¿Ÿï¼Œä½¿ç”¨ä»£ç†æ± ');
    }

    // æ£€æµ‹JavaScriptæŒ‘æˆ˜
    if (bodyText.includes('javascript') && bodyText.includes('enable')) {
        analysis.hasJSChallenge = true;
        analysis.suggestions.push('ä½¿ç”¨æµè§ˆå™¨æ¸²æŸ“æ¨¡å¼');
    }

    return analysis;
}

function suggestAntibotStrategy() {
    // è‡ªåŠ¨è°ƒæ•´é…ç½®ä»¥ç»•è¿‡åçˆ¬
    document.querySelector('[name="load_strategy"]').value = 'stealth';
    document.querySelector('[name="wait_ms"]').value = '3000';
    document.getElementById('useProxy').checked = true;
    document.getElementById('rotateUA').checked = true;
    updateLoadStrategyIndicator();
}

function switchLoadStrategy() {
    const currentStrategy = document.querySelector('[name="load_strategy"]').value;
    const strategies = ['static', 'dynamic', 'stealth'];
    const currentIndex = strategies.indexOf(currentStrategy);
    const nextIndex = (currentIndex + 1) % strategies.length;

    document.querySelector('[name="load_strategy"]').value = strategies[nextIndex];
    updateLoadStrategyIndicator();

    // é‡æ–°åŠ è½½é¢„è§ˆ
    reloadPreview();

    // æ˜¾ç¤ºæç¤º
    const strategyNames = {
        'static': 'é™æ€HTML',
        'dynamic': 'æµè§ˆå™¨æ¸²æŸ“',
        'stealth': 'éšèº«æ¨¡å¼'
    };

    showNotification(`å·²åˆ‡æ¢åˆ°: ${strategyNames[strategies[nextIndex]]}`, 'info');
}

function updateLoadStrategyIndicator() {
    const strategy = document.querySelector('[name="load_strategy"]').value;
    const indicator = document.getElementById('loadStrategyIndicator');

    const strategyNames = {
        'static': 'é™æ€HTML',
        'dynamic': 'æµè§ˆå™¨æ¸²æŸ“',
        'stealth': 'éšèº«æ¨¡å¼'
    };

    const strategyColors = {
        'static': '#28a745',
        'dynamic': '#ffc107',
        'stealth': '#dc3545'
    };

    indicator.textContent = strategyNames[strategy] || strategy;
    indicator.style.backgroundColor = strategyColors[strategy] || '#6c757d';
}

// ==================== å·¥å…·å‡½æ•° ====================
function getIframeDoc(frameId = 'previewFrame') {
    const iframe = document.getElementById(frameId);
    try {
        return iframe?.contentDocument || iframe?.contentWindow?.document;
    } catch(e) {
        console.warn('æ— æ³•è®¿é—®iframeå†…å®¹ï¼Œå¯èƒ½æ˜¯è·¨åŸŸé™åˆ¶');
        return null;
    }
}

function generateStableSelector(element) {
    if (!element || element === element.ownerDocument.body) return '';

    // ä¼˜å…ˆä½¿ç”¨ID
    if (element.id && !/\d{4,}/.test(element.id)) {
        return '#' + CSS.escape(element.id);
    }

    const tagName = element.tagName.toLowerCase();

    // æŸ¥æ‰¾æœ€æœ‰æ„ä¹‰çš„ç±»å
    const meaningfulClasses = Array.from(element.classList || [])
        .filter(cls => {
            // è¿‡æ»¤æ‰æ— æ„ä¹‰çš„ç±»å
            return cls &&
                   !cls.startsWith('__') &&
                   !cls.startsWith('picker-') &&
                   cls.length > 2 &&
                   !/\d{3,}/.test(cls) &&
                   !['selectionShareable'].includes(cls);  // è¿‡æ»¤æ‰è¿™ç§é€šç”¨ç±»
        })
        .slice(0, 2);  // æœ€å¤šå–2ä¸ªç±»

    let selector = tagName;
    if (meaningfulClasses.length > 0) {
        selector += '.' + meaningfulClasses.join('.');
    }

    // éªŒè¯å”¯ä¸€æ€§ï¼Œå¦‚æœä¸å”¯ä¸€ï¼Œå°è¯•ç®€åŒ–çš„çˆ¶çº§é€‰æ‹©å™¨
    try {
        const matches = element.ownerDocument.querySelectorAll(selector);
        if (matches.length === 1) {
            return selector;
        }

        // å¦‚æœä¸å”¯ä¸€ï¼Œå°è¯•æ·»åŠ ç›´æ¥çˆ¶å…ƒç´ çš„ä¸€ä¸ªå…³é”®ç±»
        if (element.parentElement && matches.length > 1) {
            const parent = element.parentElement;
            const parentClasses = Array.from(parent.classList || [])
                .filter(cls => {
                    return cls &&
                           cls.length > 3 &&
                           !/\d{3,}/.test(cls) &&
                           !['selectionShareable'].includes(cls) &&
                           /wrapper|container|content|item|card/.test(cls);
                });

            if (parentClasses.length > 0) {
                const parentSelector = parent.tagName.toLowerCase() + '.' + parentClasses[0];
                const combinedSelector = `${parentSelector} > ${selector}`;

                // éªŒè¯ç»„åˆé€‰æ‹©å™¨
                const combinedMatches = element.ownerDocument.querySelectorAll(combinedSelector);
                if (combinedMatches.length === 1) {
                    return combinedSelector;
                }
            }
        }

        // å¦‚æœè¿˜æ˜¯ä¸å”¯ä¸€ï¼Œä½¿ç”¨nth-child
        if (element.parentElement) {
            const siblings = Array.from(element.parentElement.children)
                .filter(el => el.tagName === element.tagName);
            if (siblings.length > 1) {
                const index = siblings.indexOf(element) + 1;
                return `${selector}:nth-of-type(${index})`;
            }
        }
    } catch (e) {
        console.warn('é€‰æ‹©å™¨ç”Ÿæˆé”™è¯¯:', e);
    }

    return selector;
}

function ensureHighlightCSS(doc) {
    if (!doc || doc.getElementById('picker-highlight-style')) return;

    const style = doc.createElement('style');
    style.id = 'picker-highlight-style';
    style.textContent = `
        .__picker_hover__ {
            outline: 3px solid #0d6efd !important;
            background: rgba(13,110,253,0.2) !important;
            position: relative !important;
            z-index: 9999 !important;
        }
        .__picker_selected__ {
            outline: 4px solid #dc3545 !important;
            background: rgba(220,53,69,0.2) !important;
            position: relative !important;
            z-index: 9999 !important;
        }
        .__picker_container__ {
            outline: 3px solid #198754 !important;
            background: rgba(25,135,84,0.15) !important;
            position: relative !important;
            z-index: 9998 !important;
        }
        .__picker_excluded__ {
            outline: 2px dashed #ffc107 !important;
            opacity: 0.5 !important;
        }
    `;
    doc.head.appendChild(style);
}

function clearHighlights(doc) {
    if (!doc) return;
    ['__picker_hover__', '__picker_selected__', '__picker_container__', '__picker_excluded__']
        .forEach(cls => {
            doc.querySelectorAll('.' + cls).forEach(el => el.classList.remove(cls));
        });
}

function highlightElement(element, className = '__picker_hover__') {
    if (element) element.classList.add(className);
}

function showStatus(message, type = 'info') {
    const banner = document.getElementById('statusBanner');
    const messageEl = document.getElementById('statusMessage');

    if (!banner || !messageEl) return;

    banner.className = `alert alert-${type} position-fixed top-50 start-50 translate-middle`;
    messageEl.innerHTML = message;
    banner.classList.remove('d-none');

    if (type === 'success') {
        setTimeout(() => banner.classList.add('d-none'), 3000);
    }
}

function updateStatus(message, type = 'info') {
    const instructions = document.getElementById('pickerInstructions');
    if (instructions) {
        instructions.textContent = message;
        instructions.className = `text-${type === 'success' ? 'success' : 'muted'}`;
    }
}

function updateSelectorDisplay(selector) {
    document.getElementById('selectorValue').textContent = selector || 'æœªé€‰æ‹©';
}

function showNotification(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
    alertDiv.style.zIndex = '10000';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);

    setTimeout(() => alertDiv.remove(), 5000);
}

// ==================== å†…å®¹é¢„è§ˆåŠŸèƒ½ ====================
function showContentPreview(items) {
    const previewDiv = document.getElementById('contentPreview');
    const previewItems = document.getElementById('previewItems');

    if (!items || items.length === 0) {
        previewDiv.classList.add('d-none');
        return;
    }

    let html = '';
    items.forEach((item, index) => {
        let content = '';
        if (item.type === 'text') {
            content = `<div class="small"><strong>æ–‡æœ¬:</strong> ${item.content}</div>`;
        } else if (item.type === 'link') {
            content = `<div class="small"><strong>é“¾æ¥:</strong> <a href="${item.href}" target="_blank">${item.content}</a></div>`;
        } else if (item.type === 'date') {
            content = `<div class="small"><strong>æ—¥æœŸ:</strong> ${item.content}</div>`;
        }

        html += `
            <div class="preview-item">
                ${content}
                <code class="small text-muted d-block mt-1">${item.selector}</code>
            </div>
        `;
    });

    previewItems.innerHTML = html;
    previewDiv.classList.remove('d-none');
}

// ==================== æµ‹è¯•å’Œä¿å­˜åŠŸèƒ½ ====================
async function testConfiguration() {
    const form = document.getElementById('recipeForm');
    const formData = new FormData(form);
    formData.append('limit', document.getElementById('testLimit').value);

    const spinner = document.getElementById('testSpinner');
    spinner.classList.remove('d-none');

    try {
        const response = await fetch('/api/sources/test_preview_enhanced', {
            method: 'POST',
            body: formData
        });

        const html = await response.text();
        document.getElementById('testResult').innerHTML = html;
    } catch (error) {
        document.getElementById('testResult').innerHTML =
            `<div class="alert alert-danger">æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
    } finally {
        spinner.classList.add('d-none');
    }
}

async function saveConfiguration() {
    const form = document.getElementById('recipeForm');
    const formData = new FormData(form);

    // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰pagination_modeï¼Œå¦‚æœæ²¡æœ‰æ‰æ·»åŠ 
    if (!formData.has('pagination_mode')) {
        const paginationMode = document.getElementById('paginationMode').value;
        formData.append('pagination_mode', paginationMode);
        console.log('æ·»åŠ åˆ†é¡µæ¨¡å¼åˆ°è¡¨å•æ•°æ®:', paginationMode);
    } else {
        console.log('è¡¨å•æ•°æ®ä¸­å·²åŒ…å«pagination_mode:', formData.get('pagination_mode'));
    }

    // å¤„ç†æ•°å­—åˆ†é¡µç›¸å…³å­—æ®µ
    const paginationMode = document.getElementById('paginationMode').value;
    if (paginationMode === 'number') {
        const pagePattern = document.getElementById('pagePattern').value.trim();
        const drupalZeroBased = document.getElementById('drupalZeroBased').checked;

        if (pagePattern) {
            formData.set('page_pattern', pagePattern);
        }
        formData.set('drupal_zero_based', drupalZeroBased ? 'true' : 'false');

        console.log('æ•°å­—åˆ†é¡µé…ç½®:', {
            page_pattern: pagePattern,
            drupal_zero_based: drupalZeroBased
        });
    }

    // å¤„ç†æ ‡é¢˜æ’é™¤é€‰é¡¹
    if (document.getElementById('titleExcludeSmall') && document.getElementById('titleExcludeSmall').checked) {
        formData.set('title_exclude_small', 'true');
    }

    const spinner = document.getElementById('saveSpinner');
    spinner.classList.remove('d-none');

    try {
        const response = await fetch('/api/sources/manual_enhanced', {
            method: 'POST',
            body: formData
        });

        const html = await response.text();
        document.getElementById('saveFeedback').innerHTML = html;

        // å¦‚æœä¿å­˜æˆåŠŸï¼Œæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        if (response.ok && html.includes('alert-success')) {
            showNotification('é…ç½®ä¿å­˜æˆåŠŸï¼', 'success');
        }
    } catch (error) {
        console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
        document.getElementById('saveFeedback').innerHTML =
            `<div class="alert alert-danger">ä¿å­˜å¤±è´¥: ${error.message}</div>`;
    } finally {
        spinner.classList.add('d-none');
    }
}

function reloadPreview() {
    const iframe = document.getElementById('previewFrame');
    const url = document.getElementById('startUrl').value.trim();
    const strategy = document.querySelector('[name="load_strategy"]').value;

    if (url) {
        const proxyUrl = strategy === 'dynamic' ?
            `/proxy_dynamic?url=${encodeURIComponent(url)}` :
            `/proxy?url=${encodeURIComponent(url)}`;
        iframe.src = proxyUrl;
    }
}

function closePicker() {
    const doc = getIframeDoc('pickerFrame');
    if (doc) {
        clearHighlights(doc);
    }

    appState.pickerActive = false;
    appState.selectedElements = [];
    appState.step = 0;

    const modal = bootstrap.Modal.getInstance(document.getElementById('pickerModal'));
    if (modal) modal.hide();
}

// åˆ›å»ºé¢„è§ˆæ¨¡æ€æ¡†ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
function createPreviewModal() {
    const modalHtml = `
        <div class="modal fade" id="previewModal" tabindex="-1">
            <div class="modal-dialog modal-xl modal-fullscreen-lg-down">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">é¡µé¢é¢„è§ˆ</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-0" style="height: 85vh;">
                    </div>
                </div>
            </div>
        </div>
    `;

    const div = document.createElement('div');
    div.innerHTML = modalHtml;
    document.body.appendChild(div.firstElementChild);

    return document.getElementById('previewModal');
}

// åˆå§‹åŒ–åˆ†é¡µæ¨¡å¼
function initializePaginationMode() {
    const mode = document.getElementById('paginationMode').value;
    switchPaginationMode();
}

// ç¡®è®¤é€‰æ‹©å™¨å¹¶åº”ç”¨åˆ°è¡¨å•
document.getElementById('confirmPicker').addEventListener('click', function() {
    const selector = document.getElementById('selectorValue').textContent;
    if (selector && selector !== 'æœªé€‰æ‹©') {
        const inputMap = {
            'list': 'listSelector',
            'title': 'titleSelector',
            'link': 'linkSelector',
            'date': 'dateSelector',
            'next_page': 'nextPageSelector'
        };

        const inputId = inputMap[appState.currentField];
        if (inputId) {
            document.getElementById(inputId).value = selector;
        }

        closePicker();
    }
});

// é”®ç›˜å¿«æ·é”®
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        if (appState.pickerActive) closePicker();
    }
});
// ==================== æ›´æ™ºèƒ½çš„URLæ¨¡å¼è‡ªåŠ¨æ£€æµ‹ ====================
function autoDetectUrlPattern() {
    const startUrl = document.getElementById('startUrl').value.trim();
    if (!startUrl) {
        alert('è¯·å…ˆè®¾ç½®èµ·å§‹URL');
        return;
    }

    try {
        const url = new URL(startUrl);
        const params = new URLSearchParams(url.search);

        // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰pageå‚æ•°
        if (params.has('page')) {
            showNotification('URLä¸­å·²åŒ…å«pageå‚æ•°ï¼Œè¯·æ‰‹åŠ¨è®¾ç½®æ¨¡å¼', 'warning');
            return;
        }

        // è‡ªåŠ¨ç”ŸæˆURLæ¨¡å¼
        params.set('page', '{n}');
        let pattern = `${url.origin}${url.pathname}?${params.toString()}`;

        // ä¿®å¤ç¼–ç é—®é¢˜
        pattern = pattern.replace(/%7Bn%7D/g, '{n}');

        document.getElementById('pagePattern').value = pattern;
        showNotification('å·²è‡ªåŠ¨ç”ŸæˆURLæ¨¡å¼', 'success');

    } catch (error) {
        showNotification(`URLè§£æå¤±è´¥: ${error.message}`, 'danger');
    }
}
</script>
{% endblock %}