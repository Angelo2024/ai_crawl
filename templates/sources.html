{% extends "_base.html" %}
{% block title %}信息源列表 - IntelliScraper{% endblock %}

{% block content %}
<div class="container-fluid">

  <div class="card mb-3">
    <div class="card-body">
      <h5 class="card-title mb-3">添加新源</h5>
      <div class="input-group">
        <input id="sourceUrlInput" type="url" class="form-control" placeholder="输入新闻列表页的 URL">
        <button class="btn btn-primary" onclick="addNewSource()">
          配置
        </button>
      </div>
      <div class="form-text mt-2">点击"配置"进入统一配置页。</div>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="card-title mb-0">
          已保存的信息源
          <span class="badge bg-secondary ms-2" id="sourceCount">{{ sources|length if sources else 0 }}</span>
        </h5>
        <button class="btn btn-outline-secondary btn-sm" onclick="window.location.reload()">
          <i class="bi bi-arrow-clockwise"></i> 刷新
        </button>
      </div>

      <!-- 搜索和筛选表单 -->
      <div class="search-form bg-light rounded p-3 mb-4">
        <div class="row g-2">
          <div class="col-md-4">
            <input type="search" id="searchInput" class="form-control"
                   placeholder="按域名搜索..." onkeyup="filterAndRenderTable()">
          </div>
          <div class="col-md-3">
            <select id="topicFilter" class="form-select" onchange="filterAndRenderTable()">
              <option value="">所有议题</option>
              {% for topic in all_topics|default([]) %}
                <option value="{{ topic.name }}">{{ topic.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2">
            <select id="pageSize" class="form-select" onchange="changePageSize()">
              <option value="10">10条/页</option>
              <option value="20" selected>20条/页</option>
              <option value="50">50条/页</option>
              <option value="100">显示全部</option>
            </select>
          </div>
          <div class="col-md-3">
            <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
              <i class="bi bi-x-circle"></i> 清除筛选
            </button>
          </div>
        </div>
      </div>

      <!-- 表格 -->
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th style="width: 80px;" class="sortable-header" data-field="id">
                <div class="d-flex align-items-center justify-content-between">
                  <span>ID</span>
                  <i class="bi bi-chevron-expand sort-icon"></i>
                </div>
              </th>
              <th class="sortable-header" data-field="domain">
                <div class="d-flex align-items-center justify-content-between">
                  <span>域名</span>
                  <i class="bi bi-chevron-expand sort-icon"></i>
                </div>
              </th>
              <th>议题</th>
              <th style="width: 200px;" class="sortable-header" data-field="updated_at">
                <div class="d-flex align-items-center justify-content-between">
                  <span>更新时间</span>
                  <i class="bi bi-chevron-expand sort-icon"></i>
                </div>
              </th>
              <th style="width: 300px;">操作</th>
            </tr>
          </thead>
          <tbody id="sourcesTableBody">
            <!-- 表格内容将通过JavaScript渲染 -->
          </tbody>
        </table>
      </div>

      <!-- 分页信息和控件 -->
      <div class="d-flex justify-content-between align-items-center mt-4">
        <div class="text-muted small" id="pageInfo">
          <!-- 分页信息 -->
        </div>
        <nav aria-label="页面导航">
          <ul class="pagination pagination-sm mb-0" id="pagination">
            <!-- 分页按钮 -->
          </ul>
        </nav>
      </div>

    </div>
  </div>
</div>

<!-- 原有的模态框保持不变 -->
<div class="modal fade" id="testModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title">测试结果</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="testModalBody">
        <div class="text-muted small">正在加载测试结果...</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="topicsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">管理议题标签</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="topicsModalBody">
        <div class="text-center py-4">
          <div class="spinner-border text-primary"></div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.sortable-header {
    cursor: pointer;
    user-select: none;
    transition: all 0.2s ease;
    padding: 0.75rem;
}

.sortable-header:hover {
    background-color: rgba(13, 110, 253, 0.1);
}

.sort-icon {
    font-size: 1.1em;
    transition: all 0.2s ease;
    opacity: 0.5;
    margin-left: 8px;
}

.sortable-header:hover .sort-icon {
    opacity: 0.8;
}

.sort-icon.active {
    opacity: 1;
    color: #0d6efd;
    font-weight: bold;
}

.sort-icon.desc {
    transform: rotate(180deg);
}
</style>

<script>
// 从服务器传递的数据
let allSourcesData = {{ sources|tojson if sources else '[]' }};
let currentSort = { field: 'id', order: 'asc' };
let currentFilters = { search: '', topic: '' };
let currentPage = 1;
let pageSize = 20;

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    initializeSortHandlers();
    filterAndRenderTable();
});

// 初始化排序处理器
function initializeSortHandlers() {
    const sortableHeaders = document.querySelectorAll('.sortable-header');
    sortableHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const field = this.dataset.field;
            sortTable(field);
        });
    });
}

// 排序表格
function sortTable(field) {
    if (currentSort.field === field) {
        currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.field = field;
        currentSort.order = 'asc';
    }
    updateSortIcons();
    filterAndRenderTable();
}

// 更新排序图标
function updateSortIcons() {
    const sortIcons = document.querySelectorAll('.sort-icon');
    sortIcons.forEach(icon => {
        icon.className = 'bi bi-chevron-expand sort-icon';
    });

    const activeHeader = document.querySelector(`[data-field="${currentSort.field}"]`);
    if (activeHeader) {
        const icon = activeHeader.querySelector('.sort-icon');
        if (currentSort.order === 'asc') {
            icon.className = 'bi bi-chevron-up sort-icon active';
        } else {
            icon.className = 'bi bi-chevron-down sort-icon active desc';
        }
    }
}

// 过滤和渲染表格
function filterAndRenderTable() {
    const searchValue = document.getElementById('searchInput').value.toLowerCase();
    const topicValue = document.getElementById('topicFilter').value;

    currentFilters = { search: searchValue, topic: topicValue };
    currentPage = 1; // 重置到第一页
    renderTable();
}

// 清除过滤器
function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('topicFilter').value = '';
    currentFilters = { search: '', topic: '' };
    currentPage = 1;
    renderTable();
}

// 改变每页大小
function changePageSize() {
    pageSize = parseInt(document.getElementById('pageSize').value);
    currentPage = 1;
    renderTable();
}

// 获取过滤和排序后的数据
function getFilteredAndSortedData() {
    let filtered = allSourcesData.filter(source => {
        const matchesSearch = !currentFilters.search ||
            source.domain.toLowerCase().includes(currentFilters.search);

        let matchesTopic = true;
        if (currentFilters.topic) {
            matchesTopic = source.topics && source.topics.some(topic =>
                topic.name === currentFilters.topic
            );
        }

        return matchesSearch && matchesTopic;
    });

    // 排序
    filtered.sort((a, b) => {
        let aVal = a[currentSort.field];
        let bVal = b[currentSort.field];

        if (currentSort.field === 'updated_at') {
            aVal = aVal ? new Date(aVal) : new Date(0);
            bVal = bVal ? new Date(bVal) : new Date(0);
        } else if (typeof aVal === 'string') {
            aVal = aVal.toLowerCase();
            bVal = bVal ? bVal.toLowerCase() : '';
        }

        if (aVal < bVal) return currentSort.order === 'asc' ? -1 : 1;
        if (aVal > bVal) return currentSort.order === 'asc' ? 1 : -1;
        return 0;
    });

    return filtered;
}

// 渲染表格
function renderTable() {
    const filteredData = getFilteredAndSortedData();
    const tbody = document.getElementById('sourcesTableBody');

    if (filteredData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted py-4">
                    ${currentFilters.search || currentFilters.topic ?
                        '没有找到匹配的数据。<a href="#" onclick="clearFilters()" class="ms-2">清除筛选</a>' :
                        '没有数据 (请点击上方"配置"添加)'
                    }
                </td>
            </tr>
        `;
        document.getElementById('pageInfo').textContent = '';
        document.getElementById('pagination').innerHTML = '';
        updateSourceCount(0);
        return;
    }

    // 分页逻辑
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = pageSize === 100 ? filteredData.length : startIndex + pageSize;
    const pageData = filteredData.slice(startIndex, endIndex);

    tbody.innerHTML = pageData.map(source => {
        const topicsHtml = source.topics && source.topics.length > 0 ?
            source.topics.map(topic =>
                `<span class="badge bg-secondary fw-normal me-1">${topic.name || topic}</span>`
            ).join('') :
            '<span class="text-muted small">--</span>';

        const updatedAt = source.updated_at ?
            new Date(source.updated_at).toLocaleString('zh-CN', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            }) : '--';

        return `
            <tr id="source-row-${source.id}">
                <td>${source.id}</td>
                <td>
                    <a href="${source.start_url || ('https://' + source.domain)}"
                       target="_blank" class="fw-semibold text-decoration-none">
                        <i class="bi bi-globe me-1"></i>
                        ${source.domain}
                    </a>
                </td>
                <td>${topicsHtml}</td>
                <td><small class="text-muted">${updatedAt}</small></td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <a href="/sources/${source.id}/edit" class="btn btn-outline-secondary">
                            <i class="bi bi-pencil-square"></i> 编辑
                        </a>
                        <button class="btn btn-outline-primary" onclick="openTopicsModal(${source.id})">
                            <i class="bi bi-tags"></i> 议题
                        </button>
                        <button class="btn btn-outline-info" onclick="testSource(${source.id})">
                            <i class="bi bi-play-circle"></i> 测试
                        </button>
                        <button class="btn btn-outline-success" onclick="toggleConfig(${source.id})">
                            <i class="bi bi-file-code"></i> 配置
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteSource(${source.id}, '${source.domain}')">
                            <i class="bi bi-trash"></i> 删除
                        </button>
                    </div>
                </td>
            </tr>
            <tr id="config-row-${source.id}" style="display: none;">
                <td colspan="5">
                    <div id="config-${source.id}" class="p-2 bg-light rounded small">
                        <div class="text-center">
                            <button class="btn btn-sm btn-primary" onclick="loadConfig(${source.id})">
                                <i class="bi bi-gear"></i> 加载配置详情
                            </button>
                        </div>
                    </div>
                </td>
            </tr>
        `;
    }).join('');

    updatePagination(filteredData.length);
    updateSourceCount(filteredData.length);
}

// 更新分页
function updatePagination(totalCount) {
    if (pageSize === 100) {
        document.getElementById('pagination').innerHTML = '';
        updatePageInfo(totalCount, 1, totalCount);
        return;
    }

    const totalPages = Math.ceil(totalCount / pageSize);
    const pagination = document.getElementById('pagination');

    if (totalPages <= 1) {
        pagination.innerHTML = '';
        updatePageInfo(totalCount, 1, Math.min(pageSize, totalCount));
        return;
    }

    let paginationHtml = '';

    // 上一页
    paginationHtml += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="goToPage(${currentPage - 1})">上一页</a>
        </li>
    `;

    // 页码按钮
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            paginationHtml += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="goToPage(${i})">${i}</a>
                </li>
            `;
        } else if (i === 2 || i === totalPages - 1) {
            paginationHtml += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
    }

    // 下一页
    paginationHtml += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="goToPage(${currentPage + 1})">下一页</a>
        </li>
    `;

    pagination.innerHTML = paginationHtml;

    const startItem = (currentPage - 1) * pageSize + 1;
    const endItem = Math.min(currentPage * pageSize, totalCount);
    updatePageInfo(totalCount, startItem, endItem);
}

// 更新分页信息
function updatePageInfo(total, start, end) {
    const pageInfo = document.getElementById('pageInfo');
    if (pageInfo) {
        pageInfo.textContent = `显示 ${start}-${end} 条，共 ${total} 条记录`;
    }
}

// 跳转到指定页面
function goToPage(page) {
    const filteredData = getFilteredAndSortedData();
    const totalPages = Math.ceil(filteredData.length / pageSize);

    if (page < 1 || page > totalPages) return;

    currentPage = page;
    renderTable();
}

// 更新源计数
function updateSourceCount(count = null) {
    const countElement = document.getElementById('sourceCount');
    if (countElement) {
        countElement.textContent = count !== null ? count : allSourcesData.length;
    }
}

// 保持原有的其他函数
function addNewSource() {
    const urlInput = document.getElementById('sourceUrlInput');
    const url = urlInput ? urlInput.value.trim() : '';
    if (url) {
        if (isValidURL(url)) {
            window.location.href = `/sources/manual?url=${encodeURIComponent(url)}`;
        } else {
            alert('请输入有效的URL地址');
        }
    } else {
        alert('请输入URL地址');
    }
}

function isValidURL(string) {
    try {
        new URL(string);
        return true;
    } catch (_) {
        return false;
    }
}

function toggleConfig(sourceId) {
    const configRow = document.getElementById(`config-row-${sourceId}`);
    if (configRow) {
        if (configRow.style.display === 'none') {
            configRow.style.display = 'table-row';
        } else {
            configRow.style.display = 'none';
        }
    }
}

async function loadConfig(sourceId) {
    const container = document.getElementById(`config-${sourceId}`);
    if (!container) return;

    container.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm"></div> 加载中...</div>';

    try {
        const response = await fetch(`/api/sources/${sourceId}/config`);
        const html = await response.text();
        container.innerHTML = html;
    } catch (error) {
        container.innerHTML = '<div class="text-danger">加载失败</div>';
    }
}

async function testSource(sourceId) {
    const modal = new bootstrap.Modal(document.getElementById('testModal'));
    const modalBody = document.getElementById('testModalBody');

    modalBody.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div><div class="mt-2">正在测试连接...</div></div>';
    modal.show();

    try {
        const response = await fetch(`/api/sources/${sourceId}/test`, { method: 'POST' });
        const html = await response.text();
        modalBody.innerHTML = html;
    } catch (error) {
        modalBody.innerHTML = '<div class="alert alert-danger">测试失败: ' + error.message + '</div>';
    }
}

async function deleteSource(sourceId, domain) {
    if (!confirm(`确定要删除 ${domain} 吗？`)) {
        return;
    }

    try {
        const response = await fetch(`/api/sources/${sourceId}`, { method: 'DELETE' });
        if (response.ok) {
            // 删除成功，从本地数据中移除并重新渲染
            allSourcesData = allSourcesData.filter(source => source.id !== sourceId);
            renderTable();
        } else {
            alert('删除失败');
        }
    } catch (error) {
        alert('删除失败: ' + error.message);
    }
}

async function openTopicsModal(sourceId) {
    const modal = new bootstrap.Modal(document.getElementById('topicsModal'));
    const modalBody = document.getElementById('topicsModalBody');

    modalBody.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';
    modal.show();

    try {
        const response = await fetch(`/api/sources/${sourceId}/topics-form`);
        const html = await response.text();
        modalBody.innerHTML = html;
    } catch (error) {
        modalBody.innerHTML = '<div class="alert alert-danger">加载失败: ' + error.message + '</div>';
    }
}

// 添加到 sources.html 的 <script> 块中

async function submitTopicsForm(sourceId) {
    const form = document.getElementById('topics-form');
    const saveBtn = document.getElementById('saveTopicsBtn');
    const spinner = saveBtn.querySelector('.spinner-border');
    const feedbackDiv = document.getElementById('topics-form-feedback');
    if (!form || !saveBtn) return;

    // 禁用按钮并显示加载动画
    saveBtn.disabled = true;
    spinner.classList.remove('d-none');
    feedbackDiv.innerHTML = '';

    // 1. 收集所有选中的议题ID
    const formData = new FormData(form);

    try {
        // 2. 将数据发送到后端API (使用FormData可以直接发送)
        const response = await fetch(`/api/sources/${sourceId}/topics`, {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || '保存失败，服务器返回错误。');
        }

        const updatedSource = await response.json();

        // 3. 更新前端JS数据源 (这是关键！)
        const sourceIndex = allSourcesData.findIndex(s => s.id === sourceId);
        if (sourceIndex !== -1) {
            allSourcesData[sourceIndex].topics = updatedSource.topics;
        }

        // 4. 重新渲染整个表格
        renderTable();

        // 5. 关闭模态框
        const modal = bootstrap.Modal.getInstance(document.getElementById('topicsModal'));
        if (modal) {
            modal.hide();
        }

    } catch (error) {
        console.error('更新议题时出错:', error);
        feedbackDiv.innerHTML = `<div class="alert alert-danger small p-2">${error.message}</div>`;
    } finally {
        // 恢复按钮状态
        saveBtn.disabled = false;
        spinner.classList.add('d-none');
    }
}
</script>
{% endblock %}