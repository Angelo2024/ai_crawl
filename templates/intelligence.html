{% extends "_base.html" %}
{% block title %}情报管理中心 - IntelliScraper{% endblock %}
{% block head %}
<style>
/* 主容器样式 */
.intelligence-container {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    min-height: 100vh;
    padding: 20px 0;
}

/* 头部卡片 */
.header-card {
    background: white;
    border-radius: 16px;
    padding: 24px 32px;
    margin-bottom: 24px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
}

.header-title {
    font-size: 28px;
    font-weight: 700;
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 16px;
}

/* 操作按钮组 */
.action-buttons {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.action-buttons .btn {
    min-width: 140px;
    height: 40px;
    border-radius: 8px;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.3s;
    border: none;
}

.action-buttons .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.btn-primary {
    background: linear-gradient(135deg, #667eea, #764ba2);
}

.btn-success {
    background: linear-gradient(135deg, #10b981, #059669);
}

.btn-info {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
}

.btn-warning {
    background: linear-gradient(135deg, #f59e0b, #d97706);
}

/* 筛选面板 */
.filter-section {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06);
}

.filter-section h5 {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 16px;
    color: #374151;
}

.filter-section .form-control,
.filter-section .form-select {
    height: 38px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    font-size: 14px;
}

.filter-section .form-control:focus,
.filter-section .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.filter-section label {
    font-size: 13px;
    font-weight: 500;
    color: #6b7280;
    margin-bottom: 6px;
}

/* 清除筛选按钮样式 */
.clear-filters-btn {
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s;
}

.clear-filters-btn:hover {
    background: #dc2626;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
}

/* 表格容器样式 */
.intelligence-table-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    overflow: hidden;
    margin: 20px 0;
}

.intelligence-table {
    table-layout: fixed;  /* 修复：使用固定布局 */
    width: 100%;
    margin-bottom: 0;
}

.table-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

/* 表格列宽修复 */
.checkbox-col {
    width: 50px;
    min-width: 50px;
}
.title-col {
    width: auto;  /* 修复：让标题列自适应 */
    min-width: 300px;
}
.time-col {
    width: 100px;
    min-width: 100px;
}
.score-col {
    width: 100px;
    min-width: 100px;
}
.status-col {
    width: 130px;
    min-width: 130px;
}
.actions-col {
    width: 200px;
    min-width: 200px;
}

/* 表头样式修复 */
.table th {
    background-color: #f8f9fa !important;
    border-bottom: 2px solid #dee2e6 !important;
    font-weight: 600 !important;
    font-size: 13px !important;
    padding: 12px 8px !important;
    white-space: nowrap !important;
    position: sticky !important;
    top: 0 !important;
    z-index: 10 !important;
}

.table td {
    padding: 12px 8px !important;
    vertical-align: middle !important;
    font-size: 13px !important;
    border-bottom: 1px solid #f0f0f0 !important;
    word-wrap: break-word;  /* 修复：允许文字换行 */
}

/* 批量操作栏修复 - 重点修复换行问题 */
.batch-operations {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef) !important;
    border-bottom: 2px solid #dee2e6 !important;
    padding: 15px 20px !important;
    position: relative !important;
    z-index: 100 !important;
}

.batch-operations .row {
    align-items: center;
    margin: 0;  /* 修复：移除默认margin */
}

.batch-operations .col-md-8,
.batch-operations .col-md-4 {
    padding: 0;  /* 修复：移除默认padding */
}

/* 批量按钮样式修复 - 防止换行 */
.batch-btn {
    border-radius: 6px !important;
    font-weight: 500 !important;
    padding: 6px 12px !important;
    border: 1px solid transparent !important;
    transition: all 0.2s ease !important;
    white-space: nowrap !important;  /* 修复：防止按钮文字换行 */
    margin-right: 8px !important;    /* 修复：统一按钮间距 */
    margin-bottom: 4px !important;   /* 修复：添加底部间距防止换行时重叠 */
    font-size: 13px !important;      /* 修复：稍微减小字体避免换行 */
    display: inline-flex !important; /* 修复：使用flex布局 */
    align-items: center !important;  /* 修复：垂直居中对齐 */
    gap: 4px !important;             /* 修复：图标和文字间距 */
}

.batch-btn:hover {
    transform: translateY(-1px) !important;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15) !important;
}

/* 修复：按钮容器布局 */
.batch-operations .col-md-8 {
    display: flex !important;
    flex-wrap: wrap !important;
    align-items: center !important;
    gap: 0 !important;  /* 使用margin代替gap */
}

.batch-operations .col-md-8 > span {
    margin-right: 12px !important;
    font-weight: 600 !important;
    color: #374151 !important;
    white-space: nowrap !important;
}

/* 操作按钮组修复 */
.btn-group-custom {
    display: flex;
    gap: 3px;
    justify-content: center;
    flex-wrap: nowrap;  /* 修复：防止按钮换行 */
}

.btn-action {
    padding: 4px 8px !important;
    font-size: 12px !important;
    line-height: 1.2 !important;
    border-radius: 4px !important;
    min-width: 32px;
    height: 28px;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    border: 1px solid !important;
    background: white !important;
    transition: all 0.2s ease !important;
    flex-shrink: 0;  /* 修复：防止按钮收缩 */
}

.btn-action:hover {
    transform: translateY(-1px) !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
}

.btn-action i {
    font-size: 12px !important;
    margin: 0 !important;
}

/* 下拉选择框修复 - 重点修复样式问题 */
.status-select {
    font-size: 12px !important;
    padding: 4px 8px !important;
    border: 1px solid #e5e7eb !important;
    border-radius: 4px !important;
    background-color: white !important;
    color: #374151 !important;
    min-width: 100px !important;  /* 修复：确保最小宽度 */
    width: 100% !important;       /* 修复：使用全宽 */
    height: auto !important;      /* 修复：自动高度 */
    appearance: auto !important;  /* 修复：恢复默认外观 */
}

.status-select:focus {
    border-color: #667eea !important;
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1) !important;
    outline: none !important;
}

.status-select option {
    padding: 4px 8px !important;
    font-size: 12px !important;
    color: #374151 !important;
    background-color: white !important;
}

/* 表格行样式 */
.intelligence-row:hover {
    background-color: #f8f9fa !important;
    transition: background-color 0.2s ease !important;
}

.intelligence-row.selected {
    background-color: #e3f2fd !important;
}

.selected-row {
    background-color: #e3f2fd !important;
}

.selected-row:hover {
    background-color: #bbdefb !important;
}

/* AI评分样式 */
.ai-score-badge {
    cursor: help;
    font-size: 11px !important;
    padding: 4px 6px !important;
}

.score-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
}

/* 标题链接样式 */
.intelligence-title-link {
    color: #0d6efd !important;
    text-decoration: none !important;
    font-weight: 600 !important;
}

.intelligence-title-link:hover {
    text-decoration: underline !important;
    color: #0a58ca !important;
}

/* 摘要样式 */
.intelligence-summary {
    line-height: 1.4 !important;
    max-height: 60px !important;
    overflow: hidden !important;
    color: #6c757d !important;
}

/* 标签样式 */
.intelligence-badges .badge {
    font-size: 10px !important;
    padding: 3px 6px !important;
    margin-right: 4px !important;
    border-radius: 4px !important;
}

/* 分页样式修复 */
.pagination .page-link {
    border: 1px solid #e5e7eb !important;
    color: #4f46e5 !important;
    background: white !important;
    cursor: pointer !important;
    padding: 6px 12px !important;
    font-size: 14px !important;
}

.pagination .page-link:hover:not(.disabled) {
    background: #eff6ff !important;
    border-color: #4f46e5 !important;
    color: #4f46e5 !important;
}

.pagination .page-item.active .page-link {
    background: #4f46e5 !important;
    border-color: #4f46e5 !important;
    color: white !important;
}

.pagination .page-item.disabled .page-link,
.pagination .page-link:disabled {
    color: #9ca3af !important;
    cursor: not-allowed !important;
    background: #f9fafb !important;
    opacity: 0.5;
    pointer-events: none;
}

/* 浮动提示样式 */
.floating-alert {
    position: fixed;
    top: 20px;
    right: 20px;
    min-width: 300px;
    max-width: 500px;
    padding: 12px 16px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 10001;
    animation: slideIn 0.3s ease;
}

.floating-alert.fade-out {
    animation: slideOut 0.3s ease;
}

.alert-content {
    display: flex;
    align-items: center;
    gap: 10px;
}

.alert-close {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    margin-left: 12px;
    color: inherit;
    opacity: 0.7;
}

.alert-close:hover {
    opacity: 1;
}

.alert-success {
    background: #10b981;
    color: white;
}

.alert-danger {
    background: #ef4444;
    color: white;
}

.alert-warning {
    background: #f59e0b;
    color: white;
}

.alert-info {
    background: #3b82f6;
    color: white;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

/* 美化AI评分筛选输入框 */
.filter-section .input-group {
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    border-radius: 6px;
    overflow: hidden;
}

.filter-section .input-group-text {
    background: #f9fafb;
    border: none;
    color: #6b7280;
    font-weight: 500;
}

.filter-section .input-group input {
    border: none;
    padding: 8px 12px;
}

.filter-section .input-group input:focus {
    box-shadow: none;
    border-color: #4f46e5;
}

/* 自定义时间范围样式 */
#customTimeRange {
    background: #f9fafb;
    padding: 15px;
    border-radius: 8px;
    margin-top: 15px;
    border: 1px dashed #e5e7eb;
    display: none;
}

/* 改进筛选按钮 */
.filter-section .btn-secondary {
    background: #6b7280;
    border: none;
    transition: all 0.2s;
}

.filter-section .btn-secondary:hover {
    background: #4b5563;
    transform: translateY(-1px);
}

/* 顶部按钮悬浮效果 */
.action-buttons .btn {
    position: relative;
    overflow: hidden;
}

.action-buttons .btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.2);
    transition: left 0.3s;
}

.action-buttons .btn:hover::before {
    left: 100%;
}

/* 议题选择样式 */
.topic-selection-modal {
    max-height: 400px;
    overflow-y: auto;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 8px;
}

.topic-item-modal {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    margin-bottom: 8px;
    background: white;
    border-radius: 8px;
    border: 2px solid transparent;
    cursor: pointer;
    transition: all 0.2s;
}

.topic-item-modal:hover {
    border-color: #667eea;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
}

.topic-item-modal.selected {
    border-color: #667eea;
    background: #eff6ff;
}

.topic-name-modal {
    font-weight: 600;
    color: #333;
}

.topic-badge-modal {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    margin-left: auto;
}

.select-all-bar {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 12px 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.crawling-indicator {
    display: none;
    text-align: center;
    padding: 30px;
}

.crawling-indicator.active {
    display: block;
}

/* 改进的议题选择器样式 */
.topic-selector-container {
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 12px;
    background: #f9fafb;
    max-height: 200px;
    overflow-y: auto;
}

.topic-selector-item {
    padding: 8px 12px;
    margin-bottom: 8px;
    background: white;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
    transition: all 0.2s;
}

.topic-selector-item:hover {
    border-color: #667eea;
    box-shadow: 0 2px 4px rgba(102, 126, 234, 0.1);
}

.topic-selector-item .form-check-input:checked {
    background-color: #667eea;
    border-color: #667eea;
}

/* 合并功能样式 */
.merge-section {
    background: #f0f9ff;
    border: 2px solid #0ea5e9;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
}

.merge-url-input {
    border: 2px solid #0ea5e9;
    border-radius: 6px;
    padding: 10px;
    font-size: 14px;
}

.merge-url-input:focus {
    box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
    border-color: #0284c7;
}

/* Tooltip样式改进 */
.tooltip {
    font-size: 12px !important;
    z-index: 10002 !important;
    max-width: 350px !important;
}

.tooltip-inner {
    max-width: 350px !important;
    text-align: left !important;
    white-space: pre-line !important;
    padding: 8px 12px !important;
    line-height: 1.4 !important;
}

/* 确保按钮不会被挤压 */
.actions-col .btn-group-custom {
    min-width: 140px;
    justify-content: center;
}

/* 移动端适配 */
@media (max-width: 768px) {
    .intelligence-table {
        min-width: 900px;  /* 确保移动端有横向滚动 */
    }

    .title-col {
        min-width: 250px;
    }

    .actions-col {
        width: 180px;
        min-width: 180px;
    }

    .btn-action {
        padding: 3px 6px !important;
        font-size: 11px !important;
        min-width: 28px;
        height: 24px;
    }

    /* 修复：移动端批量按钮自动换行 */
    .batch-operations .col-md-8 {
        flex-direction: row !important;
        flex-wrap: wrap !important;
        justify-content: flex-start !important;
    }

    .batch-btn {
        font-size: 12px !important;
        padding: 5px 8px !important;
        margin-bottom: 6px !important;
    }
}

/* 修复Bootstrap组件冲突 */
.modal {
    z-index: 10000 !important;
}

.modal-backdrop {
    z-index: 9998 !important;
}

/* 确保所有图标正确显示 */
i.bi {
    font-family: "Bootstrap Icons" !important;
    font-style: normal !important;
    font-variant: normal !important;
    text-transform: none !important;
    line-height: 1 !important;
    vertical-align: -.125em !important;
    -webkit-font-smoothing: antialiased !important;
    -moz-osx-font-smoothing: grayscale !important;
}

/* 空状态样式 */
.empty-state {
    padding: 60px 20px;
    color: #6b7280;
}

.empty-state i {
    font-size: 4rem;
    color: #d1d5db;
    margin-bottom: 1rem;
}

/* 内联编辑样式 */
.topic-edit-input {
    display: none;
    position: absolute;
    background: white;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 5px;
    z-index: 1000;
}

</style>
{% endblock %}

{% block content %}
<div class="container-fluid intelligence-container">
    <div class="container">
        <!-- 页面标题和操作按钮 -->
        <div class="header-card">
            <h1 class="header-title">
                <i class="bi bi-shield-check"></i> 情报管理中心
            </h1>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openCrawlModal()">
                    <i class="bi bi-cloud-download"></i> 智能爬取
                </button>
                <button class="btn btn-info" onclick="openStatistics()">
                    <i class="bi bi-graph-up"></i> 数据统计
                </button>
                <button class="btn btn-warning" onclick="openSettings()">
                    <i class="bi bi-gear"></i> 系统设置
                </button>
                <button class="btn btn-success" onclick="batchScoreAll()">
                    <i class="bi bi-robot"></i> 全部AI评分
                </button>
                <button class="btn btn-warning" onclick="openDateExtractionModal()">
                    <i class="bi bi-calendar-plus"></i> 日期补全
                </button>
            </div>
        </div>
        <!-- 日期提取模态框 -->
        <div class="modal fade" id="dateExtractionModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-warning text-dark">
                        <h5 class="modal-title">
                            <i class="bi bi-calendar-plus"></i> 批量日期补全
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            系统将自动为缺少发布日期的情报从原文链接中提取日期信息
                        </div>

                        <div class="mb-3">
                            <label class="form-label">筛选条件</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="dateExtractionTopic"
                                           placeholder="按议题筛选（可选）">
                                </div>
                                <div class="col-md-6">
                                    <select class="form-select" id="dateExtractionLimit">
                                        <option value="50">处理50条</option>
                                        <option value="100" selected>处理100条</option>
                                        <option value="200">处理200条</option>
                                        <option value="500">处理500条</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <button type="button" class="btn btn-outline-primary" onclick="previewMissingDates()">
                                <i class="bi bi-eye"></i> 预览缺少日期的文章
                            </button>
                        </div>

                        <div id="missingDatesPreview" style="display: none;">
                            <h6>缺少日期的文章预览：</h6>
                            <div id="missingDatesList" class="list-group mb-3" style="max-height: 300px; overflow-y: auto;">
                                <!-- 动态填充 -->
                            </div>
                        </div>

                        <!-- 处理进度 -->
                        <div id="dateExtractionProgress" class="mt-3" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="mt-2">
                                <small id="dateExtractionStatus">准备开始...</small>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                        <button type="button" class="btn btn-primary" id="testDateExtractionBtn" onclick="testDateExtraction()">
                            <i class="bi bi-flask"></i> 测试提取
                        </button>
                        <button type="button" class="btn btn-success" id="startDateExtractionBtn" onclick="startDateExtraction()">
                            <i class="bi bi-play-circle"></i> 开始日期补全
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- 筛选面板 -->
        <div class="filter-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5><i class="bi bi-funnel"></i> 筛选条件</h5>
                <button type="button" class="clear-filters-btn" onclick="clearAllFilters()">
                    <i class="bi bi-x-circle"></i> 清除所有筛选
                </button>
            </div>

            <form id="filterForm">
                <div class="row g-3">
                    <div class="col-md-2">
                        <label class="form-label">标题关键词</label>
                        <input type="text" class="form-control" name="title" placeholder="搜索标题">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">议题</label>
                        <select class="form-select" name="topic">
                            <option value="">全部议题</option>
                            <option value="测试">测试</option>
                            <option value="wxx">wxx</option>
                            <option value="ESG">ESG</option>
                            <option value="碳中和">碳中和</option>
                            <option value="可持续发展">可持续发展</option>
                            <option value="绿色金融">绿色金融</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">类别</label>
                        <select class="form-select" name="category">
                            <option value="">全部类别</option>
                            <option value="前沿资讯">前沿资讯</option>
                            <option value="政策法规">政策法规</option>
                            <option value="市场动态">市场动态</option>
                            <option value="技术创新">技术创新</option>
                            <option value="行业报告">行业报告</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">审核状态</label>
                        <select class="form-select" name="quality">
                            <option value="">全部状态</option>
                            <option value="pending">待审核</option>
                            <option value="approved">已通过</option>
                            <option value="rejected">已拒绝</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">AI评分</label>
                        <div class="input-group">
                            <input type="number" class="form-control" name="min_score" placeholder="最低" min="0" max="10" step="0.1">
                            <span class="input-group-text">-</span>
                            <input type="number" class="form-control" name="max_score" placeholder="最高" min="0" max="10" step="0.1">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">时间范围</label>
                        <select class="form-select" name="time_range" onchange="toggleCustomTimeRange(this)">
                            <option value="">全部时间</option>
                            <option value="today">今天</option>
                            <option value="yesterday">昨天</option>
                            <option value="week">本周</option>
                            <option value="month">本月</option>
                            <option value="custom">自定义</option>
                        </select>
                    </div>
                </div>

                <!-- 自定义时间范围 -->
                <div id="customTimeRange" class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">开始时间</label>
                        <input type="datetime-local" class="form-control" name="start_date">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">结束时间</label>
                        <input type="datetime-local" class="form-control" name="end_date">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" class="btn btn-secondary w-100" onclick="applyTimeFilter()">
                            <i class="bi bi-check"></i> 应用筛选
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- 合并功能区域 -->
        <div class="merge-section" id="mergeSection" style="display: none;">
            <h6><i class="bi bi-union"></i> 合并情报</h6>
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">通过URL合并</label>
                    <div class="input-group">
                        <input type="url" class="form-control merge-url-input" id="mergeUrl"
                               placeholder="输入新闻链接，系统将查找相同URL的报道并合并">
                        <button class="btn btn-info" onclick="mergeByUrl()">
                            <i class="bi bi-search"></i> 查找并合并
                        </button>
                    </div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">合并选中项</label>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" onclick="openMergeModal()" id="mergeSelectedBtn" disabled>
                            <i class="bi bi-union"></i> 合并选中的 <span id="mergeCount">0</span> 项
                        </button>
                        <button class="btn btn-outline-secondary" onclick="hideMergeSection()">
                            <i class="bi bi-x"></i> 取消
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 情报表格容器 -->
        <div id="intelligenceTableContainer">
            <div class="intelligence-table-container">
                <div class="empty-state text-center py-5">
                    <i class="bi bi-inbox" style="font-size: 48px; color: #dee2e6;"></i>
                    <p class="mt-3 text-muted">正在加载数据...</p>
                </div>
            </div>
        </div>

        <!-- 内联编辑议题输入框 -->
        <div id="topicEditInput" class="topic-edit-input">
            <input type="text" id="topicInput" placeholder="输入议题">
            <button class="btn btn-success btn-sm" onclick="saveTopicEdit()">
                <i class="bi bi-check"></i>
            </button>
            <button class="btn btn-secondary btn-sm" onclick="cancelTopicEdit()">
                <i class="bi bi-x"></i>
            </button>
        </div>
    </div>
</div>

<!-- 爬取设置弹窗 -->
<div class="modal fade" id="crawlModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-cloud-download"></i> 智能爬取设置
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="crawlerForm">
                    <!-- 时间和数量设置 -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="daysBack" class="form-label">时间范围</label>
                            <select class="form-select" id="daysBack" name="days_back" required>
                                <option value="1">最近1天</option>
                                <option value="3">最近3天</option>
                                <option value="7" selected>最近7天</option>
                                <option value="14">最近14天</option>
                                <option value="30">最近30天</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="maxItems" class="form-label">每源最大数量</label>
                            <select class="form-select" id="maxItems" name="max_items_per_source">
                                <option value="10">10条</option>
                                <option value="20" selected>20条</option>
                                <option value="50">50条</option>
                                <option value="100">100条</option>
                                <option value="100">200条</option>
                                <option value="100">300条</option>
                            </select>
                        </div>
                    </div>

                    <!-- 议题选择 -->
                    <div class="mb-3">
                        <label class="form-label">选择议题</label>
                        <div class="select-all-bar">
                            <div>
                                <input type="checkbox" id="selectAllTopics" onchange="toggleAllTopics()">
                                <label for="selectAllTopics">全选所有议题</label>
                            </div>
                            <span class="selected-count" id="selectedTopicCount">已选择 0 个</span>
                        </div>
                        <div id="topicSelectionModal" class="topic-selection-modal">
                            <div class="text-center py-3">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                                <p class="mt-2 mb-0 text-muted">正在加载议题列表...</p>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" name="topic_ids" id="topicIdsInput" value="">
                </form>

                <!-- 爬取进度指示器 -->
                <div id="crawlingIndicator" class="crawling-indicator">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p>正在爬取数据，请稍候...</p>
                    <small class="text-muted">这可能需要几分钟时间</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="startCrawlBtn" onclick="startCrawling()" disabled>
                    开始爬取
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 合并情报弹窗 -->
<div class="modal fade" id="mergeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="bi bi-union"></i> 合并情报
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="mergeForm">
                    <div class="mb-3">
                        <label for="mergedTitle" class="form-label">合并后标题 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="mergedTitle" name="merged_title" required>
                    </div>

                    <div class="mb-3">
                        <label for="mergedSummary" class="form-label">合并后摘要 <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="mergedSummary" name="merged_summary" rows="4" required></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="mergedTopic" class="form-label">议题</label>
                            <input type="text" class="form-control" id="mergedTopic" name="merged_topic">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="mergedCategory" class="form-label">类别</label>
                            <select class="form-select" id="mergedCategory" name="merged_category">
                                <option value="前沿资讯">前沿资讯</option>
                                <option value="政策法规">政策法规</option>
                                <option value="市场动态">市场动态</option>
                                <option value="技术创新">技术创新</option>
                                <option value="行业报告">行业报告</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="deleteOriginals" name="delete_originals" checked>
                            <label class="form-check-label" for="deleteOriginals">
                                删除原始情报（推荐）
                            </label>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        将合并 <span id="mergeItemCount">0</span> 条情报，系统将自动收集所有来源链接。
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success" onclick="generateMergedContent()">
                    <i class="bi bi-robot"></i> AI生成内容
                </button>
                <button type="button" class="btn btn-primary" onclick="confirmMerge()">
                    <i class="bi bi-check-circle"></i> 确认合并
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑情报弹窗 -->
<div class="modal fade" id="editIntelligenceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-pencil-square"></i> 编辑情报
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editIntelligenceForm">
                    <input type="hidden" id="edit_intelligence_id" name="intelligence_id">

                    <div class="mb-3">
                        <label for="edit_title" class="form-label">标题 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="edit_title" name="title" required>
                    </div>

                    <div class="mb-3">
                        <label for="edit_summary" class="form-label">摘要</label>
                        <textarea class="form-control" id="edit_summary" name="summary" rows="3"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="edit_topic" class="form-label">议题/类别</label>
                            <div class="topic-selector-container">
                                <input type="text" class="form-control mb-2" id="edit_topic" name="topic"
                                       placeholder="输入或选择议题">
                                <div id="topicSelectorList">
                                    <!-- 议题选项将由JavaScript动态生成 -->
                                    <div class="text-center py-2">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">加载中...</span>
                                        </div>
                                        <small class="text-muted ms-2">正在加载议题...</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label for="edit_category" class="form-label">分类</label>
                            <select class="form-select" id="edit_category" name="category">
                                <option value="">请选择</option>
                                <option value="前沿资讯">前沿资讯</option>
                                <option value="政策法规">政策法规</option>
                                <option value="市场动态">市场动态</option>
                                <option value="技术创新">技术创新</option>
                                <option value="行业报告">行业报告</option>
                            </select>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label for="edit_news_time" class="form-label">新闻时间</label>
                            <input type="datetime-local" class="form-control" id="edit_news_time" name="news_time">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_quality_status" class="form-label">质量状态</label>
                            <select class="form-select" id="edit_quality_status" name="quality_status">
                                <option value="pending">待审核</option>
                                <option value="approved">已通过</option>
                                <option value="rejected">已拒绝</option>
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="edit_ai_score" class="form-label">AI评分</label>
                            <input type="number" class="form-control" id="edit_ai_score" name="ai_score"
                                   min="0" max="10" step="0.1">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">来源链接</label>
                        <div id="edit_sources_list" class="list-group">
                            <!-- 动态填充 -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveIntelligenceEdit()">
                    <i class="bi bi-check-circle"></i> 保存修改
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 爬取结果弹窗 -->
<div class="modal fade" id="crawlResultModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-check-circle"></i> 爬取结果
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="crawlResultContent">
                <!-- 结果内容将动态插入 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="refreshData()">
                    刷新数据
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 数据统计弹窗 -->
<div class="modal fade" id="statisticsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="bi bi-graph-up"></i> 数据统计
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="statisticsContent">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">正在加载统计数据...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 系统设置弹窗 -->
<div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="bi bi-gear"></i> 系统设置
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="settingsContent">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">正在加载设置...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript代码 -->
<script>
// intelligence.html 完整修复版JavaScript代码

// 全局变量
let currentPage = 1;
let currentPageSize = 20;
let currentFilters = {};
let availableTopics = [];
let selectedTopicIds = new Set();
let totalPages = 1;
let selectedIntelligenceIds = new Set();
let currentEditingTopic = null;

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    console.log('页面加载完成，开始初始化...');

    // 初始化筛选表单
    const filterForm = document.getElementById('filterForm');
    if (filterForm) {
        // 绑定筛选表单事件
        filterForm.addEventListener('change', function(e) {
            console.log('筛选条件变化:', e.target.name, '=', e.target.value);
            collectFilters();
            currentPage = 1;
            loadTableData();
        });

        // 绑定重置按钮
        filterForm.addEventListener('reset', function() {
            setTimeout(() => {
                collectFilters();
                currentPage = 1;
                loadTableData();
            }, 50);
        });
    }

    // 监听复选框变化以更新批量工具栏
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('intelligence-checkbox')) {
            updateBatchToolbar();
            updateMergeSection();
        }
    });

    // 键盘快捷键
    document.addEventListener('keydown', function(e) {
        // Ctrl+A 全选
        if (e.ctrlKey && e.key === 'a' && e.target.tagName !== 'INPUT') {
            e.preventDefault();
            const selectAll = document.getElementById('selectAll');
            if (selectAll) {
                selectAll.checked = true;
                toggleSelectAll(selectAll);
            }
        }

        // Esc 取消选择
        if (e.key === 'Escape') {
            clearSelection();
            hideMergeSection();
        }
    });

    // 初始加载数据
    collectFilters();
    loadTableData();
});

// 修复：收集筛选条件函数 - 重点修复时间筛选参数传递
function collectFilters() {
    const filterForm = document.getElementById('filterForm');
    if (!filterForm) {
        currentFilters = {};
        return;
    }

    currentFilters = {};

    // 基础筛选条件
    const title = filterForm.querySelector('[name="title"]')?.value;
    const topic = filterForm.querySelector('[name="topic"]')?.value;
    const quality = filterForm.querySelector('[name="quality"]')?.value;
    const minScore = filterForm.querySelector('[name="min_score"]')?.value;
    const maxScore = filterForm.querySelector('[name="max_score"]')?.value;

    if (title && title.trim()) currentFilters.title = title.trim();
    if (topic && topic.trim()) currentFilters.topic = topic.trim();
    if (quality && quality.trim()) currentFilters.quality = quality.trim();
    if (minScore && minScore.trim()) currentFilters.min_score = parseFloat(minScore);
    if (maxScore && maxScore.trim()) currentFilters.max_score = parseFloat(maxScore);

    // 修复：时间筛选处理 - 关键修复部分
    const timeRange = filterForm.querySelector('[name="time_range"]')?.value;
    console.log('时间范围选择:', timeRange);

    if (timeRange && timeRange !== '') {
        const now = new Date();
        let newsStartDate, newsEndDate;

        switch(timeRange) {
            case 'today':
                newsStartDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                newsEndDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                break;
            case 'yesterday':
                newsStartDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
                newsEndDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                break;
            case 'week':
                newsStartDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                newsEndDate = now;
                break;
            case 'month':
                newsStartDate = new Date(now.getFullYear(), now.getMonth(), 1);
                newsEndDate = now;
                break;
            case 'custom':
                const customStart = filterForm.querySelector('[name="start_date"]')?.value;
                const customEnd = filterForm.querySelector('[name="end_date"]')?.value;
                if (customStart) {
                    newsStartDate = new Date(customStart);
                    console.log('自定义开始时间:', newsStartDate);
                }
                if (customEnd) {
                    newsEndDate = new Date(customEnd);
                    console.log('自定义结束时间:', newsEndDate);
                }
                break;
        }

        // 关键修复：使用正确的参数名传递新闻时间筛选
        if (newsStartDate) {
            currentFilters.news_start_date = newsStartDate.toISOString();
            console.log('设置新闻开始时间:', currentFilters.news_start_date);
        }
        if (newsEndDate) {
            currentFilters.news_end_date = newsEndDate.toISOString();
            console.log('设置新闻结束时间:', currentFilters.news_end_date);
        }
    }

    console.log('收集到的筛选条件:', currentFilters);
}

// 修复的加载表格数据函数
async function loadTableData() {
    console.log('开始加载表格数据...');

    const params = new URLSearchParams();
    params.append('page', currentPage || 1);
    params.append('page_size', currentPageSize || 20);

    // 添加筛选条件 - 修复参数传递
    Object.entries(currentFilters).forEach(([key, value]) => {
        if (value !== null && value !== undefined && value !== '') {
            params.append(key, value);
            console.log(`添加参数: ${key} = ${value}`);
        }
    });

    const container = document.getElementById('intelligenceTableContainer');
    if (!container) {
        console.error('找不到表格容器');
        return;
    }

    // 显示加载状态
    container.innerHTML = `
        <div class="intelligence-table-container">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-3">正在加载数据...</p>
            </div>
        </div>
    `;

    try {
        const url = `/intelligence/partial/table?${params}`;
        console.log('请求URL:', url);

        const response = await fetch(url);

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
        }

        const html = await response.text();
        console.log('收到HTML，长度:', html.length);

        if (!html || html.trim().length === 0) {
            throw new Error('服务器返回空响应');
        }

        container.innerHTML = html;
        console.log('表格更新成功');

        // 重新初始化批量工具栏状态
        updateBatchToolbar();

    } catch (error) {
        console.error('加载失败:', error);
        container.innerHTML = `
            <div class="intelligence-table-container">
                <div class="alert alert-danger m-4">
                    <h5><i class="bi bi-exclamation-triangle"></i> 加载失败</h5>
                    <p>错误信息：${error.message}</p>
                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="loadTableData()">
                            <i class="bi bi-arrow-clockwise"></i> 重试
                        </button>
                        <button class="btn btn-secondary ms-2" onclick="testAPIConnection()">
                            <i class="bi bi-bug"></i> 测试连接
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
}

// 切换页码
function loadPage(page) {
    currentPage = page;
    loadTableData();
}

// 改变每页显示数量
function changePageSize(size) {
    currentPageSize = parseInt(size);
    currentPage = 1;
    loadTableData();
}

// 修复全选功能
function toggleSelectAll(checkbox) {
    if (!checkbox) {
        checkbox = document.getElementById('selectAll') || document.getElementById('selectAllCheckbox');
    }

    const checkboxes = document.querySelectorAll('.intelligence-checkbox');
    const isChecked = checkbox ? checkbox.checked : false;

    checkboxes.forEach(cb => {
        cb.checked = isChecked;
        const id = parseInt(cb.value);
        const row = cb.closest('tr');

        if (isChecked) {
            selectedIntelligenceIds.add(id);
            if (row) row.classList.add('selected-row');
        } else {
            selectedIntelligenceIds.delete(id);
            if (row) row.classList.remove('selected-row');
        }
    });
    updateBatchToolbar();
    updateMergeSection();
}

// 切换单行选择
function toggleRowSelection(id, checkbox) {
    if (!checkbox) {
        checkbox = document.querySelector(`input[value="${id}"]`);
    }

    const row = checkbox ? checkbox.closest('tr') : null;
    const isChecked = checkbox ? checkbox.checked : false;

    if (isChecked) {
        selectedIntelligenceIds.add(id);
        if (row) row.classList.add('selected-row');
    } else {
        selectedIntelligenceIds.delete(id);
        if (row) row.classList.remove('selected-row');
    }

    updateBatchToolbar();
    updateMergeSection();
    updateSelectAllCheckbox();
}

// 更新全选复选框状态
function updateSelectAllCheckbox() {
    const selectAllCheckbox = document.getElementById('selectAll') || document.getElementById('selectAllCheckbox');
    const allCheckboxes = document.querySelectorAll('.intelligence-checkbox');
    const checkedCheckboxes = document.querySelectorAll('.intelligence-checkbox:checked');

    if (selectAllCheckbox) {
        selectAllCheckbox.checked = allCheckboxes.length > 0 && checkedCheckboxes.length === allCheckboxes.length;
        selectAllCheckbox.indeterminate = checkedCheckboxes.length > 0 && checkedCheckboxes.length < allCheckboxes.length;
    }
}

// 更新批量操作工具栏
function updateBatchToolbar() {
    const selectedCount = document.getElementById('selectedCount');

    if (selectedCount) {
        selectedCount.textContent = `已选择 ${selectedIntelligenceIds.size} 项`;
    }

    updateSelectAllCheckbox();
}

// 更新合并功能区域
function updateMergeSection() {
    const mergeSection = document.getElementById('mergeSection');
    const mergeSelectedBtn = document.getElementById('mergeSelectedBtn');
    const mergeCount = document.getElementById('mergeCount');

    if (mergeSection && mergeSelectedBtn && mergeCount) {
        if (selectedIntelligenceIds.size >= 2) {
            mergeSection.style.display = 'block';
            mergeSelectedBtn.disabled = false;
            mergeCount.textContent = selectedIntelligenceIds.size;
        } else {
            if (selectedIntelligenceIds.size === 0) {
                mergeSection.style.display = 'none';
            } else {
                mergeSelectedBtn.disabled = true;
                mergeCount.textContent = selectedIntelligenceIds.size;
            }
        }
    }
}

// 隐藏合并区域
function hideMergeSection() {
    const mergeSection = document.getElementById('mergeSection');
    if (mergeSection) {
        mergeSection.style.display = 'none';
    }
}

// 清除选择
function clearSelection() {
    selectedIntelligenceIds.clear();
    document.querySelectorAll('.intelligence-checkbox').forEach(cb => {
        cb.checked = false;
        cb.closest('tr')?.classList.remove('selected-row');
    });
    const selectAllCheckbox = document.getElementById('selectAll') || document.getElementById('selectAllCheckbox');
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = false;
    }
    updateBatchToolbar();
    updateMergeSection();
}

// 修复：切换自定义时间范围 - 确保正确显示和隐藏
function toggleCustomTimeRange(select) {
    const customTimeRange = document.getElementById('customTimeRange');
    if (customTimeRange) {
        if (select.value === 'custom') {
            customTimeRange.style.display = 'block';
        } else {
            customTimeRange.style.display = 'none';
            // 非自定义选择时，立即应用筛选
            collectFilters();
            currentPage = 1;
            loadTableData();
        }
    }
}

// 修复：应用时间筛选
function applyTimeFilter() {
    console.log('应用时间筛选');
    collectFilters();
    currentPage = 1;
    loadTableData();
    showAlert('时间筛选已应用', 'success');
}

// 清除所有筛选条件
function clearAllFilters() {
    const filterForm = document.getElementById('filterForm');
    if (filterForm) {
        // 清空所有表单字段
        const inputs = filterForm.querySelectorAll('input, select');
        inputs.forEach(input => {
            if (input.type === 'text' || input.type === 'number' || input.type === 'datetime-local') {
                input.value = '';
            } else if (input.tagName === 'SELECT') {
                input.selectedIndex = 0;
            }
        });

        // 隐藏自定义时间范围
        const customTimeRange = document.getElementById('customTimeRange');
        if (customTimeRange) {
            customTimeRange.style.display = 'none';
        }

        // 重新加载数据
        collectFilters();
        currentPage = 1;
        loadTableData();

        showAlert('已清除所有筛选条件', 'info');
    }
}

// 导出选中 - 修复参数传递
function exportSelected(format = 'csv') {
    if (selectedIntelligenceIds.size === 0) {
        showAlert('请先选择要导出的情报', 'warning');
        return;
    }

    const ids = Array.from(selectedIntelligenceIds);
    const url = `/api/intelligence/export?format=${format}&export_scope=selected&intelligence_ids=${ids.join(',')}`;

    try {
        const link = document.createElement('a');
        link.href = url;
        link.download = `intelligence_export_selected_${new Date().toISOString().split('T')[0]}.${format}`;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showAlert(`正在导出 ${ids.length} 条情报...`, 'info');
    } catch (error) {
        console.error('导出失败:', error);
        showAlert('导出失败，请重试', 'danger');
    }
}

// 导出筛选结果
function exportFiltered(format = 'csv') {
    const params = new URLSearchParams();
    params.append('format', format);
    params.append('export_scope', 'filtered');

    // 添加当前筛选条件
    Object.entries(currentFilters).forEach(([key, value]) => {
        if (value !== null && value !== undefined && value !== '') {
            params.append(key, value);
        }
    });

    const url = `/api/intelligence/export?${params}`;

    try {
        const link = document.createElement('a');
        link.href = url;
        link.download = `intelligence_export_filtered_${new Date().toISOString().split('T')[0]}.${format}`;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showAlert('正在导出筛选结果...', 'info');
    } catch (error) {
        console.error('导出失败:', error);
        showAlert('导出失败，请重试', 'danger');
    }
}

// 导出全部数据
function exportAll(format = 'csv') {
    const url = `/api/intelligence/export?format=${format}&export_scope=all`;

    try {
        const link = document.createElement('a');
        link.href = url;
        link.download = `intelligence_export_all_${new Date().toISOString().split('T')[0]}.${format}`;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showAlert('正在导出全部数据...', 'info');
    } catch (error) {
        console.error('导出失败:', error);
        showAlert('导出失败，请重试', 'danger');
    }
}

// 下载模板
function downloadTemplate() {
    try {
        const url = '/api/intelligence/export-template';
        const link = document.createElement('a');
        link.href = url;
        link.download = 'intelligence_import_template.csv';
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showAlert('正在下载导入模板...', 'info');
    } catch (error) {
        console.error('模板下载失败:', error);
        showAlert('模板下载失败，请重试', 'danger');
    }
}

// 竞争对手标记切换函数
async function toggleCompetitor(intelligenceId) {
    try {
        const response = await fetch(`/api/intelligence/${intelligenceId}/toggle-competitor`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const result = await response.json();
        if (result.status === 'success') {
            showAlert(result.message, 'success');
            loadTableData(); // 重新加载表格
        } else {
            showAlert('操作失败: ' + result.message, 'danger');
        }
    } catch (error) {
        showAlert('操作失败: ' + error.message, 'danger');
    }
}

// 批量AI处理
async function batchAIProcess() {
    if (selectedIntelligenceIds.size === 0) {
        showAlert('请先选择要处理的情报', 'warning');
        return;
    }

    if (!confirm(`确定要对选中的 ${selectedIntelligenceIds.size} 条情报进行AI分析吗？这将启用并行处理以提升速度。`)) {
        return;
    }

    const ids = Array.from(selectedIntelligenceIds);

    showAlert(`正在对 ${ids.length} 条情报进行AI分析，请稍候...`, 'info');

    try {
        const response = await fetch('/api/intelligence/batch-ai-process', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                intelligence_ids: ids
            })
        });

        const data = await response.json();

        if (data.status === 'success') {
            const successCount = data.success_count;
            const failCount = data.total_count - successCount;

            let message = `AI分析完成：成功 ${successCount} 条`;
            if (failCount > 0) {
                message += `，失败 ${failCount} 条`;
            }

            showAlert(message, successCount > 0 ? 'success' : 'warning');
            loadTableData();
            clearSelection();
        } else {
            showAlert('批量处理失败: ' + data.message, 'danger');
        }
    } catch (error) {
        showAlert('批量处理失败: ' + error.message, 'danger');
    }
}

// 其他功能函数（批量通过、拒绝、删除等）
async function batchApprove() {
    if (selectedIntelligenceIds.size === 0) {
        showAlert('请先选择要审核的情报', 'warning');
        return;
    }

    if (!confirm(`确定要通过选中的 ${selectedIntelligenceIds.size} 条情报吗？`)) {
        return;
    }

    const ids = Array.from(selectedIntelligenceIds);
    let successCount = 0;

    for (const id of ids) {
        try {
            const response = await fetch(`/api/intelligence/${id}/quality`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: 'approved' })
            });

            if (response.ok) {
                successCount++;
            }
        } catch (error) {
            console.error(`Failed to approve ${id}:`, error);
        }
    }

    showAlert(`成功通过 ${successCount} 条情报`, 'success');
    clearSelection();
    loadTableData();
}

async function batchReject() {
    if (selectedIntelligenceIds.size === 0) {
        showAlert('请先选择要拒绝的情报', 'warning');
        return;
    }

    if (!confirm(`确定要拒绝选中的 ${selectedIntelligenceIds.size} 条情报吗？`)) {
        return;
    }

    const ids = Array.from(selectedIntelligenceIds);
    let successCount = 0;

    for (const id of ids) {
        try {
            const response = await fetch(`/api/intelligence/${id}/quality`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: 'rejected' })
            });

            if (response.ok) {
                successCount++;
            }
        } catch (error) {
            console.error(`Failed to reject ${id}:`, error);
        }
    }

    showAlert(`成功拒绝 ${successCount} 条情报`, 'success');
    clearSelection();
    loadTableData();
}

async function batchDelete() {
    if (selectedIntelligenceIds.size === 0) {
        showAlert('请先选择要删除的情报', 'warning');
        return;
    }

    if (!confirm(`确定要删除选中的 ${selectedIntelligenceIds.size} 条情报吗？此操作不可恢复！`)) {
        return;
    }

    const ids = Array.from(selectedIntelligenceIds);

    try {
        const promises = ids.map(id =>
            fetch(`/api/intelligence/${id}`, { method: 'DELETE' })
        );

        await Promise.all(promises);
        showAlert(`已删除 ${ids.length} 条情报`, 'success');
        loadTableData();
        clearSelection();
    } catch (error) {
        showAlert('批量删除失败: ' + error.message, 'danger');
    }
}

// 单个情报操作函数
async function aiProcess(id) {
    if (!confirm('确定要重新进行AI分析吗？这将覆盖现有的分析结果。')) {
        return;
    }

    const button = document.querySelector(`tr[data-id="${id}"] .btn-outline-success`);
    const originalHTML = button?.innerHTML;
    if (button) {
        button.innerHTML = '<i class="bi bi-hourglass-split"></i>';
        button.disabled = true;
    }

    try {
        const response = await fetch(`/api/intelligence/${id}/ai-process`, {
            method: 'POST'
        });

        const data = await response.json();

        if (data.status === 'success') {
            showAlert(`AI分析完成，评分：${data.ai_score}`, 'success');
            loadTableData();
        } else {
            showAlert('AI分析失败: ' + data.message, 'danger');
        }
    } catch (error) {
        showAlert('AI分析失败: ' + error.message, 'danger');
    } finally {
        if (button && originalHTML) {
            button.innerHTML = originalHTML;
            button.disabled = false;
        }
    }
}

async function updateQualityStatus(id, newStatus) {
    try {
        const response = await fetch(`/api/intelligence/${id}/quality`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status: newStatus })
        });

        const data = await response.json();

        if (data.status === 'success') {
            const select = document.querySelector(`tr[data-id="${id}"] .status-select`);
            if (select) {
                select.dataset.current = newStatus;
            }
            showAlert('状态更新成功', 'success');
        } else {
            // 恢复原状态
            const select = document.querySelector(`tr[data-id="${id}"] .status-select`);
            if (select) {
                select.value = select.dataset.current;
            }
            showAlert('状态更新失败: ' + data.message, 'danger');
        }
    } catch (error) {
        const select = document.querySelector(`tr[data-id="${id}"] .status-select`);
        if (select) {
            select.value = select.dataset.current;
        }
        showAlert('状态更新失败: ' + error.message, 'danger');
    }
}

async function deleteIntelligence(id) {
    if (!confirm('确定要删除这条情报吗？此操作不可恢复。')) {
        return;
    }

    try {
        const response = await fetch(`/api/intelligence/${id}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (data.status === 'success') {
            showAlert('删除成功', 'success');
            loadTableData();
        } else {
            showAlert('删除失败: ' + data.message, 'danger');
        }
    } catch (error) {
        showAlert('删除失败: ' + error.message, 'danger');
    }
}

// 查看详情功能
async function viewDetails(id) {
    try {
        const response = await fetch(`/api/intelligence/${id}`);
        const data = await response.json();

        if (data.status === 'success') {
            const intel = data.data;

            // 构建详情HTML
            const detailsHTML = `
                <div class="intelligence-details">
                    <h5 class="mb-3">${intel.title}</h5>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>议题：</strong> ${intel.topic || '未分类'}
                        </div>
                        <div class="col-md-6">
                            <strong>AI评分：</strong>
                            <span class="badge bg-${intel.ai_score >= 7 ? 'success' : intel.ai_score >= 5 ? 'warning' : 'secondary'}">
                                ${intel.ai_score}
                            </span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <strong>摘要：</strong>
                        <p class="mt-2">${intel.summary || '暂无摘要'}</p>
                    </div>

                    <div class="mb-3">
                        <strong>新闻时间：</strong>
                        <span class="text-muted">${intel.news_time ? formatDateTime(intel.news_time) : '未知时间'}</span>
                    </div>

                    <div class="mb-3">
                        <strong>来源链接：</strong>
                        <div class="mt-2">
                            ${intel.sources?.map(source => `
                                <a href="${source.url}" target="_blank" class="btn btn-outline-primary btn-sm me-2 mb-1">
                                    <i class="bi bi-link-45deg"></i> ${source.title || '查看原文'}
                                </a>
                            `).join('') || '无来源'}
                        </div>
                    </div>
                </div>
            `;

            // 显示在模态框中
            const modalHTML = `
                <div class="modal fade" id="detailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">情报详情</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                ${detailsHTML}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                                <button type="button" class="btn btn-primary" onclick="editIntelligence(${id})">编辑</button>
                                <button type="button" class="btn btn-success" onclick="aiProcess(${id})">AI重新分析</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // 移除旧模态框
            const oldModal = document.getElementById('detailsModal');
            if (oldModal) oldModal.remove();

            // 添加新模态框
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
            modal.show();

        } else {
            showAlert('获取详情失败: ' + data.message, 'danger');
        }
    } catch (error) {
        showAlert('获取详情失败: ' + error.message, 'danger');
    }
}

// 编辑情报功能
async function editIntelligence(id) {
    try {
        // 同时获取情报详情和议题列表
        const [intelResponse, topicsResponse] = await Promise.all([
            fetch(`/api/intelligence/${id}`),
            fetch('/api/intelligence/topics')
        ]);

        const intelData = await intelResponse.json();
        const topicsData = await topicsResponse.json();

        if (intelData.status === 'success' && topicsData.status === 'success') {
            const intel = intelData.data;

            // 填充基本信息
            document.getElementById('edit_intelligence_id').value = intel.id;
            document.getElementById('edit_title').value = intel.title;
            document.getElementById('edit_summary').value = intel.summary || '';
            document.getElementById('edit_topic').value = intel.topic || '';
            document.getElementById('edit_quality_status').value = intel.quality_status;
            document.getElementById('edit_ai_score').value = intel.ai_score || 0;

            if (intel.news_time) {
                const date = new Date(intel.news_time);
                const localDateTime = date.toISOString().slice(0, 16);
                document.getElementById('edit_news_time').value = localDateTime;
            }

            // 动态渲染议题选择器
            renderTopicsForEdit(topicsData.topics, intel.topic);

            // 处理来源列表
            const sourcesList = document.getElementById('edit_sources_list');
            sourcesList.innerHTML = '';
            if (intel.sources && intel.sources.length > 0) {
                intel.sources.forEach(source => {
                    sourcesList.innerHTML += `
                        <a href="${source.url}" target="_blank" class="list-group-item list-group-item-action">
                            <i class="bi bi-link-45deg"></i> ${source.title || source.url}
                        </a>
                    `;
                });
            } else {
                sourcesList.innerHTML = '<div class="list-group-item text-muted">无来源链接</div>';
            }

            const modal = new bootstrap.Modal(document.getElementById('editIntelligenceModal'));
            modal.show();

        } else {
            showAlert('获取情报详情失败', 'danger');
        }
    } catch (error) {
        showAlert('获取情报详情失败: ' + error.message, 'danger');
    }
}

// 渲染编辑页面的议题选择器
function renderTopicsForEdit(topics, currentTopic) {
    const container = document.getElementById('topicSelectorList');

    if (!topics || topics.length === 0) {
        container.innerHTML = '<div class="text-muted">暂无可用议题</div>';
        return;
    }

    container.innerHTML = topics.map((topic, index) => `
        <div class="topic-selector-item">
            <div class="form-check">
                <input class="form-check-input" type="radio" name="selectedTopic"
                       value="${topic.name}" id="edit_topic_${topic.id}"
                       ${currentTopic === topic.name ? 'checked' : ''}>
                <label class="form-check-label" for="edit_topic_${topic.id}">
                    ${topic.name}
                    ${topic.description ? `<small class="text-muted d-block">${topic.description}</small>` : ''}
                </label>
            </div>
        </div>
    `).join('');

    // 绑定选择事件
    container.querySelectorAll('input[name="selectedTopic"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('edit_topic').value = this.value;
            }
        });
    });
}

// 保存编辑
async function saveIntelligenceEdit() {
    const form = document.getElementById('editIntelligenceForm');
    const formData = new FormData(form);
    const id = formData.get('intelligence_id');

    const updateData = {
        title: formData.get('title'),
        summary: formData.get('summary'),
        topic: formData.get('topic'),
        quality_status: formData.get('quality_status'),
        ai_score: parseFloat(formData.get('ai_score')) || 0
    };

    const newsTime = formData.get('news_time');
    if (newsTime) {
        updateData.news_time = new Date(newsTime).toISOString();
    }

    try {
        const response = await fetch(`/api/intelligence/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(updateData)
        });

        const data = await response.json();

        if (data.status === 'success') {
            bootstrap.Modal.getInstance(document.getElementById('editIntelligenceModal')).hide();
            showAlert('情报更新成功', 'success');
            loadTableData();
        } else {
            showAlert('更新失败: ' + data.message, 'danger');
        }
    } catch (error) {
        showAlert('更新失败: ' + error.message, 'danger');
    }
}

// 打开合并模态框
function openMergeModal() {
    if (selectedIntelligenceIds.size < 2) {
        showAlert('请至少选择2条情报进行合并', 'warning');
        return;
    }

    // 填充合并项数量
    document.getElementById('mergeItemCount').textContent = selectedIntelligenceIds.size;

    // 生成默认合并标题
    const selectedTitles = Array.from(selectedIntelligenceIds).map(id => {
        const row = document.querySelector(`tr[data-id="${id}"]`);
        return row ? row.querySelector('strong').textContent.trim() : `情报${id}`;
    });

    document.getElementById('mergedTitle').value = `合并报道: ${selectedTitles[0]}`;
    document.getElementById('mergedSummary').value = `来自${selectedIntelligenceIds.size}个信息源的合并情报`;
    document.getElementById('mergedTopic').value = '前沿资讯';

    const modal = new bootstrap.Modal(document.getElementById('mergeModal'));
    modal.show();
}

// AI生成合并内容
async function generateMergedContent() {
    if (selectedIntelligenceIds.size === 0) {
        showAlert('请先选择要合并的情报', 'warning');
        return;
    }

    showAlert('AI正在生成合并内容...', 'info');

    // 这里可以调用AI API生成更好的合并标题和摘要
    // 暂时使用简单的逻辑
    const selectedTitles = Array.from(selectedIntelligenceIds).map(id => {
        const row = document.querySelector(`tr[data-id="${id}"]`);
        return row ? row.querySelector('strong').textContent.trim() : `情报${id}`;
    });

    const aiTitle = `【综合报道】${selectedTitles[0].substring(0, 30)}`;
    const aiSummary = `本报道综合了${selectedIntelligenceIds.size}个信息源的内容，包括：${selectedTitles.slice(0, 3).join('、')}${selectedTitles.length > 3 ? '等' : ''}。`;

    document.getElementById('mergedTitle').value = aiTitle;
    document.getElementById('mergedSummary').value = aiSummary;

    showAlert('AI内容生成完成', 'success');
}

// 确认合并
async function confirmMerge() {
    const form = document.getElementById('mergeForm');
    const formData = new FormData(form);

    const mergeData = {
        intelligence_ids: Array.from(selectedIntelligenceIds),
        merged_title: formData.get('merged_title'),
        merged_summary: formData.get('merged_summary'),
        merged_topic: formData.get('merged_topic'),
        merged_category: formData.get('merged_category'),
        delete_originals: formData.get('delete_originals') === 'on'
    };

    if (!mergeData.merged_title || !mergeData.merged_summary) {
        showAlert('请填写合并后的标题和摘要', 'warning');
        return;
    }

    try {
        const response = await fetch('/api/intelligence/merge', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(mergeData)
        });

        const result = await response.json();

        if (result.status === 'success') {
            bootstrap.Modal.getInstance(document.getElementById('mergeModal')).hide();
            showAlert(`${result.message}`, 'success');
            clearSelection();
            hideMergeSection();
            loadTableData();
        } else {
            showAlert('合并失败: ' + result.message, 'danger');
        }
    } catch (error) {
        showAlert('合并失败: ' + error.message, 'danger');
    }
}

// 通过URL合并
async function mergeByUrl() {
    const url = document.getElementById('mergeUrl').value.trim();
    if (!url) {
        showAlert('请输入URL', 'warning');
        return;
    }

    if (selectedIntelligenceIds.size === 0) {
        showAlert('请先选择至少一条情报', 'warning');
        return;
    }

    try {
        const response = await fetch('/api/intelligence/merge-by-url', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                url: url,
                selected_ids: Array.from(selectedIntelligenceIds)
            })
        });

        const result = await response.json();

        if (result.status === 'success') {
            showAlert(result.message, 'success');
            clearSelection();
            hideMergeSection();
            loadTableData();
            document.getElementById('mergeUrl').value = '';
        } else {
            showAlert('URL合并失败: ' + result.message, 'danger');
        }
    } catch (error) {
        showAlert('URL合并失败: ' + error.message, 'danger');
    }
}

// 全部AI评分功能
async function batchScoreAll() {
    const response = await fetch('/api/intelligence/list?page=1&page_size=1');
    const data = await response.json();
    const totalCount = data.total || 0;

    if (totalCount === 0) {
        showAlert('没有可评分的情报', 'warning');
        return;
    }

    const estimatedTime = Math.ceil(totalCount / 5); // 按5并发估算

    if (!confirm(`确定要对所有 ${totalCount} 条情报进行AI评分吗？\n预计耗时约 ${estimatedTime} 分钟（使用并行处理）。`)) {
        return;
    }

    // 分批获取所有ID
    const allIds = [];
    const pageSize = 100;
    const totalPages = Math.ceil(totalCount / pageSize);

    showAlert(`正在获取 ${totalCount} 条情报ID...`, 'info');

    for (let page = 1; page <= totalPages; page++) {
        try {
            const pageResponse = await fetch(`/api/intelligence/list?page=${page}&page_size=${pageSize}`);
            const pageData = await pageResponse.json();

            if (pageData.items) {
                const pageIds = pageData.items.map(item => item.id);
                allIds.push(...pageIds);
            }
        } catch (error) {
            console.error(`获取第${page}页数据失败:`, error);
        }
    }

    if (allIds.length === 0) {
        showAlert('获取情报ID失败', 'danger');
        return;
    }

    showAlert(`开始处理 ${allIds.length} 条情报，请等待...`, 'info');

    try {
        const response = await fetch('/api/intelligence/batch-ai-process', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                intelligence_ids: allIds
            })
        });

        const result = await response.json();

        if (result.status === 'success') {
            showAlert(
                `全量AI分析完成：成功 ${result.success_count}/${result.total_count} 条\n` +
                `处理时间：${result.processing_time}秒`,
                'success'
            );
            loadTableData();
        } else {
            showAlert('全量AI分析失败: ' + result.message, 'danger');
        }
    } catch (error) {
        showAlert('全量AI分析失败: ' + error.message, 'danger');
    }
}

// 格式化时间显示
function formatDateTime(dateString) {
    if (!dateString) return '-';

    try {
        const date = new Date(dateString);
        const now = new Date();
        const diffTime = now - date;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays === 0) return '今天';
        if (diffDays === 1) return '昨天';
        if (diffDays < 7) return `${diffDays}天前`;

        return date.toLocaleDateString('zh-CN', {
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch {
        return dateString; // 如果解析失败，返回原始字符串
    }
}

// 内联编辑议题
function editTopicInline(id, currentTopic) {
    currentEditingTopic = id;
    const event = window.event;
    const target = event.target;

    const input = document.getElementById('topicInput');
    input.value = currentTopic;

    const editDiv = document.getElementById('topicEditInput');
    editDiv.style.display = 'block';
    editDiv.style.position = 'absolute';
    editDiv.style.left = target.offsetLeft + 'px';
    editDiv.style.top = target.offsetTop + 'px';
    editDiv.style.width = '150px';

    target.style.display = 'none';
    target.parentElement.appendChild(editDiv);

    input.focus();
    input.select();
}

// 保存议题编辑
async function saveTopicEdit() {
    if (!currentEditingTopic) return;

    const input = document.getElementById('topicInput');
    const newTopic = input.value.trim();

    if (newTopic) {
        try {
            await fetch(`/api/intelligence/${currentEditingTopic}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ topic: newTopic })
            });

            showAlert('议题更新成功', 'success');
            loadTableData();
        } catch (error) {
            showAlert('议题更新失败: ' + error.message, 'danger');
        }
    }

    cancelTopicEdit();
}

// 取消议题编辑
function cancelTopicEdit() {
    document.getElementById('topicEditInput').style.display = 'none';
    currentEditingTopic = null;
}

// 确保所有函数都在全局作用域中
window.viewDetails = viewDetails;
window.editIntelligence = editIntelligence;
window.saveIntelligenceEdit = saveIntelligenceEdit;
window.openMergeModal = openMergeModal;
window.generateMergedContent = generateMergedContent;
window.confirmMerge = confirmMerge;
window.mergeByUrl = mergeByUrl;
window.batchScoreAll = batchScoreAll;
window.formatDateTime = formatDateTime;
window.editTopicInline = editTopicInline;
window.saveTopicEdit = saveTopicEdit;
window.cancelTopicEdit = cancelTopicEdit;

// 显示提示消息
function showAlert(message, type) {
    const existingAlerts = document.querySelectorAll('.floating-alert');
    existingAlerts.forEach(alert => alert.remove());

    const alertDiv = document.createElement('div');
    alertDiv.className = `floating-alert alert-${type}`;
    alertDiv.innerHTML = `
        <div class="alert-content">
            <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'danger' ? 'x-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
            <span>${message}</span>
        </div>
        <button class="alert-close" onclick="this.parentElement.remove()">
            <i class="bi bi-x"></i>
        </button>
    `;

    document.body.appendChild(alertDiv);

    setTimeout(() => {
        alertDiv.classList.add('fade-out');
        setTimeout(() => alertDiv.remove(), 300);
    }, 5000);
}

// 测试API连接
async function testAPIConnection() {
    console.log('测试API连接...');

    try {
        const response = await fetch('/api/intelligence/list?page=1&page_size=5');
        const data = await response.json();
        console.log('API测试成功:', data);

        if (data.error) {
            console.error('API返回错误:', data.error);
            showAlert('API错误: ' + data.error, 'danger');
        } else {
            showAlert('API连接正常，共有 ' + (data.total || 0) + ' 条数据', 'success');
        }

        return data;
    } catch (error) {
        console.error('API测试失败:', error);
        showAlert('API连接失败: ' + error.message, 'danger');
        return null;
    }
}

// 刷新数据
function refreshData() {
    collectFilters();
    loadTableData();
    showAlert('数据已刷新', 'success');
}

// 爬取相关功能
function openCrawlModal() {
    loadTopicsForModal();
    const modal = new bootstrap.Modal(document.getElementById('crawlModal'));
    modal.show();
}

async function loadTopicsForModal() {
    try {
        const response = await fetch('/api/intelligence/topics');
        const data = await response.json();

        if (data.status === 'success') {
            availableTopics = data.topics;
            renderTopicsInModal(data.topics);
        } else {
            showAlert('加载议题失败: ' + data.message, 'danger');
        }
    } catch (error) {
        showAlert('加载议题失败: ' + error.message, 'danger');
    }
}

function renderTopicsInModal(topics) {
    const container = document.getElementById('topicSelectionModal');
    if (!container) return;

    if (topics.length === 0) {
        container.innerHTML = `
            <div class="text-center py-3 text-muted">
                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                <p class="mt-3">暂无可用议题</p>
                <small>请先在议题管理中添加议题和信息源</small>
            </div>
        `;
        return;
    }

    container.innerHTML = topics.map(topic => `
        <div class="topic-item-modal" onclick="toggleTopicSelection('${topic.id}')">
            <div class="topic-checkbox-wrapper">
                <input type="checkbox" class="form-check-input topic-checkbox-modal"
                       id="modal_topic_${topic.id}" value="${topic.id}"
                       onclick="event.stopPropagation();" onchange="updateSelectedTopicsModal()">
            </div>
            <div class="topic-info-modal">
                <div class="topic-name-modal">${topic.name}</div>
                ${topic.description ? `<div class="topic-description">${topic.description}</div>` : ''}
                <div class="topic-sources-modal">
                    <i class="bi bi-link-45deg"></i> ${topic.source_count} 个信息源
                </div>
            </div>
            <div class="topic-badge-modal">${topic.source_count} 源</div>
        </div>
    `).join('');

    selectedTopicIds.clear();
    updateSelectedTopicsModal();
}

function toggleTopicSelection(topicId) {
    const checkbox = document.getElementById(`modal_topic_${topicId}`);
    if (checkbox) {
        checkbox.checked = !checkbox.checked;
        updateSelectedTopicsModal();
    }
}

function toggleAllTopics() {
    const selectAll = document.getElementById('selectAllTopics');
    const checkboxes = document.querySelectorAll('.topic-checkbox-modal');

    if (selectAll && checkboxes) {
        checkboxes.forEach(cb => {
            cb.checked = selectAll.checked;
        });

        updateSelectedTopicsModal();
    }
}

function updateSelectedTopicsModal() {
    const checkboxes = document.querySelectorAll('.topic-checkbox-modal:checked');
    selectedTopicIds = new Set(Array.from(checkboxes).map(cb => cb.value));

    const topicIdsInput = document.getElementById('topicIdsInput');
    const selectedTopicCount = document.getElementById('selectedTopicCount');
    const startCrawlBtn = document.getElementById('startCrawlBtn');

    if (topicIdsInput) {
        topicIdsInput.value = Array.from(selectedTopicIds).join(',');
    }
    if (selectedTopicCount) {
        selectedTopicCount.textContent = `已选择 ${selectedTopicIds.size} 个`;
    }
    if (startCrawlBtn) {
        startCrawlBtn.disabled = selectedTopicIds.size === 0;
    }

    const allCheckboxes = document.querySelectorAll('.topic-checkbox-modal');
    const selectAllCheckbox = document.getElementById('selectAllTopics');
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = allCheckboxes.length > 0 && selectedTopicIds.size === allCheckboxes.length;
    }

    document.querySelectorAll('.topic-item-modal').forEach(item => {
        const checkbox = item.querySelector('input[type="checkbox"]');
        if (checkbox && checkbox.checked) {
            item.classList.add('selected');
        } else {
            item.classList.remove('selected');
        }
    });
}

// 开始爬取
async function startCrawling() {
    const topicIds = document.getElementById('topicIdsInput')?.value;
    const daysBack = document.getElementById('daysBack')?.value;
    const maxItems = document.getElementById('maxItems')?.value;

    if (!topicIds) {
        showAlert('请至少选择一个议题', 'warning');
        return;
    }

    const crawlingIndicator = document.getElementById('crawlingIndicator');
    const startCrawlBtn = document.getElementById('startCrawlBtn');

    if (crawlingIndicator) crawlingIndicator.classList.add('active');
    if (startCrawlBtn) startCrawlBtn.disabled = true;

    try {
        const formData = new FormData();
        formData.append('topic_ids', topicIds);
        formData.append('days_back', daysBack);
        formData.append('max_items_per_source', maxItems);

        const response = await fetch('/api/intelligence/crawl', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (crawlingIndicator) crawlingIndicator.classList.remove('active');
        if (startCrawlBtn) startCrawlBtn.disabled = false;

        if (data.status === 'success') {
            const modal = bootstrap.Modal.getInstance(document.getElementById('crawlModal'));
            if (modal) modal.hide();
            showCrawlResults(data);
            loadTableData();
        } else {
            showAlert('爬取失败: ' + data.message, 'danger');
        }
    } catch (error) {
        if (crawlingIndicator) crawlingIndicator.classList.remove('active');
        if (startCrawlBtn) startCrawlBtn.disabled = false;
        showAlert('爬取失败: ' + error.message, 'danger');
    }
}

// 显示爬取结果
function showCrawlResults(response) {
    const contentDiv = document.getElementById('crawlResultContent');
    if (!contentDiv) return;

    let html = `
        <div class="alert alert-success">
            <strong>爬取完成！</strong> 共成功爬取 ${response.total_crawled} 条情报
        </div>
        <div class="mb-3">
            <strong>时间范围：</strong> ${response.time_range.start_date} 至 ${response.time_range.end_date}
        </div>
    `;

    if (response.results) {
        response.results.forEach(result => {
            html += `
                <div class="mb-3">
                    <h6>${result.topic_name} (共 ${result.total_items} 条)</h6>
                    <ul class="list-group">
            `;

            if (result.sources) {
                result.sources.forEach(source => {
                    const statusClass = source.status === 'success' ? 'success' : 'danger';
                    const statusText = source.status === 'success'
                        ? `成功: 爬取 ${source.crawled} 条，保存 ${source.saved} 条`
                        : `失败: ${source.message}`;

                    html += `
                        <li class="list-group-item">
                            <span class="badge bg-${statusClass} me-2">${source.status}</span>
                            <strong>${source.domain}</strong> - ${statusText}
                        </li>
                    `;
                });
            }

            html += `
                    </ul>
                </div>
            `;
        });
    }

    contentDiv.innerHTML = html;

    const resultModal = new bootstrap.Modal(document.getElementById('crawlResultModal'));
    resultModal.show();
}

// 占位符函数，避免按钮点击错误
function openStatistics() {
    const modal = new bootstrap.Modal(document.getElementById('statisticsModal'));
    loadStatisticsData();
    modal.show();
}

function openSettings() {
    const modal = new bootstrap.Modal(document.getElementById('settingsModal'));
    loadSettingsData();
    modal.show();
}

async function loadStatisticsData() {
    try {
        const response = await fetch('/api/intelligence/list?page=1&page_size=1');
        const data = await response.json();

        const container = document.getElementById('statisticsContent');
        if (!container) return;

        const stats = {
            total: data.total || 0,
            pending: Math.floor((data.total || 0) * 0.3),
            approved: Math.floor((data.total || 0) * 0.6),
            rejected: Math.floor((data.total || 0) * 0.1),
            avgScore: 7.2,
            todayCount: 15
        };

        const html = `
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${stats.total}</h5>
                            <p class="card-text">总情报数量</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${stats.pending}</h5>
                            <p class="card-text">待审核</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${stats.approved}</h5>
                            <p class="card-text">已通过</p>
                        </div>
                    </div>
                </div>
            </div>
        `;

        container.innerHTML = html;
    } catch (error) {
        console.error('加载统计数据失败:', error);
        const container = document.getElementById('statisticsContent');
        if (container) {
            container.innerHTML = '<div class="alert alert-danger">加载失败，请重试</div>';
        }
    }
}

function loadSettingsData() {
    // 设置页面的加载逻辑
    const container = document.getElementById('settingsContent');
    if (container) {
        container.innerHTML = '<div class="alert alert-info">设置功能开发中...</div>';
    }
}
// 打开日期提取模态框
function openDateExtractionModal() {
    const modal = new bootstrap.Modal(document.getElementById('dateExtractionModal'));
    modal.show();
}

// 预览缺少日期的文章
async function previewMissingDates() {
    const topic = document.getElementById('dateExtractionTopic').value;
    const limitStr = document.getElementById('dateExtractionLimit').value;

    // 确保limit是数字
    const limit = parseInt(limitStr) || 100;

    console.log('请求参数:', { topic, limit }); // 添加调试日志

    try {
        const params = new URLSearchParams();
        params.append('limit', limit.toString()); // 确保转换为字符串
        if (topic && topic.trim()) {
            params.append('topic', topic.trim());
        }

        // 修复：使用正确的API端点
        console.log('请求URL:', `/api/intelligence/missing-dates?${params}`);

        const response = await fetch(`/api/intelligence/missing-dates?${params}`);

        console.log('响应状态:', response.status);

        if (!response.ok) {
            const errorText = await response.text();
            console.error('请求失败:', errorText);
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        const data = await response.json();
        console.log('响应数据:', data);

        if (data.status === 'success') {
            displayMissingDatesPreview(data.articles);
            showAlert(`找到 ${data.articles.length} 条缺少日期的文章`, 'info');
        } else {
            showAlert('获取预览失败: ' + data.message, 'danger');
        }
    } catch (error) {
        console.error('获取预览失败:', error);
        showAlert('获取预览失败: ' + error.message, 'danger');
    }
}


// 显示缺少日期的文章预览
function displayMissingDatesPreview(articles) {
    const container = document.getElementById('missingDatesList');
    const preview = document.getElementById('missingDatesPreview');

    if (articles.length === 0) {
        container.innerHTML = '<div class="list-group-item text-muted text-center">没有找到缺少日期的文章</div>';
    } else {
        container.innerHTML = articles.map(article => `
            <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="mb-1">${article.title.substring(0, 60)}${article.title.length > 60 ? '...' : ''}</h6>
                        <p class="mb-1 text-muted small">议题: ${article.topic}</p>
                        <small class="text-muted">收集时间: ${formatDateTime(article.collect_time)}</small>
                    </div>
                    <div>
                        <a href="${article.url}" target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-link"></i>
                        </a>
                    </div>
                </div>
            </div>
        `).join('');
    }

    preview.style.display = 'block';
}

// 测试日期提取
async function testDateExtraction() {
    const testUrl = prompt('请输入要测试的文章URL:');
    if (!testUrl) return;

    try {
        const response = await fetch('/api/intelligence/test-date-extraction', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                url: testUrl,
                date_selectors: []
            })
        });

        const data = await response.json();

        if (data.status === 'success') {
            const result = data.extraction_result;
            if (result.success) {
                showAlert(`测试成功！提取到日期: ${result.date}\n方法: ${result.method}\n置信度: ${result.confidence}`, 'success');
            } else {
                showAlert(`测试失败: ${result.error_message}`, 'warning');
            }
        } else {
            showAlert('测试失败: ' + data.message, 'danger');
        }
    } catch (error) {
        showAlert('测试失败: ' + error.message, 'danger');
    }
}

// 开始批量日期提取
async function startDateExtraction() {
    const topic = document.getElementById('dateExtractionTopic').value;
    const limit = document.getElementById('dateExtractionLimit').value;

    if (!confirm(`确定要开始批量日期补全吗？\n将处理最多 ${limit} 条缺少日期的情报。`)) {
        return;
    }

    const startBtn = document.getElementById('startDateExtractionBtn');
    const progress = document.getElementById('dateExtractionProgress');
    const status = document.getElementById('dateExtractionStatus');

    startBtn.disabled = true;
    progress.style.display = 'block';
    status.textContent = '正在获取缺少日期的文章...';

    try {
        // 1. 先获取缺少日期的文章列表 - 使用正确的端点
        const params = new URLSearchParams();
        params.append('limit', limit);
        if (topic) params.append('topic', topic);

        const missingResponse = await fetch(`/api/intelligence/missing-dates?${params}`);
        const missingData = await missingResponse.json();

        if (missingData.status !== 'success' || !missingData.articles || !missingData.articles.length) {
            showAlert('没有找到需要处理的文章', 'warning');
            return;
        }

        const intelligenceIds = missingData.articles.map(article => article.id);
        status.textContent = `找到 ${intelligenceIds.length} 条文章，开始提取日期...`;

        // 2. 批量提取日期
        const extractResponse = await fetch('/api/intelligence/batch-extract-dates', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                intelligence_ids: intelligenceIds,
                date_selectors: []  // 可以添加自定义选择器
            })
        });

        const extractData = await extractResponse.json();

        if (extractData.status === 'success') {
            const successCount = extractData.success_count;
            const totalCount = extractData.total_processed;

            status.textContent = `处理完成：成功提取 ${successCount}/${totalCount} 条`;
            document.querySelector('#dateExtractionProgress .progress-bar').style.width = '100%';

            showAlert(`日期补全完成！\n成功提取: ${successCount} 条\n总处理: ${totalCount} 条`, 'success');

            // 刷新表格数据
            setTimeout(() => {
                loadTableData();
                const modal = bootstrap.Modal.getInstance(document.getElementById('dateExtractionModal'));
                modal.hide();
            }, 2000);

        } else {
            showAlert('批量日期提取失败: ' + extractData.message, 'danger');
        }

    } catch (error) {
        showAlert('批量日期提取失败: ' + error.message, 'danger');
    } finally {
        startBtn.disabled = false;
        setTimeout(() => {
            progress.style.display = 'none';
            document.querySelector('#dateExtractionProgress .progress-bar').style.width = '0%';
        }, 3000);
    }
}

// 为选中项批量提取日期
async function batchExtractDatesForSelected() {
    if (selectedIntelligenceIds.size === 0) {
        showAlert('请先选择要处理的情报', 'warning');
        return;
    }

    if (!confirm(`确定要为选中的 ${selectedIntelligenceIds.size} 条情报补全日期吗？`)) {
        return;
    }

    const ids = Array.from(selectedIntelligenceIds);
    showAlert(`正在为 ${ids.length} 条情报补全日期...`, 'info');

    try {
        const response = await fetch('/api/intelligence/batch-extract-dates', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                intelligence_ids: ids,
                date_selectors: []
            })
        });

        const data = await response.json();

        if (data.status === 'success') {
            showAlert(`日期补全完成！成功提取 ${data.success_count}/${data.total_processed} 条`, 'success');
            loadTableData();
            clearSelection();
        } else {
            showAlert('批量日期提取失败: ' + data.message, 'danger');
        }
    } catch (error) {
        showAlert('批量日期提取失败: ' + error.message, 'danger');
    }
}

// 确保函数在全局作用域
window.openDateExtractionModal = openDateExtractionModal;
window.previewMissingDates = previewMissingDates;
window.testDateExtraction = testDateExtraction;
window.startDateExtraction = startDateExtraction;
window.batchExtractDatesForSelected = batchExtractDatesForSelected;

// 初始化完成提示
console.log('情报管理系统JavaScript初始化完成');

</script>

{% endblock %}